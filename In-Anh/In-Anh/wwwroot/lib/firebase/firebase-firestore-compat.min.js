!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(yg,vg){"use strict";try{!function(){var c,n=(n=yg)&&"object"==typeof n&&"default"in n?n:{default:n};function s(n){var r=[];let i=0;for(let t=0;t<n.length;t++){let e=n.charCodeAt(t);e<128?r[i++]=e:(e<2048?r[i++]=e>>6|192:(55296==(64512&e)&&t+1<n.length&&56320==(64512&n.charCodeAt(t+1))?(e=65536+((1023&e)<<10)+(1023&n.charCodeAt(++t)),r[i++]=e>>18|240,r[i++]=e>>12&63|128):r[i++]=e>>12|224,r[i++]=e>>6&63|128),r[i++]=63&e|128)}return r}const a={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();var i=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let n=0;n<r.length;n+=3){var a=r[n],o=n+1<r.length,u=o?r[n+1]:0,h=n+2<r.length,l=h?r[n+2]:0;let e=(15&u)<<2|l>>6,t=63&l;h||(t=64,o)||(e=64),s.push(i[a>>2],i[(3&a)<<4|u>>4],i[e],i[t])}return s.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(s(e),t)},decodeString(n,r){if(this.HAS_NATIVE_SUPPORT&&!r)return atob(n);{var i=this.decodeStringToByteArray(n,r),s=[];let e=0,t=0;for(;e<i.length;){var a,o,u=i[e++];u<128?s[t++]=String.fromCharCode(u):191<u&&u<224?(a=i[e++],s[t++]=String.fromCharCode((31&u)<<6|63&a)):239<u&&u<365?(o=((7&u)<<18|(63&i[e++])<<12|(63&i[e++])<<6|63&i[e++])-65536,s[t++]=String.fromCharCode(55296+(o>>10)),s[t++]=String.fromCharCode(56320+(1023&o))):(a=i[e++],o=i[e++],s[t++]=String.fromCharCode((15&u)<<12|(63&a)<<6|63&o))}return s.join("")}},decodeStringToByteArray(t,e){this.init_();var n=e?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let e=0;e<t.length;){var i=n[t.charAt(e++)],s=e<t.length?n[t.charAt(e)]:0,a=++e<t.length?n[t.charAt(e)]:64,o=++e<t.length?n[t.charAt(e)]:64;if(++e,null==i||null==s||null==a||null==o)throw new u;r.push(i<<2|s>>4),64!==a&&(r.push(s<<4&240|a>>2),64!==o)&&r.push(a<<6&192|o)}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),(this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e)>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class u extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}function B(e){return e=s(e),a.encodeByteArray(e,!0).replace(/\./g,"")}const q=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,G=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return a.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}};function K(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function j(){return!function(){var e=null==(e=(()=>{try{return q()||("undefined"!=typeof process&&void 0!==process.env&&(e=process.env.__FIREBASE_DEFAULTS__)?JSON.parse(e):void 0)||G()}catch(e){console.info("Unable to get __FIREBASE_DEFAULTS__ due to: "+e)}var e})())?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class z extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,z.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,$.prototype.create)}}class ${constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,t=t[0]||{},n=this.service+"/"+e,e=(e=this.errors[e])?(r=t,e.replace(Q,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",e=this.serviceName+`: ${e} (${n}).`;return new z(n,e,t)}}const Q=/\{\$([^}]+)}/g;function v(e){return e&&e._delegate?e._delegate:e}class H{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(Lr=c=c||{})[Lr.DEBUG=0]="DEBUG",Lr[Lr.VERBOSE=1]="VERBOSE",Lr[Lr.INFO=2]="INFO",Lr[Lr.WARN=3]="WARN",Lr[Lr.ERROR=4]="ERROR",Lr[Lr.SILENT=5]="SILENT";const W={debug:c.DEBUG,verbose:c.VERBOSE,info:c.INFO,warn:c.WARN,error:c.ERROR,silent:c.SILENT},Y=c.INFO,X={[c.DEBUG]:"log",[c.VERBOSE]:"log",[c.INFO]:"info",[c.WARN]:"warn",[c.ERROR]:"error"},J=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),i=X[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)}};var Z="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},x=Z||self;function ee(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function te(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}Math.random();function ne(e,t,n){return e.call.apply(e.bind,arguments)}function re(t,n,e){var r;if(t)return 2<arguments.length?(r=Array.prototype.slice.call(arguments,2),function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}):function(){return t.apply(n,arguments)};throw Error()}function ie(e,t,n){return(ie=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ne:re).apply(null,arguments)}function se(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function e(e,s){function t(){}t.prototype=s.prototype,e.$=s.prototype,e.prototype=new t,(e.prototype.constructor=e).ac=function(e,t,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return s.prototype[t].apply(e,r)}}function ae(){this.s=this.s,this.o=this.o}ae.prototype.s=!1,ae.prototype.sa=function(){this.s||(this.s=!0,this.N())},ae.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const oe=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(t,n){if("string"==typeof t)return"string"!=typeof n||1!=n.length?-1:t.indexOf(n,0);for(let e=0;e<t.length;e++)if(e in t&&t[e]===n)return e;return-1};function ue(t){var n=t.length;if(0<n){var r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function he(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(ee(n)){var r=t.length||0,i=n.length||0;t.length=r+i;for(let e=0;e<i;e++)t[r+e]=n[e]}else t.push(n)}}function le(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}le.prototype.h=function(){this.defaultPrevented=!0};var ce=function(){if(!x.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{x.addEventListener("test",()=>{},t),x.removeEventListener("test",()=>{},t)}catch(e){}return e}();function de(e){return/^[\s\xa0]*$/.test(e)}function fe(){var e=x.navigator;return e&&e.userAgent||""}function ge(e){return-1!=fe().indexOf(e)}function me(e){return me[" "](e),e}me[" "]=function(){};var pe=ge("Opera"),ye=ge("Trident")||ge("MSIE"),t=ge("Edge"),ve=t||ye,we=ge("Gecko")&&!(-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge"))&&!(ge("Trident")||ge("MSIE"))&&!ge("Edge"),_e=-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge");function be(){var e=x.document;return e?e.documentMode:void 0}var Ie="",Ee=(Ee=fe(),we?/rv:([^\);]+)(\)|;)/.exec(Ee):t?/Edge\/([\d\.]+)/.exec(Ee):ye?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(Ee):_e?/WebKit\/(\S+)/.exec(Ee):pe?/(?:Version)[ \/]?(\S+)/.exec(Ee):void 0),Te=((Ee&&(Ie=Ee?Ee[1]:""),ye&&null!=(Ee=be())&&Ee>parseFloat(Ie))?fg=String(Ee):fg=Ie,x.document&&ye&&(be()||parseInt(fg,10))||void 0);function Se(e,t){if(le.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(we){e:{try{me(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:xe[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&Se.$.h.call(this)}}e(Se,le);var xe={2:"touch",3:"pen",4:"mouse"},De=(Se.prototype.h=function(){Se.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1},"closure_listenable_"+(1e6*Math.random()|0)),Ce=0;function Ae(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.la=i,this.key=++Ce,this.fa=this.ia=!1}function Ne(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function ke(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function Re(e){var t={};for(const n in e)t[n]=e[n];return t}const Me="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Le(t){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e])t[n]=r[n];for(let e=0;e<Me.length;e++)n=Me[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function Fe(e){this.src=e,this.g={},this.h=0}function Oe(e,t){var n,r,i,s=t.type;s in e.g&&(n=e.g[s],(i=0<=(r=oe(n,t)))&&Array.prototype.splice.call(n,r,1),i)&&(Ne(t),0==e.g[s].length)&&(delete e.g[s],e.h--)}function Pe(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.fa&&s.listener==t&&s.capture==!!n&&s.la==r)return i}return-1}Fe.prototype.add=function(e,t,n,r,i){var s=e.toString(),a=((e=this.g[s])||(e=this.g[s]=[],this.h++),Pe(e,t,r,i));return-1<a?(t=e[a],n||(t.ia=!1)):((t=new Ae(t,this.src,s,!!r,i)).ia=n,e.push(t)),t};var Ve="closure_lm_"+(1e6*Math.random()|0),Ue={};function Be(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var a=te(i)?!!i.capture:!!i,o=je(e);if(o||(e[Ve]=o=new Fe(e)),!(n=o.add(t,n,r,a,s)).proxy)if(r=function(){const n=Ke;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(i=ce?i:a)&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(Ge(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function qe(e){var t,n,r;"number"!=typeof e&&e&&!e.fa&&((t=e.src)&&t[De]?Oe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Ge(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=je(t))?(Oe(n,e),0==n.h&&(n.src=null,t[Ve]=null)):Ne(e)))}function Ge(e){return e in Ue?Ue[e]:Ue[e]="on"+e}function Ke(e,t){var n,r;return!!e.fa||(t=new Se(t,this),n=e.listener,r=e.la||e.src,e.ia&&qe(e),n.call(r,t))}function je(e){return(e=e[Ve])instanceof Fe?e:null}var ze="__closure_events_fn_"+(1e9*Math.random()>>>0);function $e(t){return"function"==typeof t?t:(t[ze]||(t[ze]=function(e){return t.handleEvent(e)}),t[ze])}function i(){ae.call(this),this.i=new Fe(this),(this.S=this).J=null}function Qe(e,t){var n,r=e.J;if(r)for(n=[];r;r=r.J)n.push(r);if(e=e.S,r=t.type||t,"string"==typeof t?t=new le(t,e):t instanceof le?t.target=t.target||e:(a=t,Le(t=new le(r,e),a)),a=!0,n)for(var i=n.length-1;0<=i;i--)var s=t.g=n[i],a=He(s,r,!0,t)&&a;if(a=He(s=t.g=e,r,!0,t)&&a,a=He(s,r,!1,t)&&a,n)for(i=0;i<n.length;i++)a=He(s=t.g=n[i],r,!1,t)&&a}function He(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var a,o,u=t[s];u&&!u.fa&&u.capture==n&&(a=u.listener,o=u.la||u.src,u.ia&&Oe(e.i,u),i=!1!==a.call(o,r)&&i)}return i&&!r.defaultPrevented}e(i,ae),i.prototype[De]=!0,i.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,s){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);else i=te(i)?!!i.capture:!!i,r=$e(r),t&&t[De]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=Pe(a=t.g[n],r,i,s))&&(Ne(a[r]),Array.prototype.splice.call(a,r,1),0==a.length)&&(delete t.g[n],t.h--)):(t=t&&je(t))&&(n=t.g[n.toString()],r=(t=-1)<(t=n?Pe(n,r,i,s):t)?n[t]:null)&&qe(r)}(this,e,t,n,r)},i.prototype.N=function(){if(i.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)Ne(n[r]);delete t.g[e],t.h--}}this.J=null},i.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},i.prototype.P=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var We=x.JSON.stringify,Ye=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Xe,e=>e.reset());class Xe{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let Je,Ze=!1,et=new class{constructor(){this.h=this.g=null}add(e,t){var n=Ye.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},tt=()=>{const e=x.Promise.resolve(void 0);Je=()=>{e.then(nt)}};var nt=()=>{for(var e;e=function(){var e=et;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){x.setTimeout(()=>{throw e},0)}(e)}var t=Ye;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Ze=!1};function rt(e,t){i.call(this),this.h=e||1,this.g=t||x,this.j=ie(this.qb,this),this.l=Date.now()}function it(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function st(e,t,n){if("function"==typeof e)n&&(e=ie(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=ie(e.handleEvent,e)}return 2147483647<Number(t)?-1:x.setTimeout(e,t||0)}e(rt,i),(t=rt.prototype).ga=!1,t.T=null,t.qb=function(){var e;this.ga&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),Qe(this,"tick"),this.ga&&(it(this),this.start())))},t.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},t.N=function(){rt.$.N.call(this),it(this),delete this.g};class at extends ae{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=st(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(x.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ot(e){ae.call(this),this.h=e,this.g={}}e(ot,ae);var ut=[];function ht(e,t,n,r){Array.isArray(n)||(n&&(ut[0]=n.toString()),n=ut);for(var i=0;i<n.length;i++){var s=function e(t,n,r,i,s){if(i&&i.once)return function e(t,n,r,i,s){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}return r=$e(r),t&&t[De]?t.P(n,r,te(i)?!!i.capture:!!i,s):Be(t,n,r,!0,i,s)}(t,n,r,i,s);if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}return r=$e(r),t&&t[De]?t.O(n,r,te(i)?!!i.capture:!!i,s):Be(t,n,r,!1,i,s)}(t,n[i],r||e.handleEvent,!1,e.h||e);if(!s)break;e.g[s.key]=s}}function lt(e){ke(e.g,function(e,t){this.g.hasOwnProperty(t)&&qe(e)},e),e.g={}}function ct(){this.g=!0}function dt(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var i=r[1];if(Array.isArray(i)&&!(i.length<1)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<i.length;a++)i[a]=""}}}return We(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}ot.prototype.N=function(){ot.$.N.call(this),lt(this)},ot.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ct.prototype.Ea=function(){this.g=!1},ct.prototype.info=function(){};var ft={},gt=null;function mt(){return gt=gt||new i}function pt(e){le.call(this,ft.Ta,e)}function yt(){var e=mt();Qe(e,new pt(e))}function vt(e,t){le.call(this,ft.STAT_EVENT,e),this.stat=t}function wt(e){var t=mt();Qe(t,new vt(t,e))}function _t(e,t){le.call(this,ft.Ua,e),this.size=t}function bt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return x.setTimeout(function(){e()},t)}ft.Ta="serverreachability",e(pt,le),ft.STAT_EVENT="statevent",e(vt,le),ft.Ua="timingevent",e(_t,le);_e={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},pe={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function It(){}function Et(e){return e.h||(e.h=e.i())}function Tt(){}function St(){le.call(this,"d")}function xt(){le.call(this,"c")}function Dt(){}function Ct(e,t,n,r){this.l=e,this.j=t,this.m=n,this.W=r||1,this.U=new ot(this),this.P=kt,this.V=new rt(e=ve?125:void 0),this.I=null,this.i=!1,this.s=this.A=this.v=this.L=this.G=this.Y=this.B=null,this.F=[],this.g=null,this.C=0,this.o=this.u=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new At}function At(){this.i=null,this.g="",this.h=!1}It.prototype.h=null,Z={OPEN:"a",vb:"b",Ra:"c",Hb:"d"},e(St,le),e(xt,le),e(Dt,It),Dt.prototype.g=function(){return new XMLHttpRequest},Dt.prototype.i=function(){return{}};var Nt=new Dt,kt=45e3,Rt={},Mt={};function Lt(e,t,n){e.L=1,e.v=Xt(Qt(t)),e.s=n,e.S=!0,Ft(e,null)}function Ft(e,t){e.G=Date.now(),Vt(e),e.A=Qt(e.v);var a,o,u,h,l,c,n=e.A,r=e.W;Array.isArray(r)||(r=[String(r)]),cn(n.i,"t",r),e.C=0,n=e.l.J,e.h=new At,e.g=hr(e.l,n?t:null,!e.s),0<e.O&&(e.M=new at(ie(e.Pa,e,e.g),e.O)),ht(e.U,e.g,"readystatechange",e.nb),t=e.I?Re(e.I):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.A,e.u,e.s,t)):(e.u="GET",e.g.ha(e.A,e.u,null,t)),yt(),a=e.j,o=e.u,u=e.A,h=e.m,l=e.W,c=e.s,a.info(function(){if(a.g)if(c)for(var e="",t=c.split("&"),n=0;n<t.length;n++){var r,i,s=t[n].split("=");1<s.length&&(r=s[0],s=s[1],e=2<=(i=r.split("_")).length&&"type"==i[1]?e+(r+"=")+s+"&":e+(r+"=redacted&"))}else e=null;else e=c;return"XMLHTTP REQ ("+h+") [attempt "+l+"]: "+o+"\n"+u+"\n"+e})}function Ot(e){return e.g&&"GET"==e.u&&2!=e.L&&e.l.Ha}function Pt(e,t,n){let r=!0,i;for(;!e.J&&e.C<n.length;){if((i=(0,o=(s=e).C,-1==(u=(a=n).indexOf("\n",o))?Mt:(o=Number(a.substring(o,u)),isNaN(o)?Rt:(u+=1)+o>a.length?Mt:(a=a.slice(u,u+o),s.C=u+o,a))))==Mt){4==t&&(e.o=4,wt(14),r=!1),dt(e.j,e.m,null,"[Incomplete Response]");break}if(i==Rt){e.o=4,wt(15),dt(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}dt(e.j,e.m,i,null),Kt(e,i)}var s,a,o,u;Ot(e)&&i!=Mt&&i!=Rt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,wt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e)&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),tr(t),t.M=!0,wt(11)):(dt(e.j,e.m,n,"[Invalid Chunked Response]"),Gt(e),qt(e))}function Vt(e){e.Y=Date.now()+e.P,Ut(e,e.P)}function Ut(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=bt(ie(e.lb,e),t)}function Bt(e){e.B&&(x.clearTimeout(e.B),e.B=null)}function qt(e){0==e.l.H||e.J||ir(e.l,e)}function Gt(e){Bt(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,it(e.V),lt(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function Kt(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||yn(n.i,e)))if(!e.K&&yn(n.i,e)&&3==n.H){try{var r=n.Ja.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;rr(n),Qn(n)}er(n),wt(18)}}else n.Fa=i[1],0<n.Fa-n.V&&i[2]<37500&&n.G&&0==n.A&&!n.v&&(n.v=bt(ie(n.ib,n),6e3));if(pn(n.i)<=1&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else ar(n,11)}else if(!e.K&&n.g!=e||rr(n),!de(t))for(i=n.Ja.g.parse(t),t=0;t<i.length;t++){var s,a,o,u,h,l,c,d,f,g,m=i[t];n.V=m[0],m=m[1],2==n.H?"c"==m[0]?(n.K=m[1],n.pa=m[2],null!=(s=m[3])&&(n.ra=s,n.l.info("VER="+n.ra)),null!=(a=m[4])&&(n.Ga=a,n.l.info("SVER="+n.Ga)),null!=(h=m[5])&&"number"==typeof h&&0<h&&(r=1.5*h,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n,(l=e.g)&&(!(c=l.g?l.g.getResponseHeader("X-Client-Wire-Protocol"):null)||(o=r.i).g||-1==c.indexOf("spdy")&&-1==c.indexOf("quic")&&-1==c.indexOf("h2")||(o.j=o.l,o.g=new Set,o.h&&(vn(o,o.h),o.h=null)),r.F)&&(u=l.g?l.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.Da=u,p(r.I,r.F,u)),n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms")),g=e,(r=n).wa=ur(r,r.J?r.pa:null,r.Y),g.K?(wn(r.i,g),d=g,(f=r.L)&&d.setTimeout(f),d.B&&(Bt(d),Vt(d)),r.g=g):Zn(r),0<n.j.length&&Wn(n)):"stop"!=m[0]&&"close"!=m[0]||ar(n,7):3==n.H&&("stop"==m[0]||"close"==m[0]?"stop"==m[0]?ar(n,7):$n(n):"noop"!=m[0]&&n.h&&n.h.Aa(m),n.A=0)}yt()}catch(e){}}function jt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(ee(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(ee(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n)}else{t=[],n=0;for(const r in e)t[n++]=r}return t}}}(e),r=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(ee(e))for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);else for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],n&&n[s],e)}(t=Ct.prototype).setTimeout=function(e){this.P=e},t.nb=function(e){e=e.target;var t=this.M;t&&3==Bn(e)?t.l():this.Pa(e)},t.Pa=function(e){try{if(e==this.g)e:{var t=Bn(this.g),n=this.g.Ia();if(this.g.da(),!(t<3)&&(3!=t||ve||this.g&&(this.h.h||this.g.ja()||qn(this.g)))){this.J||4!=t||7==n||yt(),Bt(this);var r=this.g.da();this.ca=r;t:if(Ot(this)){var i=qn(this.g),s=(e="",i.length),a=4==Bn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Gt(this),qt(this);var o="";break t}this.h.i=new x.TextDecoder}for(n=0;n<s;n++)this.h.h=!0,e+=this.h.i.decode(i[n],{stream:a&&n==s-1});i.splice(0,s),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.ja();if(this.i=200==r,v=this.j,w=this.u,_=this.A,b=this.m,I=this.W,E=t,T=r,v.info(function(){return"XMLHTTP RESP ("+b+") [ attempt "+I+"]: "+w+"\n"+_+"\n"+E+" "+T}),this.i){if(this.aa&&!this.K){t:{if(this.g){var u,h=this.g;if((u=h.g?h.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!de(u)){var l=u;break t}}l=null}if(!(r=l)){this.i=!1,this.o=3,wt(12),Gt(this),qt(this);break e}dt(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Kt(this,r)}this.S?(Pt(this,t,o),ve&&this.i&&3==t&&(ht(this.U,this.V,"tick",this.mb),this.V.start())):(dt(this.j,this.m,o,null),Kt(this,o)),4==t&&Gt(this),this.i&&!this.J&&(4==t?ir(this.l,this):(this.i=!1,Vt(this)))}else{{var c=this.g;var d,f,g,m={};c=(c.g&&2<=Bn(c)&&c.g.getAllResponseHeaders()||"").split("\r\n");for(let e=0;e<c.length;e++)de(c[e])||(d=(f=function(e){for(var t=1,n=(e=e.split(":"),[]);0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(c[e]))[0],"string"==typeof(f=f[1])&&(f=f.trim(),g=m[d]||[],(m[d]=g).push(f)));function p(e){return e.join(", ")}var y=m;for(const S in y)p.call(void 0,y[S],S,y)}400==r&&0<o.indexOf("Unknown SID")?(this.o=3,wt(12)):(this.o=0,wt(13)),Gt(this),qt(this)}}}}catch(e){}var v,w,_,b,I,E,T},t.mb=function(){var e,t;this.g&&(e=Bn(this.g),t=this.g.ja(),this.C<t.length)&&(Bt(this),Pt(this,e,t),this.i)&&4!=e&&Vt(this)},t.cancel=function(){this.J=!0,Gt(this)},t.lb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.L&&(yt(),wt(17)),Gt(this),this.o=2,qt(this)):Ut(this,this.Y-n)};var zt=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function $t(e){var t,n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof $t?(this.h=e.h,Ht(this,e.j),this.s=e.s,this.g=e.g,Wt(this,e.m),this.l=e.l,t=e.i,(n=new on).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Yt(this,n),this.o=e.o):e&&(t=String(e).match(zt))?(this.h=!1,Ht(this,t[1]||"",!0),this.s=Jt(t[2]||""),this.g=Jt(t[3]||"",!0),Wt(this,t[4]),this.l=Jt(t[5]||"",!0),Yt(this,t[6]||"",!0),this.o=Jt(t[7]||"")):(this.h=!1,this.i=new on(null,this.h))}function Qt(e){return new $t(e)}function Ht(e,t,n){e.j=n?Jt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Wt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Yt(e,t,n){var r,i;t instanceof on?(e.i=t,r=e.i,(i=e.h)&&!r.j&&(un(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(hn(this,t),cn(this,n,e))},r)),r.j=i):(n||(t=Zt(t,sn)),e.i=new on(t,e.h))}function p(e,t,n){e.i.set(t,n)}function Xt(e){return p(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Jt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Zt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,en),n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function en(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}$t.prototype.toString=function(){var e=[],t=this.j,n=(t&&e.push(Zt(t,tn,!0),":"),this.g);return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Zt(t,tn,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Zt(n,"/"==n.charAt(0)?rn:nn,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Zt(n,an)),e.join("")};var tn=/[#\/\?@]/g,nn=/[#\?:]/g,rn=/[#\?]/g,sn=/[#\?@]/g,an=/#/g;function on(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function un(e){if(!e.g&&(e.g=new Map,e.h=0,e.i)){var t=e.i;if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,i=t[n].indexOf("="),s=null;0<=i?(r=t[n].substring(0,i),s=t[n].substring(i+1)):r=t[n],i=r,s=s?decodeURIComponent(s.replace(/\+/g," ")):"",e.add(decodeURIComponent(i.replace(/\+/g," ")),s)}}}}function hn(e,t){un(e),t=dn(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function ln(e,t){return un(e),t=dn(e,t),e.g.has(t)}function cn(e,t,n){hn(e,t),0<n.length&&(e.i=null,e.g.set(dn(e,t),ue(n)),e.h+=n.length)}function dn(e,t){return t=String(t),e.j?t.toLowerCase():t}(t=on.prototype).add=function(e,t){un(this),this.i=null,e=dn(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},t.forEach=function(n,r){un(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},t.ta=function(){un(this);var e=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let t=0;t<n.length;t++){var i=e[t];for(let e=0;e<i.length;e++)r.push(n[t])}return r},t.Z=function(t){un(this);let n=[];if("string"==typeof t)ln(this,t)&&(n=n.concat(this.g.get(dn(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},t.set=function(e,t){return un(this),this.i=null,ln(this,e=dn(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},t.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},t.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var e=[],t=Array.from(this.g.keys()),n=0;n<t.length;n++)for(var r=t[n],i=encodeURIComponent(String(r)),s=this.Z(r),r=0;r<s.length;r++){var a=i;""!==s[r]&&(a+="="+encodeURIComponent(String(s[r]))),e.push(a)}return this.i=e.join("&")};var fn=class{constructor(e,t){this.g=e,this.map=t}};function gn(e){this.l=e||10,e=x.PerformanceNavigationTiming?0<(e=x.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(x.g&&x.g.Ka&&x.g.Ka()&&x.g.Ka().ec),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function mn(e){return e.h||e.g&&e.g.size>=e.j}function pn(e){return e.h?1:e.g?e.g.size:0}function yn(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function vn(e,t){e.g?e.g.add(t):e.h=t}function wn(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function _n(t){if(null!=t.h)return t.i.concat(t.h.F);if(null==t.g||0===t.g.size)return ue(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}}gn.prototype.cancel=function(){if(this.i=_n(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var bn,In=class{stringify(e){return x.JSON.stringify(e,void 0)}parse(e){return x.JSON.parse(e,void 0)}};function En(){this.g=new In}function Tn(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}function Sn(e){this.l=e.fc||null,this.j=e.ob||!1}function xn(e,t){i.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=Dn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}e(Sn,It),Sn.prototype.g=function(){return new xn(this.l,this.j)},Sn.prototype.i=(bn={},function(){return bn}),e(xn,i);var Dn=0;function Cn(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function An(e){e.readyState=4,e.l=null,e.j=null,e.A=null,Nn(e)}function Nn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(t=xn.prototype).open=function(e,t){if(this.readyState!=Dn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,Nn(this)},t.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;var t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||x).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},t.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,An(this)),this.readyState=Dn},t.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,Nn(this)),this.g)&&(this.readyState=3,Nn(this),this.g))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==x.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Cn(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},t.Xa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):!this.u&&(t=e.value||new Uint8Array(0),t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t),(e.done?An:Nn)(this),3==this.readyState)&&Cn(this)},t.Za=function(e){this.g&&(this.response=this.responseText=e,An(this))},t.Ya=function(e){this.g&&(this.response=e,An(this))},t.ka=function(){this.g&&An(this)},t.setRequestHeader=function(e,t){this.v.append(e,t)},t.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},t.getAllResponseHeaders=function(){if(!this.h)return"";for(var e=[],t=this.h.entries(),n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(xn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var kn=x.JSON.parse;function r(e){i.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=Rn,this.L=this.M=!1}e(r,i);var Rn="",Mn=/^https?$/i,Ln=["POST","PUT"];function Fn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,On(e),Vn(e)}function On(e){e.F||(e.F=!0,Qe(e,"complete"),Qe(e,"error"))}function Pn(e){if(e.h&&(!e.C[1]||4!=Bn(e)||2!=e.da()))if(e.v&&4==Bn(e))st(e.La,0,e);else if(Qe(e,"readystatechange"),4==Bn(e)){e.h=!1;try{var t,n,r,i=e.da();switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var s=!0;break;default:s=!1}if((t=s)||((n=0===i)&&(!(r=String(e.I).match(zt)[1]||null)&&x.self&&x.self.location&&(r=x.self.location.protocol.slice(0,-1)),n=!Mn.test(r?r.toLowerCase():"")),t=n),t)Qe(e,"complete"),Qe(e,"success");else{e.m=6;try{var a=2<Bn(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.da()+"]",On(e)}}finally{Vn(e)}}}function Vn(e,t){if(e.g){Un(e);var n=e.g,r=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||Qe(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Un(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(x.clearTimeout(e.A),e.A=null)}function Bn(e){return e.g?e.g.readyState:0}function qn(e){try{if(e.g){if("response"in e.g)return e.g.response;switch(e.K){case Rn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}}return null}catch(e){return null}}function Gn(e){let n="";return ke(e,function(e,t){n=(n=n+t+":")+e+"\r\n"}),n}function Kn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=Gn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):p(e,t,n))}function jn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function zn(e){this.Ga=0,this.j=[],this.l=new ct,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=jn("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=jn("baseRetryDelayMs",5e3,e),this.hb=jn("retryDelaySeedMs",1e4,e),this.eb=jn("forwardChannelMaxRetries",2,e),this.xa=jn("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.dc||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new gn(e&&e.concurrentRequestLimit),this.Ja=new En,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function $n(e){if(Hn(e),3==e.H){var t=e.W++,n=Qt(e.I);if(p(n,"SID",e.K),p(n,"RID",t),p(n,"TYPE","terminate"),Xn(e,n),(t=new Ct(e,e.l,t)).L=2,t.v=Xt(Qt(n)),n=!1,x.navigator&&x.navigator.sendBeacon)try{n=x.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&x.Image&&((new Image).src=t.v,n=!0),n||(t.g=hr(t.l,null),t.g.ha(t.v)),t.G=Date.now(),Vt(t)}or(e)}function Qn(e){e.g&&(tr(e),e.g.cancel(),e.g=null)}function Hn(e){Qn(e),e.u&&(x.clearTimeout(e.u),e.u=null),rr(e),e.i.cancel(),e.m&&("number"==typeof e.m&&x.clearTimeout(e.m),e.m=null)}function Wn(e){var t;mn(e.i)||e.m||(e.m=!0,t=e.Na,Je||tt(),Ze||(Je(),Ze=!0),et.add(t,e),e.C=0)}function Yn(e,t){var n=t?t.m:e.W++,r=Qt(e.I);p(r,"SID",e.K),p(r,"RID",n),p(r,"AID",e.V),Xn(e,r),e.o&&e.s&&Kn(r,e.o,e.s),n=new Ct(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=Jn(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),vn(e.i,n),Lt(n,r,t)}function Xn(e,n){e.na&&ke(e.na,function(e,t){p(n,t,e)}),e.h&&jt({},function(e,t){p(n,t,e)})}function Jn(r,e,i){i=Math.min(r.j.length,i);var s=r.h?ie(r.h.Va,r.h,r):null;e:{var a=r.j;let n=-1;for(;;){var o=["count="+i];-1==n?0<i?(n=a[0].g,o.push("ofs="+n)):n=0:o.push("ofs="+n);let t=!0;for(let e=0;e<i;e++){var u=a[e].g,h=a[e].map;if((u-=n)<0)n=Math.max(0,a[e].g-100),t=!1;else try{!function(e,r){const i="req"+u+"_"||"";try{jt(e,function(e,t){let n=e;te(e)&&(n=We(e)),r.push(i+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(i+"type="+encodeURIComponent("_badmap")),e}}(h,o)}catch(r){s&&s(h)}}if(t){s=o.join("&");break e}}}return r=r.j.splice(0,i),e.F=r,s}function Zn(e){var t;e.g||e.u||(e.ba=1,t=e.Ma,Je||tt(),Ze||(Je(),Ze=!0),et.add(t,e),e.A=0)}function er(e){return!(e.g||e.u||3<=e.A)&&(e.ba++,e.u=bt(ie(e.Ma,e),sr(e,e.A)),e.A++,1)}function tr(e){null!=e.B&&(x.clearTimeout(e.B),e.B=null)}function nr(e){e.g=new Ct(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=Qt(e.wa),n=(p(t,"RID","rpc"),p(t,"SID",e.K),p(t,"AID",e.V),p(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&p(t,"TO",e.qa),p(t,"TYPE","xmlhttp"),Xn(e,t),e.o&&e.s&&Kn(t,e.o,e.s),e.L&&e.g.setTimeout(e.L),e.g);e=e.pa,n.L=1,n.v=Xt(Qt(t)),n.s=null,n.S=!0,Ft(n,e)}function rr(e){null!=e.v&&(x.clearTimeout(e.v),e.v=null)}function ir(e,t){var n,r,i,s=null;if(e.g==t){rr(e),tr(e),e.g=null;var a=2}else{if(!yn(e.i,t))return;s=t.F,wn(e.i,t),a=1}if(0!=e.H)if(t.i)(1==a?(s=t.s?t.s.length:0,t=Date.now()-t.G,n=e.C,Qe(a=mt(),new _t(a,s)),Wn):Zn)(e);else if(3==(n=t.o)||0==n&&0<t.ca||(1!=a||(i=t,pn((r=e).i)>=r.i.j-(r.m?1:0))||(r.m?(r.j=i.F.concat(r.j),0):1==r.H||2==r.H||r.C>=(r.cb?0:r.eb)||(r.m=bt(ie(r.Na,r,i),sr(r,r.C)),r.C++,0)))&&(2!=a||!er(e)))switch(s&&0<s.length&&(t=e.i,t.i=t.i.concat(s)),n){case 1:ar(e,5);break;case 4:ar(e,10);break;case 3:ar(e,6);break;default:ar(e,2)}}function sr(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function ar(e,t){if(e.l.info("Error code "+t),2==t){n=null,e.h&&(n=null),r=ie(e.pb,e),n||(n=new $t("//www.google.com/images/cleardot.gif"),x.location&&"http"==x.location.protocol||Ht(n,"https"),Xt(n));var n=n.toString(),r,i=new ct;if(x.Image){const s=new Image;s.onload=se(Tn,i,s,"TestLoadImage: loaded",!0,r),s.onerror=se(Tn,i,s,"TestLoadImage: error",!1,r),s.onabort=se(Tn,i,s,"TestLoadImage: abort",!1,r),s.ontimeout=se(Tn,i,s,"TestLoadImage: timeout",!1,r),x.setTimeout(function(){s.ontimeout&&s.ontimeout()},1e4),s.src=n}else r(!1)}else wt(2);e.H=0,e.h&&e.h.za(t),or(e),Hn(e)}function or(e){var t;e.H=0,e.ma=[],e.h&&(0==(t=_n(e.i)).length&&0==e.j.length||(he(e.ma,t),he(e.ma,e.j),e.i.i.length=0,ue(e.j),e.j.length=0),e.h.ya())}function ur(e,t,n){var r,i,s=n instanceof $t?Qt(n):new $t(n);return""!=s.g?(t&&(s.g=t+"."+s.g),Wt(s,s.m)):(s=(r=x.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,i=new $t(null),s&&Ht(i,s),t&&(i.g=t),r&&Wt(i,r),n&&(i.l=n),s=i),n=e.F,t=e.Da,n&&t&&p(s,n,t),p(s,"VER",e.ra),Xn(e,s),s}function hr(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ha&&!e.va?new r(new Sn({ob:!0})):new r(e.va)).Oa(e.J),t}function lr(){}function cr(){if(ye&&!(10<=Number(Te)))throw Error("Environmental error: no available transport.")}function dr(e,t){i.call(this),this.g=new zn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!de(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!de(t)&&(this.g.F=t,null!==(e=this.h))&&t in e&&t in(e=this.h)&&delete e[t],this.j=new mr(this)}function fr(e){St.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function gr(){xt.call(this),this.status=1}function mr(e){this.g=e}function pr(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function yr(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var i=0;i<16;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;i<16;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1];var i=e.g[2],s=e.g[3],a=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+((a=t+(s^n&(i^s))+r[0]+3614090360&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((s=(t=n+((a=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((i=s+((a=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function h(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}(t=r.prototype).Oa=function(e){this.M=e},t.ha=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=(this.u||Nt).g(),this.C=this.u?Et(this.u):Et(Nt),this.g.onreadystatechange=ie(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void Fn(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),i=x.FormData&&e instanceof x.FormData,0<=oe(Ln,t)&&!r&&!i&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[s,a]of n)this.g.setRequestHeader(s,a);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{Un(this),0<this.B&&((this.L=(o=this.g,ye&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=ie(this.ua,this)):this.A=st(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){Fn(this,e)}var o},t.ua=function(){this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Qe(this,"timeout"),this.abort(8))},t.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Qe(this,"complete"),Qe(this,"abort"),Vn(this))},t.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Vn(this,!0)),r.$.N.call(this)},t.La=function(){this.s||(this.G||this.v||this.l?Pn(this):this.kb())},t.kb=function(){Pn(this)},t.isActive=function(){return!!this.g},t.da=function(){try{return 2<Bn(this)?this.g.status:-1}catch(e){return-1}},t.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},t.Wa=function(e){var t;if(this.g)return t=this.g.responseText,e&&0==t.indexOf(e)&&(t=t.substring(e.length)),kn(t)},t.Ia=function(){return this.m},t.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(t=zn.prototype).ra=8,t.H=1,t.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;var n=new Ct(this,this.l,t);let e=this.s;if(this.U&&(e?Le(e=Re(e),this.U):e=this.U),null!==this.o||this.O||(n.I=e,e=null),this.P)e:{for(var r=0,i=0;i<this.j.length;i++){var s=this.j[i];if(void 0===(s="__data__"in s.map&&"string"==typeof(s=s.map.__data__)?s.length:void 0))break;if(4096<(r+=s)){r=i;break e}if(4096===r||i===this.j.length-1){r=i+1;break e}}r=1e3}else r=1e3;r=Jn(this,n,r),p(i=Qt(this.I),"RID",t),p(i,"CVER",22),this.F&&p(i,"X-HTTP-Session-Id",this.F),Xn(this,i),e&&(this.O?r="headers="+encodeURIComponent(String(Gn(e)))+"&"+r:this.o&&Kn(i,this.o,e)),vn(this.i,n),this.bb&&p(i,"TYPE","init"),this.P?(p(i,"$req",r),p(i,"SID","null"),n.aa=!0,Lt(n,i,null)):Lt(n,i,r),this.H=2}}else 3==this.H&&(t?Yn(this,t):0==this.j.length||mn(this.i)||Yn(this))},t.Ma=function(){var e;this.u=null,nr(this),this.ca&&!(this.M||null==this.g||this.S<=0)&&(e=2*this.S,this.l.info("BP detection timer enabled: "+e),this.B=bt(ie(this.jb,this),e))},t.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,wt(10),Qn(this),nr(this))},t.ib=function(){null!=this.v&&(this.v=null,Qn(this),er(this),wt(19))},t.pb=function(e){e?(this.l.info("Successfully pinged google.com"),wt(2)):(this.l.info("Failed to ping google.com"),wt(1))},t.isActive=function(){return!!this.h&&this.h.isActive(this)},(t=lr.prototype).Ba=function(){},t.Aa=function(){},t.za=function(){},t.ya=function(){},t.isActive=function(){return!0},t.Va=function(){},cr.prototype.g=function(e,t){return new dr(e,t)},e(dr,i),dr.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;wt(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=ur(e,null,e.Y),Wn(e)},dr.prototype.close=function(){$n(this.g)},dr.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=We(e),e=t),n.j.push(new fn(n.fb++,e)),3==n.H&&Wn(n)},dr.prototype.N=function(){this.g.h=null,delete this.j,$n(this.g),delete this.g,dr.$.N.call(this)},e(fr,St),e(gr,xt),e(mr,lr),mr.prototype.Ba=function(){Qe(this.g,"a")},mr.prototype.Aa=function(e){Qe(this.g,new fr(e))},mr.prototype.za=function(e){Qe(this.g,new gr)},mr.prototype.ya=function(){Qe(this.g,"b")},e(pr,function(){this.blockSize=-1}),pr.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},pr.prototype.j=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.m,i=this.h,s=0;s<t;){if(0==i)for(;s<=n;)yr(this,e,s),s+=this.blockSize;if("string"==typeof e){for(;s<t;)if(r[i++]=e.charCodeAt(s++),i==this.blockSize){yr(this,r),i=0;break}}else for(;s<t;)if(r[i++]=e[s++],i==this.blockSize){yr(this,r),i=0;break}}this.h=i,this.i+=t},pr.prototype.l=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;for(var n=8*this.i,t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var vr={};function wr(e){return-128<=e&&e<128?(t=e,n=function(e){return new h([0|e],e<0?-1:0)},r=vr,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new h([0|e],e<0?-1:0);var t,n,r}function _r(e){if(isNaN(e)||!isFinite(e))return Ir;if(e<0)return Dr(_r(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=br;return new h(t,0)}var br=4294967296,Ir=wr(0),Er=wr(1),Tr=wr(16777216);function Sr(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function xr(e){return-1==e.h}function Dr(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new h(n,~e.h).add(Er)}function Cr(e,t){return e.add(Dr(t))}function Ar(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function Nr(e,t){this.g=e,this.h=t}function kr(e,t){if(Sr(t))throw Error("division by zero");if(Sr(e))return new Nr(Ir,Ir);if(xr(e))return t=kr(Dr(e),t),new Nr(Dr(t.g),Dr(t.h));if(xr(t))return t=kr(e,Dr(t)),new Nr(Dr(t.g),t.h);if(30<e.g.length){if(xr(e)||xr(t))throw Error("slowDivide_ only works with positive integers.");for(var n=Er,r=t;r.X(e)<=0;)n=Rr(n),r=Rr(r);for(var i=Mr(n,1),s=Mr(r,1),r=Mr(r,2),n=Mr(n,2);!Sr(r);){var a=s.add(r);a.X(e)<=0&&(i=i.add(n),s=a),r=Mr(r,1),n=Mr(n,1)}return t=Cr(e,i.R(t)),new Nr(i,t)}for(i=Ir;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),a=(s=_r(n)).R(t);xr(a)||0<a.X(e);)a=(s=_r(n-=r)).R(t);Sr(s)&&(s=Er),i=i.add(s),e=Cr(e,a)}return new Nr(i,e)}function Rr(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.D(r)<<1|e.D(r-1)>>>31;return new h(n,e.h)}function Mr(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,i=[],s=0;s<r;s++)i[s]=0<t?e.D(s+n)>>>t|e.D(s+n+1)<<32-t:e.D(s+n);return new h(i,e.h)}(t=h.prototype).ea=function(){if(xr(this))return-Dr(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.D(n);e+=(0<=r?r:br+r)*t,t*=br}return e},t.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(Sr(this))return"0";if(xr(this))return"-"+Dr(this).toString(e);for(var t=_r(Math.pow(e,6)),n=this,r="";;){var i=kr(n,t).g,s=((0<(n=Cr(n,i.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(Sr(n=i))return s+r;for(;s.length<6;)s="0"+s;r=s+r}},t.D=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},t.X=function(e){return xr(e=Cr(this,e))?-1:Sr(e)?0:1},t.abs=function(){return xr(this)?Dr(this):this},t.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,i=0;i<=t;i++){var s=r+(65535&this.D(i))+(65535&e.D(i)),a=(s>>>16)+(this.D(i)>>>16)+(e.D(i)>>>16),r=a>>>16;n[i]=(a&=65535)<<16|(s&=65535)}return new h(n,-2147483648&n[n.length-1]?-1:0)},t.R=function(e){if(Sr(this)||Sr(e))return Ir;if(xr(this))return xr(e)?Dr(this).R(Dr(e)):Dr(Dr(this).R(e));if(xr(e))return Dr(this.R(Dr(e)));if(this.X(Tr)<0&&e.X(Tr)<0)return _r(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<e.g.length;i++){var s=this.D(r)>>>16,a=65535&this.D(r),o=e.D(i)>>>16,u=65535&e.D(i);n[2*r+2*i]+=a*u,Ar(n,2*r+2*i),n[2*r+2*i+1]+=s*u,Ar(n,2*r+2*i+1),n[2*r+2*i+1]+=a*o,Ar(n,2*r+2*i+1),n[2*r+2*i+2]+=s*o,Ar(n,2*r+2*i+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new h(n,0)},t.gb=function(e){return kr(this,e).h},t.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)&e.D(r);return new h(n,this.h&e.h)},t.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)|e.D(r);return new h(n,this.h|e.h)},t.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)^e.D(r);return new h(n,this.h^e.h)},cr.prototype.createWebChannel=cr.prototype.g,dr.prototype.send=dr.prototype.u,dr.prototype.open=dr.prototype.m,_e.NO_ERROR=0,_e.TIMEOUT=8,_e.HTTP_ERROR=6,pe.COMPLETE="complete",(Tt.EventType=Z).OPEN="a",Z.CLOSE="b",Z.ERROR="c",Z.MESSAGE="d",i.prototype.listen=i.prototype.O,r.prototype.listenOnce=r.prototype.P,r.prototype.getLastError=r.prototype.Sa,r.prototype.getLastErrorCode=r.prototype.Ia,r.prototype.getStatus=r.prototype.da,r.prototype.getResponseJson=r.prototype.Wa,r.prototype.getResponseText=r.prototype.ja,r.prototype.send=r.prototype.ha,r.prototype.setWithCredentials=r.prototype.Oa,pr.prototype.digest=pr.prototype.l,pr.prototype.update=pr.prototype.j,h.prototype.multiply=h.prototype.R,h.prototype.modulo=h.prototype.gb,h.prototype.compare=h.prototype.X,h.prototype.toNumber=h.prototype.ea,h.prototype.getBits=h.prototype.D,h.fromNumber=_r,h.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return Dr(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=_r(Math.pow(n,8)),i=Ir,s=0;s<t.length;s+=8)var a=Math.min(8,t.length-s),o=parseInt(t.substring(s,s+a),n),i=(a<8?(a=_r(Math.pow(n,a)),i.R(a)):i=i.R(r)).add(_r(o));return i};var g,Lr,Fr=mt,Or=_e,Pr=pe,Vr=ft,Ur=Sn,Br=Tt,qr=r,Gr=pr,Kr=h,Ee="@firebase/firestore";class o{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}o.UNAUTHENTICATED=new o(null),o.GOOGLE_CREDENTIALS=new o("google-credentials-uid"),o.FIRST_PARTY=new o("first-party-uid"),o.MOCK_USER=new o("mock-user");let jr="10.1.0";const zr=new class{constructor(e){this.name=e,this._logLevel=Y,this._logHandler=J,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in c))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?W[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,c.DEBUG,...e),this._logHandler(this,c.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,c.VERBOSE,...e),this._logHandler(this,c.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,c.INFO,...e),this._logHandler(this,c.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,c.WARN,...e),this._logHandler(this,c.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,c.ERROR,...e),this._logHandler(this,c.ERROR,...e)}}("@firebase/firestore");function $r(){return zr.logLevel}function m(e,...t){zr.logLevel<=c.DEBUG&&(t=t.map(Hr),zr.debug(`Firestore (${jr}): `+e,...t))}function d(e,...t){zr.logLevel<=c.ERROR&&(t=t.map(Hr),zr.error(`Firestore (${jr}): `+e,...t))}function Qr(e,...t){zr.logLevel<=c.WARN&&(t=t.map(Hr),zr.warn(`Firestore (${jr}): `+e,...t))}function Hr(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function b(e="Unexpected state"){e=`FIRESTORE (${jr}) INTERNAL ASSERTION FAILED: `+e;throw d(e),new Error(e)}function y(e){e||b()}const w={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class _ extends z{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: `+this.message}}class Wr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Yr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization","Bearer "+e)}}class Xr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(o.UNAUTHENTICATED))}shutdown(){}}class Jr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Zr{constructor(e){this.t=e,this.currentUser=o.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const i=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let s=new Wr;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Wr,t.enqueueRetryable(()=>i(this.currentUser))};const a=()=>{const e=s;t.enqueueRetryable(async()=>{await e.promise,await i(this.currentUser)})},o=e=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Wr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(y("string"==typeof e.accessToken),new Yr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return y(null===e||"string"==typeof e),new o(e)}}class ei{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=o.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);var e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class ti{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new ei(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(o.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class ni{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class ri{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,n){const r=e=>{null!=e.error&&m("FirebaseAppCheckTokenProvider","Error getting App Check token; using placeholder token instead. Error: "+e.error.message);var t=e.token!==this.R;return this.R=e.token,m("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()},i=(this.o=e=>{t.enqueueRetryable(()=>r(e))},e=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)});this.A.onInit(e=>i(e)),setTimeout(()=>{var e;this.appCheck||((e=this.A.getImmediate({optional:!0}))?i(e):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(y("string"==typeof e.token),this.R=e.token,new ni(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class ii{static V(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var i=function(){var e="undefined"!=typeof self&&(self.crypto||self.msCrypto),t=new Uint8Array(40);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(t);else for(let e=0;e<40;e++)t[e]=Math.floor(256*Math.random());return t}();for(let e=0;e<i.length;++e)r.length<20&&i[e]<n&&(r+=t.charAt(i[e]%t.length))}return r}}function I(e,t){return e<t?-1:t<e?1:0}function si(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function ai(e){return e+"\0"}class l{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new _(w.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new _(w.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new _(w.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new _(w.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return l.fromMillis(Date.now())}static fromDate(e){return l.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),e=Math.floor(1e6*(e-1e3*t));return new l(t,e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?I(this.nanoseconds,e.nanoseconds):I(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class E{constructor(e){this.timestamp=e}static fromTimestamp(e){return new E(e)}static min(){return new E(new l(0,0))}static max(){return new E(new l(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class oi{constructor(e,t,n){void 0===t?t=0:t>e.length&&b(),void 0===n?n=e.length-t:n>e.length-t&&b(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===oi.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof oi?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(n){for(let e=this.offset,t=this.limit();e<t;e++)n(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,n){const r=Math.min(t.length,n.length);for(let e=0;e<r;e++){const r=t.get(e),i=n.get(e);if(r<i)return-1;if(r>i)return 1}return t.length<n.length?-1:t.length>n.length?1:0}}class T extends oi{construct(e,t,n){return new T(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){var t=[];for(const n of e){if(0<=n.indexOf("//"))throw new _(w.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new T(t)}static emptyPath(){return new T([])}}const ui=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class f extends oi{construct(e,t,n){return new f(e,t,n)}static isValidIdentifier(e){return ui.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),f.isValidIdentifier(e)?e:"`"+e+"`")).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new f(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var i=()=>{if(0===n.length)throw new _(w.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new _(w.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new _(w.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new _(w.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new f(t)}static emptyPath(){return new f([])}}class S{constructor(e){this.path=e}static fromPath(e){return new S(T.fromString(e))}static fromName(e){return new S(T.fromString(e).popFirst(5))}static empty(){return new S(T.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===T.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return T.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new S(new T(e.slice()))}}class hi{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function li(e){return e.fields.find(e=>2===e.kind)}function ci(e){return e.fields.filter(e=>2!==e.kind)}hi.UNKNOWN_ID=-1;class di{constructor(e,t){this.fieldPath=e,this.kind=t}}class fi{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new fi(0,pi.min())}}function gi(e,t){var n=e.toTimestamp().seconds,e=e.toTimestamp().nanoseconds+1,e=E.fromTimestamp(1e9===e?new l(n+1,0):new l(n,e));return new pi(e,S.empty(),t)}function mi(e){return new pi(e.readTime,e.key,-1)}class pi{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new pi(E.min(),S.empty(),-1)}static max(){return new pi(E.max(),S.empty(),-1)}}function yi(e,t){var n=e.readTime.compareTo(t.readTime);return 0!==n||0!==(n=S.comparator(e.documentKey,t.documentKey))?n:I(e.largestBatchId,t.largestBatchId)}const vi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class wi{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function _i(e){if(e.code!==w.FAILED_PRECONDITION||e.message!==vi)throw e;m("LocalStore","Unexpectedly lost primary lease")}class D{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,i){return this.callbackAttached&&b(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new D((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(i,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof D?t:D.resolve(t)}catch(e){return D.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):D.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):D.reject(t)}static resolve(n){return new D((e,t)=>{e(n)})}static reject(n){return new D((e,t)=>{t(n)})}static waitFor(e){return new D((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=D.resolve(!1);for(const n of e)t=t.next(e=>e?D.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new D((t,n)=>{const r=o.length,i=new Array(r);let s=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{i[a]=e,++s===r&&t(i)},e=>n(e))}})}static doWhile(r,i){return new D((e,t)=>{const n=()=>{!0===r()?i().next(()=>{n()},t):e()};n()})}}class bi{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.m=new Wr,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{e.error?this.m.reject(new Ti(t,e.error)):this.m.resolve()},this.transaction.onerror=e=>{e=Ai(e.target.error);this.m.reject(new Ti(t,e))}}static open(e,t,n,r){try{return new bi(t,e.transaction(r,n))}catch(e){throw new Ti(t,e)}}get g(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(m("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}p(){var e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){e=this.transaction.objectStore(e);return new xi(e)}}class Ii{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===Ii.D(K())&&d("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return m("SimpleDb","Removing database:",e),Di(window.indexedDB.deleteDatabase(e)).toPromise()}static v(){var e,t,n;return!(!function(){try{return"object"==typeof indexedDB}catch(e){}}()||!Ii.C()&&(e=K(),t=0<(t=Ii.D(e))&&t<10,n=0<(n=Ii.F(e))&&n<4.5,0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||t||n))}static C(){var e;return"undefined"!=typeof process&&"YES"===(null==(e=process.env)?void 0:e.M)}static O(e,t){return e.store(t)}static D(e){e=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),e=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(e)}static F(e){e=e.match(/Android ([\d.]+)/i),e=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(e)}async N(i){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{e=e.target.result;t(e)},r.onblocked=()=>{n(new Ti(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{e=e.target.error;"VersionError"===e.name?n(new _(w.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===e.name?n(new _(w.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+e)):n(new Ti(i,e))},r.onupgradeneeded=e=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.S.B(t,r.transaction,e.oldVersion,this.version).next(()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(t){this.L=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var i="readonly"===t;let s=0;for(;;){++s;try{this.db=await this.N(e);const t=bi.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.p(),e)).catch(e=>(t.abort(e),D.reject(e))).toPromise();return s.catch(()=>{}),await t.g,s}catch(e){const t=e,n="FirebaseError"!==t.name&&s<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Ei{constructor(e){this.q=e,this.K=!1,this.$=null}get isDone(){return this.K}get U(){return this.$}set cursor(e){this.q=e}done(){this.K=!0}W(e){this.$=e}delete(){return Di(this.q.delete())}}class Ti extends _{constructor(e,t){super(w.UNAVAILABLE,`IndexedDB transaction '${e}' failed: `+t),this.name="IndexedDbTransactionError"}}function Si(e){return"IndexedDbTransactionError"===e.name}class xi{constructor(e){this.store=e}put(e,t){return Di(void 0!==t?(m("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)))}add(e){return m("SimpleDb","ADD",this.store.name,e,e),Di(this.store.add(e))}get(t){return Di(this.store.get(t)).next(e=>(m("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return m("SimpleDb","DELETE",this.store.name,e),Di(this.store.delete(e))}count(){return m("SimpleDb","COUNT",this.store.name),Di(this.store.count())}G(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.j(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new D((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}H(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new D((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}J(e,t){m("SimpleDb","DELETE ALL",this.store.name);e=this.options(e,t),e.Y=!1,t=this.cursor(e);return this.j(t,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);e=this.cursor(n);return this.j(e,t)}X(r){const e=this.cursor({});return new D((n,t)=>{e.onerror=e=>{e=Ai(e.target.error);t(e)},e.onsuccess=e=>{const t=e.target.result;t?r(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}j(e,i){const s=[];return new D((r,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{e=e.target.result;if(e){const t=new Ei(e),n=i(e.primaryKey,e.value,t);if(n instanceof D){const e=n.catch(e=>(t.done(),D.reject(e)));s.push(e)}t.isDone?r():null===t.U?e.continue():e.continue(t.U)}else r()}}).next(()=>D.waitFor(s))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";var n;return e.reverse&&(t="prev"),e.index?(n=this.store.index(e.index),e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)):this.store.openCursor(e.range,t)}}function Di(e){return new D((t,n)=>{e.onsuccess=e=>{e=e.target.result;t(e)},e.onerror=e=>{e=Ai(e.target.error);n(e)}})}let Ci=!1;function Ai(e){const t=Ii.D(K());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new _("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ci||(Ci=!0,setTimeout(()=>{throw e},0)),e}}return e}class Ni{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){m("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{m("IndexBackiller","Documents written: "+await this.ee.ne())}catch(e){Si(e)?m("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await _i(e)}await this.te(6e4)})}}class ki{constructor(e,t){this.localStore=e,this.persistence=t}async ne(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.re(e,t))}re(e,t){const n=new Set;let r=t,i=!0;return D.doWhile(()=>!0===i&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(i=!1):(m("IndexBackiller","Processing collection: "+t),this.ie(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}ie(r,i,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,i).next(n=>this.localStore.localDocuments.getNextDocuments(r,i,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.se(n,e)).next(e=>(m("IndexBackiller","Updating offset: "+e),this.localStore.indexManager.updateCollectionGroup(r,i,e))).next(()=>t.size)}))}se(e,t){let n=e;return t.changes.forEach((e,t)=>{t=mi(t);0<yi(t,n)&&(n=t)}),new pi(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class Ri{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this._e&&this._e(e),e}}function Mi(e){return null==e}function Li(e){return 0===e&&1/e==-1/0}function Fi(e){return"number"==typeof e&&Number.isInteger(e)&&!Li(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Oi(t){let i="";for(let e=0;e<t.length;e++)0<i.length&&(i=Pi(i)),i=function(t){let n=i;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(t.get(e));return Pi(i)}function Pi(e){return e+""}function Vi(n){const r=n.length;if(y(2<=r),2===r)return y(""===n.charAt(0)&&""===n.charAt(1)),T.emptyPath();var i=r-2,s=[];let a="";for(let t=0;t<r;){const r=n.indexOf("",t);switch((r<0||r>i)&&b(),n.charAt(r+1)){case"":var o=n.substring(t,r);let e;0===a.length?e=o:(a+=o,e=a,a=""),s.push(e);break;case"":a=a+n.substring(t,r)+"\0";break;case"":a+=n.substring(t,r+1);break;default:b()}t=r+2}return new T(s)}Ri.ae=-1;const Ui=["userId","batchId"];function Bi(e,t){return[e,Oi(t)]}function qi(e,t,n){return[e,Oi(t),n]}const Gi={},Ki=["prefixPath","collectionGroup","readTime","documentId"],ji=["prefixPath","collectionGroup","documentId"],zi=["collectionGroup","readTime","prefixPath","documentId"],$i=["canonicalId","targetId"],Qi=["targetId","path"],Hi=["path","targetId"],Wi=["collectionId","parent"],Yi=["indexId","uid"],Xi=["uid","sequenceNumber"],Ji=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Zi=["indexId","uid","orderedDocumentKey"],es=["userId","collectionPath","documentId"],ts=["userId","collectionPath","largestBatchId"],ns=["userId","collectionGroup","largestBatchId"],rs=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],is=[...rs,"documentOverlays"],ss=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],as=ss,os=[...as,"indexConfiguration","indexState","indexEntries"];class us extends wi{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function hs(e,t){return Ii.O(e.ue,t)}function ls(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function cs(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ds(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class C{constructor(e,t){this.comparator=e,this.root=t||gs.EMPTY}insert(e,t){return new C(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,gs.BLACK,null,null))}remove(e){return new C(this.comparator,this.root.remove(e,this.comparator).copy(null,null,gs.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(e+":"+t),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new fs(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new fs(this.root,e,this.comparator,!1)}getReverseIterator(){return new fs(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new fs(this.root,e,this.comparator,!0)}}class fs{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){var e;return 0===this.nodeStack.length?null:{key:(e=this.nodeStack[this.nodeStack.length-1]).key,value:e.value}}}class gs{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:gs.RED,this.left=null!=r?r:gs.EMPTY,this.right=null!=i?i:gs.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new gs(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){var r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return gs.EMPTY;let e=this;return(e=(e=e.left.isRed()||e.left.left.isRed()?e:e.moveRedLeft()).copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r=(r=r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()?r:r.moveRedLeft()).copy(null,null,null,r.left.remove(e,t),null);else{if(0===t(e,(r=(r=r.left.isRed()?r.rotateRight():r).right.isEmpty()||r.right.isRed()||r.right.left.isRed()?r:r.moveRedRight()).key)){if(r.right.isEmpty())return gs.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e=(e=(e=e.right.isRed()&&!e.left.isRed()?e.rotateLeft():e).left.isRed()&&e.left.left.isRed()?e.rotateRight():e).left.isRed()&&e.right.isRed()?e.colorFlip():e}moveRedLeft(){let e=this.colorFlip();return e=e.right.left.isRed()?(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip():e}moveRedRight(){let e=this.colorFlip();return e=e.left.left.isRed()?(e=e.rotateRight()).colorFlip():e}rotateLeft(){var e=this.copy(null,null,gs.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,gs.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw b();if(this.right.isRed())throw b();var e=this.left.check();if(e!==this.right.check())throw b();return e+(this.isRed()?0:1)}}gs.EMPTY=null,gs.RED=!0,gs.BLACK=!1,gs.EMPTY=new class{constructor(){this.size=0}get key(){throw b()}get value(){throw b()}get color(){throw b()}get left(){throw b()}get right(){throw b()}copy(e,t,n,r,i){return this}insert(e,t,n){return new gs(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class A{constructor(e){this.comparator=e,this.data=new C(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){for(var n=this.data.getIteratorFrom(e[0]);n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){for(var n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){e=this.data.getIteratorFrom(e);return e.hasNext()?e.getNext().key:null}getIterator(){return new ms(this.data.getIterator())}getIteratorFrom(e){return new ms(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof A))return!1;if(this.size!==e.size)return!1;for(var t=this.data.getIterator(),n=e.data.getIterator();t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){var t=new A(this.comparator);return t.data=e,t}}class ms{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function ps(e){return e.hasNext()?e.getNext():void 0}class ys{constructor(e){(this.fields=e).sort(f.comparator)}static empty(){return new ys([])}unionWith(e){let t=new A(f.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new ys(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return si(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class vs extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class ws{constructor(e){this.binaryString=e}static fromBase64String(e){e=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new vs("Invalid base64 string: "+e):e}}(e);return new ws(e)}static fromUint8Array(e){e=function(t){let n="";for(let e=0;e<t.length;++e)n+=String.fromCharCode(t[e]);return n}(e);return new ws(e)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){var t=this.binaryString,n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return I(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ws.EMPTY_BYTE_STRING=new ws("");const _s=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function bs(t){if(y(!!t),"string"!=typeof t)return{seconds:N(t.seconds),nanos:N(t.nanos)};{let e=0;var n=_s.exec(t),n=(y(!!n),n[1]&&(n=(n[1]+"000000000").substr(0,9),e=Number(n)),new Date(t));return{seconds:Math.floor(n.getTime()/1e3),nanos:e}}}function N(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Is(e){return"string"==typeof e?ws.fromBase64String(e):ws.fromUint8Array(e)}function Es(e){return"server_timestamp"===(null==(e=((null==(e=null==e?void 0:e.mapValue)?void 0:e.fields)||{}).__type__)?void 0:e.stringValue)}function Ts(e){e=e.mapValue.fields.__previous_value__;return Es(e)?Ts(e):e}function Ss(e){e=bs(e.mapValue.fields.__local_write_time__.timestampValue);return new l(e.seconds,e.nanos)}class xs{constructor(e,t,n,r,i,s,a,o,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=u}}class Ds{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Ds("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Ds&&e.projectId===this.projectId&&e.database===this.database}}const Cs={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},As={nullValue:"NULL_VALUE"};function Ns(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Es(e)?4:Ks(e)?9007199254740991:10:b()}function ks(e,t){if(e===t)return!0;var n,r,i,s=Ns(e);if(s!==Ns(t))return!1;switch(s){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Ss(e).isEqual(Ss(t));case 3:return r=t,"string"==typeof e.timestampValue&&"string"==typeof r.timestampValue&&e.timestampValue.length===r.timestampValue.length?e.timestampValue===r.timestampValue:(i=bs(e.timestampValue),r=bs(r.timestampValue),i.seconds===r.seconds&&i.nanos===r.nanos);case 5:return e.stringValue===t.stringValue;case 6:return n=t,Is(e.bytesValue).isEqual(Is(n.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return i=t,N((n=e).geoPointValue.latitude)===N(i.geoPointValue.latitude)&&N(n.geoPointValue.longitude)===N(i.geoPointValue.longitude);case 2:return r=t,"integerValue"in(n=e)&&"integerValue"in r?N(n.integerValue)===N(r.integerValue):"doubleValue"in n&&"doubleValue"in r&&((n=N(n.doubleValue))===(r=N(r.doubleValue))?Li(n)===Li(r):isNaN(n)&&isNaN(r));case 9:return si(e.arrayValue.values||[],t.arrayValue.values||[],ks);case 10:var a=e,o=a.mapValue.fields||{},u=t.mapValue.fields||{};if(ls(o)!==ls(u))return!1;for(const a in o)if(o.hasOwnProperty(a)&&(void 0===u[a]||!ks(o[a],u[a])))return!1;return!0;default:return b()}}function Rs(e,t){return void 0!==(e.values||[]).find(e=>ks(e,t))}function Ms(e,t){if(e===t)return 0;var n,r,i=Ns(e),s=Ns(t);if(i!==s)return I(i,s);switch(i){case 0:case 9007199254740991:return 0;case 1:return I(e.booleanValue,t.booleanValue);case 2:return r=t,(a=N((n=e).integerValue||n.doubleValue))<(g=N(r.integerValue||r.doubleValue))?-1:g<a?1:a===g?0:isNaN(a)?isNaN(g)?0:-1:1;case 3:return Ls(e.timestampValue,t.timestampValue);case 4:return Ls(Ss(e),Ss(t));case 5:return I(e.stringValue,t.stringValue);case 6:var a=e.bytesValue,o=t.bytesValue;return a=Is(a),o=Is(o),a.compareTo(o);case 7:var o=e.referenceValue,u=t.referenceValue,h=o.split("/"),l=u.split("/");for(let e=0;e<h.length&&e<l.length;e++){const u=I(h[e],l[e]);if(0!==u)return u}return I(h.length,l.length);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(g=I(N(n.latitude),N(r.latitude)))?g:I(N(n.longitude),N(r.longitude));case 9:var u=e.arrayValue,c=t.arrayValue,d=u.values||[],f=c.values||[];for(let e=0;e<d.length&&e<f.length;++e){const c=Ms(d[e],f[e]);if(c)return c}return I(d.length,f.length);case 10:var g=e.mapValue,m=t.mapValue;if(g===Cs.mapValue&&m===Cs.mapValue)return 0;if(g===Cs.mapValue)return 1;if(m===Cs.mapValue)return-1;var p=g.fields||{},y=Object.keys(p),v=m.fields||{},w=Object.keys(v);y.sort(),w.sort();for(let e=0;e<y.length&&e<w.length;++e){const m=I(y[e],w[e]);if(0!==m)return m;var _=Ms(p[y[e]],v[w[e]]);if(0!==_)return _}return I(y.length,w.length);default:throw b()}}function Ls(e,t){var n;return"string"==typeof e&&"string"==typeof t&&e.length===t.length?I(e,t):(e=bs(e),t=bs(t),0!==(n=I(e.seconds,t.seconds))?n:I(e.nanos,t.nanos))}function Fs(e){return function n(r){{if("nullValue"in r)return"null";if("booleanValue"in r)return""+r.booleanValue;if("integerValue"in r)return""+r.integerValue;if("doubleValue"in r)return""+r.doubleValue;if("timestampValue"in r)return`time(${(t=bs(r.timestampValue)).seconds},${t.nanos})`;if("stringValue"in r)return r.stringValue;if("bytesValue"in r)return Is(r.bytesValue).toBase64();if("referenceValue"in r)return t=r.referenceValue,S.fromName(t).toString();if("geoPointValue"in r)return`geo(${(e=r.geoPointValue).latitude},${e.longitude})`;if("arrayValue"in r){let e="[",t=!0;for(const s of r.arrayValue.values||[])t?t=!1:e+=",",e+=n(s);return e+"]"}if("mapValue"in r){var i=r.mapValue;let e="{",t=!0;for(const a of Object.keys(i.fields||{}).sort())t?t=!1:e+=",",e+=a+":"+n(i.fields[a]);return e+"}"}return b()}var e,t}(e)}function Os(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/`+t.path.canonicalString()}}function Ps(e){return e&&"integerValue"in e}function Vs(e){return!!e&&"arrayValue"in e}function Us(e){return e&&"nullValue"in e}function Bs(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function qs(e){return e&&"mapValue"in e}function Gs(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const r={mapValue:{fields:{}}};return cs(t.mapValue.fields,(e,t)=>r.mapValue.fields[e]=Gs(t)),r}if(t.arrayValue){var n={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)n.arrayValue.values[e]=Gs(t.arrayValue.values[e]);return n}return Object.assign({},t)}function Ks(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function js(e,t){var n=Ms(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function zs(e,t){var n=Ms(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class $s{constructor(e){this.value=e}static empty(){return new $s({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let t=this.value;for(let e=0;e<n.length-1;++e)if(!qs(t=(t.mapValue.fields||{})[n.get(e)]))return null;return(t=(t.mapValue.fields||{})[n.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Gs(t)}setAll(e){let n=f.emptyPath(),r={},i=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,i),r={},i=[],n=t.popLast()}e?r[t.lastSegment()]=Gs(e):i.push(t.lastSegment())});e=this.getFieldsMap(n);this.applyChanges(e,r,i)}delete(e){var t=this.field(e.popLast());qs(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return ks(this.value,e.value)}getFieldsMap(n){let r=this.value;r.mapValue.fields||(r.mapValue={fields:{}});for(let t=0;t<n.length;++t){let e=r.mapValue.fields[n.get(t)];qs(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},r.mapValue.fields[n.get(t)]=e),r=e}return r.mapValue.fields}applyChanges(n,e,t){cs(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new $s(Gs(this.value))}}class k{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new k(e,0,E.min(),E.min(),E.min(),$s.empty(),0)}static newFoundDocument(e,t,n,r){return new k(e,1,t,E.min(),n,r,0)}static newNoDocument(e,t){return new k(e,2,t,E.min(),E.min(),$s.empty(),0)}static newUnknownDocument(e,t){return new k(e,3,t,E.min(),E.min(),$s.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(E.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=$s.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=$s.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=E.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof k&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new k(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Qs{constructor(e,t){this.position=e,this.inclusive=t}}function Hs(t,n,r){let i=0;for(let e=0;e<t.position.length;e++){var s=n[e],a=t.position[e];if(i=s.field.isKeyField()?S.comparator(S.fromName(a.referenceValue),r.key):Ms(a,r.data.field(s.field)),"desc"===s.dir&&(i*=-1),0!==i)break}return i}function Ws(t,n){if(null===t)return null===n;if(null===n)return!1;if(t.inclusive!==n.inclusive||t.position.length!==n.position.length)return!1;for(let e=0;e<t.position.length;e++)if(!ks(t.position[e],n.position[e]))return!1;return!0}class Ys{constructor(e,t="asc"){this.field=e,this.dir=t}}class Xs{}class R extends Xs{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new ia(e,t,n):"array-contains"===t?new ua(e,n):"in"===t?new ha(e,n):"not-in"===t?new la(e,n):"array-contains-any"===t?new ca(e,n):new R(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?sa:aa)(e,n)}matches(e){e=e.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(Ms(e,this.value)):null!==e&&Ns(this.value)===Ns(e)&&this.matchesComparison(Ms(e,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return b()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class M extends Xs{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new M(e,t)}matches(t){return Js(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null===this.ce&&(this.ce=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ce}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){var e=this.le(e=>e.isInequality());return null!==e?e.field:null}le(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function Js(e){return"and"===e.op}function Zs(e){return"or"===e.op}function ea(e){return ta(e)&&Js(e)}function ta(e){for(const t of e.filters)if(t instanceof M)return!1;return!0}function na(e,t){t=e.filters.concat(t);return M.create(t,e.op)}function ra(e){return e instanceof R?`${(t=e).field.canonicalString()} ${t.op} `+Fs(t.value):e instanceof M?e.op.toString()+" {"+e.getFilters().map(ra).join(" ,")+"}":"Filter";var t}class ia extends R{constructor(e,t,n){super(e,t,n),this.key=S.fromName(n.referenceValue)}matches(e){e=S.comparator(e.key,this.key);return this.matchesComparison(e)}}class sa extends R{constructor(e,t){super(e,"in",t),this.keys=oa(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class aa extends R{constructor(e,t){super(e,"not-in",t),this.keys=oa(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function oa(e,t){return((null==(t=t.arrayValue)?void 0:t.values)||[]).map(e=>S.fromName(e.referenceValue))}class ua extends R{constructor(e,t){super(e,"array-contains",t)}matches(e){e=e.data.field(this.field);return Vs(e)&&Rs(e.arrayValue,this.value)}}class ha extends R{constructor(e,t){super(e,"in",t)}matches(e){e=e.data.field(this.field);return null!==e&&Rs(this.value.arrayValue,e)}}class la extends R{constructor(e,t){super(e,"not-in",t)}matches(e){return!Rs(this.value.arrayValue,{nullValue:"NULL_VALUE"})&&null!==(e=e.data.field(this.field))&&!Rs(this.value.arrayValue,e)}}class ca extends R{constructor(e,t){super(e,"array-contains-any",t)}matches(e){e=e.data.field(this.field);return!(!Vs(e)||!e.arrayValue.values)&&e.arrayValue.values.some(e=>Rs(this.value.arrayValue,e))}}class da{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.he=null}}function fa(e,t=null,n=[],r=[],i=null,s=null,a=null){return new da(e,t,n,r,i,s,a)}function ga(t){if(null===t.he){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e=(e=(e+="|f:")+t.filters.map(e=>function t(e){var n;return e instanceof R?e.field.canonicalString()+e.op.toString()+Fs(e.value):ea(e)?e.filters.map(e=>t(e)).join(","):(n=e.filters.map(e=>t(e)).join(","),e.op+`(${n})`)}(e)).join(",")+"|ob:")+t.orderBy.map(e=>{return(e=e).field.canonicalString()+e.dir}).join(","),Mi(t.limit)||(e=(e+="|l:")+t.limit),t.startAt&&(e=(e=(e+="|lb:")+(t.startAt.inclusive?"b:":"a:"))+t.startAt.position.map(e=>Fs(e)).join(",")),t.endAt&&(e=(e=(e+="|ub:")+(t.endAt.inclusive?"a:":"b:"))+t.endAt.position.map(e=>Fs(e)).join(",")),t.he=e}return t.he}function ma(t,n){if(t.limit!==n.limit)return!1;if(t.orderBy.length!==n.orderBy.length)return!1;for(let e=0;e<t.orderBy.length;e++)if(r=t.orderBy[e],i=n.orderBy[e],r.dir!==i.dir||!r.field.isEqual(i.field))return!1;var r,i;if(t.filters.length!==n.filters.length)return!1;for(let e=0;e<t.filters.length;e++)if(!function r(e,t){return e instanceof R?(n=e,(s=t)instanceof R&&n.op===s.op&&n.field.isEqual(s.field)&&ks(n.value,s.value)):e instanceof M?(i=t)instanceof M&&e.op===i.op&&e.filters.length===i.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,i.filters[n]),!0):void b();var i,n,s}(t.filters[e],n.filters[e]))return!1;return t.collectionGroup===n.collectionGroup&&!!t.path.isEqual(n.path)&&!!Ws(t.startAt,n.startAt)&&Ws(t.endAt,n.endAt)}function pa(e){return S.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function ya(e,t){return e.filters.filter(e=>e instanceof R&&e.field.isEqual(t))}function va(t,n,r){let i=As,s=!0;for(const r of ya(t,n)){let e=As,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?As:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Os(Ds.empty(),S.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:b();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=As}js({value:i,inclusive:s},{value:e,inclusive:t})<0&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];js({value:i,inclusive:s},{value:t,inclusive:r.inclusive})<0&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}function wa(t,n,r){let i=Cs,s=!0;for(const r of ya(t,n)){let e=Cs,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Os(Ds.empty(),S.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?Cs:b(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=Cs}0<zs({value:i,inclusive:s},{value:e,inclusive:t})&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<zs({value:i,inclusive:s},{value:t,inclusive:r.inclusive})&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}class _a{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.Pe=null,this.Ie=null,this.startAt,this.endAt}}function ba(e,t,n,r,i,s,a,o){return new _a(e,t,n,r,i,s,a,o)}function Ia(e){return new _a(e)}function Ea(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Ta(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function Sa(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function xa(e){return null!==e.collectionGroup}function Da(t){var n=t;if(null===n.Pe){n.Pe=[];const t=Sa(n),e=Ta(n);if(null!==t&&null===e)t.isKeyField()||n.Pe.push(new Ys(t)),n.Pe.push(new Ys(f.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n.Pe.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.Pe.push(new Ys(f.keyField(),t))}}}return n.Pe}function Ca(e){const t=e;if(!t.Ie)if("F"===t.limitType)t.Ie=fa(t.path,t.collectionGroup,Da(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const i of Da(t)){const t="desc"===i.dir?"asc":"desc";e.push(new Ys(i.field,t))}var n=t.endAt?new Qs(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Qs(t.startAt.position,t.startAt.inclusive):null;t.Ie=fa(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.Ie}function Aa(e,t){t.getFirstInequalityField(),Sa(e);t=e.filters.concat([t]);return new _a(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)}function Na(e,t,n){return new _a(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function ka(e,t){return ma(Ca(e),Ca(t))&&e.limitType===t.limitType}function Ra(e){return ga(Ca(e))+"|lt:"+e.limitType}function Ma(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>ra(e)).join(", ")}]`),Mi(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>{return`${(e=e).field.canonicalString()} (${e.dir})`}).join(", ")}]`),e.startAt&&(t=(t=(t+=", startAt: ")+(e.startAt.inclusive?"b:":"a:"))+e.startAt.position.map(e=>Fs(e)).join(",")),`Target(${t=e.endAt?(t=(t+=", endAt: ")+(e.endAt.inclusive?"a:":"b:"))+e.endAt.position.map(e=>Fs(e)).join(","):t})`}(Ca(e))}; limitType=${e.limitType})`}function La(n,e){return e.isFoundDocument()&&(i=n,a=(s=e).key.path,null!==i.collectionGroup?s.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(a):S.isDocumentKey(i.path)?i.path.isEqual(a):i.path.isImmediateParentOf(a))&&function(e){for(const t of Da(n))if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(i=e,!(e=n).startAt||(r=Hs(t=e.startAt,n=Da(e),i),t.inclusive?r<=0:r<0))&&(!e.endAt||(r=Hs(t=e.endAt,e=Da(e),i),t.inclusive?0<=r:0<r));var t,r,i,s,a}function Fa(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Oa(i){return(e,t)=>{let n=!1;for(const r of Da(i)){const i=function(e,t,n){var r,i=e.field.isKeyField()?S.comparator(t.key,n.key):(r=e.field,n=n,t=t.data.field(r),n=n.data.field(r),null!==t&&null!==n?Ms(t,n):b());switch(e.dir){case"asc":return i;case"desc":return-1*i;default:return b()}}(r,e,t);if(0!==i)return i;n=n||r.field.isKeyField()}return 0}}class Pa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(t,n){var e=this.mapKeyFn(t),r=this.inner[e];if(void 0===r)this.inner[e]=[[t,n]];else{for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return void(r[e]=[t,n]);r.push([t,n])}this.innerSize++}delete(t){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r)for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return 1===r.length?delete this.inner[n]:r.splice(e,1),this.innerSize--,!0;return!1}forEach(r){cs(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return ds(this.inner)}size(){return this.innerSize}}const Va=new C(S.comparator),Ua=new C(S.comparator);function Ba(...e){let t=Ua;for(const n of e)t=t.insert(n.key,n);return t}function qa(e){let n=Ua;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function Ga(){return new Pa(e=>e.toString(),(e,t)=>e.isEqual(t))}const Ka=new C(S.comparator),ja=new A(S.comparator);function L(...e){let t=ja;for(const n of e)t=t.add(n);return t}const za=new A(I);function $a(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Li(t)?"-0":t}}function Qa(e){return{integerValue:""+e}}function Ha(e,t){return Fi(t)?Qa(t):$a(e,t)}class Wa{constructor(){this._=void 0}}function Ya(e,t){return e instanceof no?Ps(e=t)||e&&"doubleValue"in e?t:{integerValue:0}:null}class Xa extends Wa{}class Ja extends Wa{constructor(e){super(),this.elements=e}}function Za(e,t){var n=io(t);for(const t of e.elements)n.some(e=>ks(e,t))||n.push(t);return{arrayValue:{values:n}}}class eo extends Wa{constructor(e){super(),this.elements=e}}function to(e,t){let n=io(t);for(const t of e.elements)n=n.filter(e=>!ks(e,t));return{arrayValue:{values:n}}}class no extends Wa{constructor(e,t){super(),this.serializer=e,this.Te=t}}function ro(e){return N(e.integerValue||e.doubleValue)}function io(e){return Vs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class so{constructor(e,t){this.field=e,this.transform=t}}class ao{constructor(e,t){this.version=e,this.transformResults=t}}class F{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new F}static exists(e){return new F(void 0,e)}static updateTime(e){return new F(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function oo(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class uo{}function ho(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new vo(e.key,F.none()):new fo(e.key,e.data,F.none());{var r,i=e.data,s=$s.empty();let t=new A(f.comparator);for(r of n.fields)if(!t.has(r)){let e=i.field(r);null===e&&1<r.length&&(r=r.popLast(),e=i.field(r)),null===e?s.delete(r):s.set(r,e),t=t.add(r)}return new go(e.key,s,new ys(t.toArray()),F.none())}}function lo(e,t,n,r){return e instanceof fo?(s=t,a=n,o=r,oo((i=e).precondition,s)?(u=i.value.clone(),i=yo(i.fieldTransforms,o,s),u.setAll(i),s.convertToFoundDocument(s.version,u).setHasLocalMutations(),null):a):e instanceof go?(o=t,i=n,s=r,oo((u=e).precondition,o)?(s=yo(u.fieldTransforms,s,o),(a=o.data).setAll(mo(u)),a.setAll(s),o.convertToFoundDocument(o.version,a).setHasLocalMutations(),null===i?null:i.unionWith(u.fieldMask.fields).unionWith(u.fieldTransforms.map(e=>e.field))):i):oo(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n;var i,s,a,o,u}function co(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&si(n,r,(e,t)=>{return t=t,(e=e).field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Ja&&t instanceof Ja||e instanceof eo&&t instanceof eo?si(e.elements,t.elements,ks):e instanceof no&&t instanceof no?ks(e.Te,t.Te):e instanceof Xa&&t instanceof Xa)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask));var n,r}class fo extends uo{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class go extends uo{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function mo(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function po(t,n,r){var i=new Map;y(t.length===r.length);for(let e=0;e<r.length;e++){var s=t[e],a=s.transform,o=n.data.field(s.field);i.set(s.field,(s=a,a=o,o=r[e],s instanceof Ja?Za(s,a):s instanceof eo?to(s,a):o))}return i}function yo(e,t,n){var r,i,s,a,o=new Map;for(const u of e){const e=u.transform,h=n.data.field(u.field);o.set(u.field,(r=e,i=h,s=t,0,r instanceof Xa?(a=void 0,a={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:s.seconds,nanos:s.nanoseconds}}}},(s=i&&Es(i)?Ts(i):i)&&(a.fields.__previous_value__=s),{mapValue:a}):r instanceof Ja?Za(r,i):r instanceof eo?to(r,i):(a=ro(s=Ya(r,i))+ro(r.Te),Ps(s)&&Ps(r.Te)?Qa(a):$a(r.serializer,a))))}return o}class vo extends uo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class wo extends uo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class _o{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){var n,r,i,s,a,o,u=e.mutationResults;for(let e=0;e<this.mutations.length;e++){var h=this.mutations[e];h.key.isEqual(t.key)&&(h=h,n=t,r=u[e],o=a=s=i=void 0,h instanceof fo?(s=n,a=r,o=(i=h).value.clone(),i=po(i.fieldTransforms,s,a.transformResults),o.setAll(i),s.convertToFoundDocument(a.version,o).setHasCommittedMutations()):h instanceof go?(i=n,s=r,oo((a=h).precondition,i)?(o=po(a.fieldTransforms,i,s.transformResults),(h=i.data).setAll(mo(a)),h.setAll(o),i.convertToFoundDocument(s.version,h).setHasCommittedMutations()):i.convertToUnknownDocument(s.version)):n.convertToNoDocument(r.version).setHasCommittedMutations())}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=lo(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=lo(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(r,i){const s=Ga();return this.mutations.forEach(e=>{var t=r.get(e.key),n=t.overlayedDocument,t=this.applyToLocalView(n,t.mutatedFields),t=ho(n,i.has(e.key)?null:t);null!==t&&s.set(e.key,t),n.isValidDocument()||n.convertToNoDocument(E.min())}),s}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),L())}isEqual(e){return this.batchId===e.batchId&&si(this.mutations,e.mutations,(e,t)=>co(e,t))&&si(this.baseMutations,e.baseMutations,(e,t)=>co(e,t))}}class bo{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){y(e.mutations.length===n.length);let r=Ka;var i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new bo(e,t,n,r)}}class Io{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class Eo{constructor(e,t){this.count=e,this.unchangedNames=t}}function To(e){switch(e){default:return b(),0;case w.CANCELLED:case w.UNKNOWN:case w.DEADLINE_EXCEEDED:case w.RESOURCE_EXHAUSTED:case w.INTERNAL:case w.UNAVAILABLE:case w.UNAUTHENTICATED:return;case w.INVALID_ARGUMENT:case w.NOT_FOUND:case w.ALREADY_EXISTS:case w.PERMISSION_DENIED:case w.FAILED_PRECONDITION:case w.ABORTED:case w.OUT_OF_RANGE:case w.UNIMPLEMENTED:case w.DATA_LOSS:return 1}}function So(e){if(void 0===e)return d("GRPC error has no .code"),w.UNKNOWN;switch(e){case g.OK:return w.OK;case g.CANCELLED:return w.CANCELLED;case g.UNKNOWN:return w.UNKNOWN;case g.DEADLINE_EXCEEDED:return w.DEADLINE_EXCEEDED;case g.RESOURCE_EXHAUSTED:return w.RESOURCE_EXHAUSTED;case g.INTERNAL:return w.INTERNAL;case g.UNAVAILABLE:return w.UNAVAILABLE;case g.UNAUTHENTICATED:return w.UNAUTHENTICATED;case g.INVALID_ARGUMENT:return w.INVALID_ARGUMENT;case g.NOT_FOUND:return w.NOT_FOUND;case g.ALREADY_EXISTS:return w.ALREADY_EXISTS;case g.PERMISSION_DENIED:return w.PERMISSION_DENIED;case g.FAILED_PRECONDITION:return w.FAILED_PRECONDITION;case g.ABORTED:return w.ABORTED;case g.OUT_OF_RANGE:return w.OUT_OF_RANGE;case g.UNIMPLEMENTED:return w.UNIMPLEMENTED;case g.DATA_LOSS:return w.DATA_LOSS;default:return b()}}pe=g={OK:0,0:"OK",CANCELLED:1,1:"CANCELLED",UNKNOWN:2,2:"UNKNOWN",INVALID_ARGUMENT:3,3:"INVALID_ARGUMENT",DEADLINE_EXCEEDED:4,4:"DEADLINE_EXCEEDED",NOT_FOUND:5,5:"NOT_FOUND",ALREADY_EXISTS:6,6:"ALREADY_EXISTS",PERMISSION_DENIED:7,7:"PERMISSION_DENIED",UNAUTHENTICATED:16,16:"UNAUTHENTICATED",RESOURCE_EXHAUSTED:8,8:"RESOURCE_EXHAUSTED",FAILED_PRECONDITION:9,9:"FAILED_PRECONDITION",ABORTED:10,10:"ABORTED",OUT_OF_RANGE:11,11:"OUT_OF_RANGE",UNIMPLEMENTED:12,12:"UNIMPLEMENTED",INTERNAL:13,13:"INTERNAL",UNAVAILABLE:14,14:"UNAVAILABLE",DATA_LOSS:15,15:"DATA_LOSS"};class xo{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return Do}static getOrCreateInstance(){return Do=null===Do?new xo:Do}onExistenceFilterMismatch(e){const t=Symbol();return this.onExistenceFilterMismatchCallbacks.set(t,e),()=>this.onExistenceFilterMismatchCallbacks.delete(t)}notifyOnExistenceFilterMismatch(t){this.onExistenceFilterMismatchCallbacks.forEach(e=>e(t))}}let Do=null;function Co(){return new TextEncoder}const Ao=new Kr([4294967295,4294967295],0);function No(e){var e=Co().encode(e),t=new Gr;return t.update(e),new Uint8Array(t.digest())}function ko(e){var e=new DataView(e.buffer),t=e.getUint32(0,!0),n=e.getUint32(4,!0),r=e.getUint32(8,!0),e=e.getUint32(12,!0);return[new Kr([t,n],0),new Kr([r,e],0)]}class Ro{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new Mo("Invalid padding: "+t);if(n<0)throw new Mo("Invalid hash count: "+n);if(0<e.length&&0===this.hashCount)throw new Mo("Invalid hash count: "+n);if(0===e.length&&0!==t)throw new Mo("Invalid padding when bitmap length is 0: "+t);this.de=8*e.length-t,this.Ae=Kr.fromNumber(this.de)}Re(e,t,n){let r=e.add(t.multiply(Kr.fromNumber(n)));return(r=1===r.compare(Ao)?new Kr([r.getBits(0),r.getBits(1)],0):r).modulo(this.Ae).toNumber()}Ve(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.de)return!1;const t=No(e),[n,r]=ko(t);for(let e=0;e<this.hashCount;e++){const t=this.Re(n,r,e);if(!this.Ve(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new Ro(i,r,t);return n.forEach(e=>s.insert(e)),s}insert(e){if(0!==this.de){var[t,n]=ko(No(e));for(let e=0;e<this.hashCount;e++){var r=this.Re(t,n,e);this.me(r)}}}me(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Mo extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Lo{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){var r=new Map;return r.set(e,Fo.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Lo(E.min(),r,new C(I),Va,L())}}class Fo{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Fo(n,t,L(),L(),L())}}class Oo{constructor(e,t,n,r){this.fe=e,this.removedTargetIds=t,this.key=n,this.ge=r}}class Po{constructor(e,t){this.targetId=e,this.pe=t}}class Vo{constructor(e,t,n=ws.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Uo{constructor(){this.ye=0,this.we=Go(),this.Se=ws.EMPTY_BYTE_STRING,this.be=!1,this.De=!0}get current(){return this.be}get resumeToken(){return this.Se}get ve(){return 0!==this.ye}get Ce(){return this.De}Fe(e){0<e.approximateByteSize()&&(this.De=!0,this.Se=e)}Me(){let n=L(),r=L(),i=L();return this.we.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:i=i.add(e);break;default:b()}}),new Fo(this.Se,this.be,n,r,i)}xe(){this.De=!1,this.we=Go()}Oe(e,t){this.De=!0,this.we=this.we.insert(e,t)}Ne(e){this.De=!0,this.we=this.we.remove(e)}Be(){this.ye+=1}Le(){--this.ye}ke(){this.De=!0,this.be=!0}}class Bo{constructor(e){this.qe=e,this.Qe=new Map,this.Ke=Va,this.$e=qo(),this.Ue=new C(I)}We(e){for(const t of e.fe)e.ge&&e.ge.isFoundDocument()?this.Ge(t,e.ge):this.ze(t,e.key,e.ge);for(const n of e.removedTargetIds)this.ze(n,e.key,e.ge)}je(n){this.forEachTarget(n,e=>{var t=this.He(e);switch(n.state){case 0:this.Je(e)&&t.Fe(n.resumeToken);break;case 1:t.Le(),t.ve||t.xe(),t.Fe(n.resumeToken);break;case 2:t.Le(),t.ve||this.removeTarget(e);break;case 3:this.Je(e)&&(t.ke(),t.Fe(n.resumeToken));break;case 4:this.Je(e)&&(this.Ye(e),t.Fe(n.resumeToken));break;default:b()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Qe.forEach((e,t)=>{this.Je(t)&&n(t)})}Ze(e){const t=e.targetId,n=e.pe.count,r=this.Xe(t);if(r){var i=r.target;if(pa(i))if(0===n){const e=new S(i.path);this.ze(t,e,k.newNoDocument(e,E.min()))}else y(1===n);else{const r=this.et(t);if(r!==n){const n=this.tt(e,r);if(0!==n.status){this.Ye(t);const e=2===n.status?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ue=this.Ue.insert(t,e)}null!=(i=xo.instance)&&i.notifyOnExistenceFilterMismatch(function(e,t,n,r){n={localCacheCount:n,existenceFilterCount:r.count},r=r.unchangedNames;return r&&(n.bloomFilter={applied:0===e,hashCount:null!=(e=null==r?void 0:r.hashCount)?e:0,bitmapLength:null!=(e=null==(e=null==(e=null==r?void 0:r.bits)?void 0:e.bitmap)?void 0:e.length)?e:0,padding:null!=(e=null==(e=null==r?void 0:r.bits)?void 0:e.padding)?e:0},t)&&(n.bloomFilter.mightContain=t),n}(n.status,null!=(i=n.nt)?i:null,r,e.pe))}}}}tt(e,t){var{unchangedNames:n,count:r}=e.pe;if(!n||!n.bits)return{status:1};var{bits:{bitmap:i="",padding:s=0},hashCount:n=0}=n;let a,o;try{a=Is(i).toUint8Array()}catch(e){if(e instanceof vs)return Qr("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),{status:1};throw e}try{o=new Ro(a,s,n)}catch(e){return Qr(e instanceof Mo?"BloomFilter error: ":"Applying bloom filter failed: ",e),{status:1}}return n=e=>{var t=this.qe.rt();return o.mightContain(`projects/${t.projectId}/databases/${t.database}/documents/`+e)},0===o.de?{status:1}:{status:r===t-this.it(e.targetId,n)?0:2,nt:n}}it(t,n){var e=this.qe.getRemoteKeysForTarget(t);let r=0;return e.forEach(e=>{n(e.path.canonicalString())||(this.ze(t,e,null),r++)}),r}st(r){const i=new Map;this.Qe.forEach((e,t)=>{var n=this.Xe(t);if(n){if(e.current&&pa(n.target)){const i=new S(n.target.path);null!==this.Ke.get(i)||this.ot(t,i)||this.ze(t,i,k.newNoDocument(i,r))}e.Ce&&(i.set(t,e.Me()),e.xe())}});let s=L();this.$e.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{e=this.Xe(e);return!e||"TargetPurposeLimboResolution"===e.purpose||(n=!1)}),n&&(s=s.add(e))}),this.Ke.forEach((e,t)=>t.setReadTime(r));var e=new Lo(r,i,this.Ue,this.Ke,s);return this.Ke=Va,this.$e=qo(),this.Ue=new C(I),e}Ge(e,t){var n;this.Je(e)&&(n=this.ot(e,t.key)?2:0,this.He(e).Oe(t.key,n),this.Ke=this.Ke.insert(t.key,t),this.$e=this.$e.insert(t.key,this._t(t.key).add(e)))}ze(e,t,n){var r;this.Je(e)&&(r=this.He(e),this.ot(e,t)?r.Oe(t,1):r.Ne(t),this.$e=this.$e.insert(t,this._t(t).delete(e)),n)&&(this.Ke=this.Ke.insert(t,n))}removeTarget(e){this.Qe.delete(e)}et(e){var t=this.He(e).Me();return this.qe.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Be(e){this.He(e).Be()}He(e){let t=this.Qe.get(e);return t||(t=new Uo,this.Qe.set(e,t)),t}_t(e){let t=this.$e.get(e);return t||(t=new A(I),this.$e=this.$e.insert(e,t)),t}Je(e){var t=null!==this.Xe(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t}Xe(e){var t=this.Qe.get(e);return t&&t.ve?null:this.qe.ut(e)}Ye(t){this.Qe.set(t,new Uo),this.qe.getRemoteKeysForTarget(t).forEach(e=>{this.ze(t,e,null)})}ot(e,t){return this.qe.getRemoteKeysForTarget(e).has(t)}}function qo(){return new C(S.comparator)}function Go(){return new C(S.comparator)}const Ko={asc:"ASCENDING",desc:"DESCENDING"},jo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},zo={and:"AND",or:"OR"};class $o{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Qo(e,t){return e.useProto3Json||Mi(t)?t:{value:t}}function Ho(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Wo(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function O(e){return y(!!e),E.fromTimestamp((e=bs(e),new l(e.seconds,e.nanos)))}function Yo(e,t){return new T(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function Xo(e){e=T.fromString(e);return y(fu(e)),e}function Jo(e,t){return Yo(e.databaseId,t.path)}function Zo(e,t){t=Xo(t);if(t.get(1)!==e.databaseId.projectId)throw new _(w.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+e.databaseId.projectId);if(t.get(3)!==e.databaseId.database)throw new _(w.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+e.databaseId.database);return new S(ru(t))}function eu(e,t){return Yo(e.databaseId,t)}function tu(e){e=Xo(e);return 4===e.length?T.emptyPath():ru(e)}function nu(e){return new T(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function ru(e){return y(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function iu(e,t,n){return{name:Jo(e,t),fields:n.value.mapValue.fields}}function su(e,t,n){var e=Zo(e,t.name),r=O(t.updateTime),i=t.createTime?O(t.createTime):E.min(),t=new $s({mapValue:{fields:t.fields}}),e=k.newFoundDocument(e,r,i,t);return n&&e.setHasCommittedMutations(),n?e.setHasCommittedMutations():e}function au(e,t){let n;if(t instanceof fo)n={update:iu(e,t.key,t.value)};else if(t instanceof vo)n={delete:Jo(e,t.key)};else if(t instanceof go)n={update:iu(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof wo))return b();n={verify:Jo(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>{var t=e.transform;if(t instanceof Xa)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Ja)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof eo)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof no)return{fieldPath:e.field.canonicalString(),increment:t.Te};throw b()})),t.precondition.isNone||(n.currentDocument=(r=e,void 0!==(e=t.precondition).updateTime?{updateTime:Ho(r,(t=e.updateTime).toTimestamp())}:void 0!==e.exists?{exists:e.exists}:b())),n;var r}function ou(r,e){const t=e.currentDocument?void 0!==(s=e.currentDocument).updateTime?F.updateTime(O(s.updateTime)):void 0!==s.exists?F.exists(s.exists):F.none():F.none(),n=e.updateTransforms?e.updateTransforms.map(t=>{{var n=r;let e=null;if("setToServerValue"in t)y("REQUEST_TIME"===t.setToServerValue),e=new Xa;else if("appendMissingElements"in t){const n=t.appendMissingElements.values||[];e=new Ja(n)}else if("removeAllFromArray"in t){const n=t.removeAllFromArray.values||[];e=new eo(n)}else"increment"in t?e=new no(n,t.increment):b();return n=f.fromServerFormat(t.fieldPath),new so(n,e)}}):[];var i;if(e.update){e.update.name;var s=Zo(r,e.update.name),a=new $s({mapValue:{fields:e.update.fields}});if(e.updateMask){i=e.updateMask.fieldPaths||[];const r=new ys(i.map(e=>f.fromServerFormat(e)));return new go(s,a,r,t,n)}return new fo(s,a,t,n)}if(e.delete){const n=Zo(r,e.delete);return new vo(n,t)}if(e.verify){const n=Zo(r,e.verify);return new wo(n,t)}return b()}function uu(e,t){return{documents:[eu(e,t.path)]}}function hu(e,t){var n={structuredQuery:{}},r=t.path,r=(null!==t.collectionGroup?(n.parent=eu(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=eu(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),function(e){if(0!==e.length)return function t(e){if(e instanceof R){var n=e;if("=="===n.op){if(Bs(n.value))return{unaryFilter:{field:cu(n.field),op:"IS_NAN"}};if(Us(n.value))return{unaryFilter:{field:cu(n.field),op:"IS_NULL"}}}else if("!="===n.op){if(Bs(n.value))return{unaryFilter:{field:cu(n.field),op:"IS_NOT_NAN"}};if(Us(n.value))return{unaryFilter:{field:cu(n.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:cu(n.field),op:(r=n.op,jo[r]),value:n.value}}}return e instanceof M?1===(n=(r=e).getFilters().map(e=>t(e))).length?n[0]:{compositeFilter:{op:(r=r.op,zo[r]),filters:n}}:b();var r}(M.create(e,"and"))}(t.filters));return r&&(n.structuredQuery.where=r),(r=function(e){if(0!==e.length)return e.map(e=>{return{field:cu((e=e).field),direction:(e=e.dir,Ko[e])}})}(t.orderBy))&&(n.structuredQuery.orderBy=r),null!==(r=Qo(e,t.limit))&&(n.structuredQuery.limit=r),t.startAt&&(n.structuredQuery.startAt={before:(e=t.startAt).inclusive,values:e.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function lu(e){let t=tu(e.parent);var n,r,i,s=e.structuredQuery,a=s.from?s.from.length:0;let o=null,u=(0<a&&(y(1===a),(a=s.from[0]).allDescendants?o=a.collectionId:t=t.child(a.collectionId)),[]),h=(s.where&&(u=(a=function t(e){if(void 0!==e.unaryFilter){var n=e;switch(n.unaryFilter.op){case"IS_NAN":var r=du(n.unaryFilter.field);return R.create(r,"==",{doubleValue:NaN});case"IS_NULL":r=du(n.unaryFilter.field);return R.create(r,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":r=du(n.unaryFilter.field);return R.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":r=du(n.unaryFilter.field);return R.create(r,"!=",{nullValue:"NULL_VALUE"});default:return b()}}else{return void 0!==e.fieldFilter?(s=e,R.create(du(s.fieldFilter.field),function(){switch(s.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return b()}}(),s.fieldFilter.value)):void 0!==e.compositeFilter?(i=e,M.create(i.compositeFilter.filters.map(e=>t(e)),function(){switch(i.compositeFilter.op){case"AND":return"and";case"OR":return"or";default:return b()}}())):b();var i,s}}(s.where))instanceof M&&ea(a)?a.getFilters():[a]),[]),l=(s.orderBy&&(h=s.orderBy.map(e=>{return t=e,new Ys(du(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}());var t})),null),c=(s.limit&&(l=Mi(n="object"==typeof(e=s.limit)?e.value:e)?null:n),null),d=(s.startAt&&(c=(i=!!(r=s.startAt).before,n=r.values||[],new Qs(n,i))),null);return s.endAt&&(d=(i=!(r=s.endAt).before,s=r.values||[],new Qs(s,i))),ba(t,o,h,u,l,"F",c,d)}function cu(e){return{fieldPath:e.canonicalString()}}function du(e){return f.fromServerFormat(e.fieldPath)}function fu(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class gu{constructor(e,t,n,r,i=E.min(),s=E.min(),a=ws.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new gu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new gu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new gu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new gu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class mu{constructor(e){this.ct=e}}function pu(e,t){var n,r=t.key,i={prefixPath:r.getCollectionPath().popLast().toArray(),collectionGroup:r.collectionGroup,documentId:r.path.lastSegment(),readTime:yu(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())i.document={name:Jo(n=e.ct,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:Ho(n,e.version.toTimestamp()),createTime:Ho(n,e.createTime.toTimestamp())};else if(t.isNoDocument())i.noDocument={path:r.path.toArray(),readTime:vu(t.version)};else{if(!t.isUnknownDocument())return b();i.unknownDocument={path:r.path.toArray(),version:vu(t.version)}}return i}function yu(e){e=e.toTimestamp();return[e.seconds,e.nanoseconds]}function vu(e){e=e.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function wu(e){e=new l(e.seconds,e.nanoseconds);return E.fromTimestamp(e)}function _u(t,n){const r=(n.baseMutations||[]).map(e=>ou(t.ct,e));for(let e=0;e<n.mutations.length-1;++e){const r=n.mutations[e];if(e+1<n.mutations.length&&void 0!==n.mutations[e+1].transform){const i=n.mutations[e+1];r.updateTransforms=i.transform.fieldTransforms,n.mutations.splice(e+1,1),++e}}const i=n.mutations.map(e=>ou(t.ct,e)),e=l.fromMillis(n.localWriteTimeMs);return new _o(n.batchId,e,r,i)}function bu(e){var t=wu(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?wu(e.lastLimboFreeSnapshotVersion):E.min(),r=void 0!==e.query.documents?(y(1===(r=e.query).documents.length),Ca(Ia(tu(r.documents[0])))):Ca(lu(e.query));return new gu(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,ws.fromBase64String(e.resumeToken))}function Iu(e,t){var n=vu(t.snapshotVersion),r=vu(t.lastLimboFreeSnapshotVersion),e=(pa(t.target)?uu:hu)(e.ct,t.target),i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:ga(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:e}}function Eu(e){var t=lu({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Na(t,t.limit,"L"):t}function Tu(e,t){return new Io(t.largestBatchId,ou(e.ct,t.overlayMutation))}function Su(e,t){var n=t.path.lastSegment();return[e,Oi(t.path.popLast()),n]}function xu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:vu(r.readTime),documentKey:Oi(r.documentKey.path),largestBatchId:r.largestBatchId}}class Du{getBundleMetadata(e,t){return Cu(e).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:wu(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return Cu(e).put({bundleId:t.id,createTime:vu(O(t.createTime)),version:t.version})}getNamedQuery(e,t){return Au(e).get(t).next(e=>{if(e)return{name:e.name,query:Eu(e.bundledQuery),readTime:wu(e.readTime)}})}saveNamedQuery(e,t){return Au(e).put({name:t.name,readTime:vu(O(t.readTime)),bundledQuery:t.bundledQuery})}}function Cu(e){return hs(e,"bundles")}function Au(e){return hs(e,"namedQueries")}class Nu{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){t=t.uid||"";return new Nu(e,t)}getOverlay(e,t){return ku(e).get(Su(this.userId,t)).next(e=>e?Tu(this.serializer,e):null)}getOverlays(e,t){const n=Ga();return D.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){const i=[];return e.forEach((e,t)=>{t=new Io(r,t);i.push(this.ht(n,t))}),D.waitFor(i)}removeOverlaysForBatchId(t,e,n){const r=new Set,i=(e.forEach(e=>r.add(Oi(e.getCollectionPath()))),[]);return r.forEach(e=>{e=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);i.push(ku(t).J("collectionPathOverlayIndex",e))}),D.waitFor(i)}getOverlaysForCollection(e,t,n){const r=Ga(),i=Oi(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return ku(e).G("collectionPathOverlayIndex",s).next(e=>{for(const t of e){const e=Tu(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){const i=Ga();let s;n=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return ku(e).Z({index:"collectionGroupOverlayIndex",range:n},(e,t,n)=>{t=Tu(this.serializer,t);i.size()<r||t.largestBatchId===s?(i.set(t.getKey(),t),s=t.largestBatchId):n.done()}).next(()=>i)}ht(e,t){return ku(e).put(function(e,t,n){var[,r,i]=Su(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:au(e.ct,n.mutation)}}(this.serializer,this.userId,t))}}function ku(e){return hs(e,"documentOverlays")}class Ru{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){var n,r;"nullValue"in e?this.Et(t,5):"booleanValue"in e?(this.Et(t,10),t.dt(e.booleanValue?1:0)):"integerValue"in e?(this.Et(t,15),t.dt(N(e.integerValue))):"doubleValue"in e?(n=N(e.doubleValue),isNaN(n)?this.Et(t,13):(this.Et(t,15),Li(n)?t.dt(0):t.dt(n))):"timestampValue"in e?(r=e.timestampValue,this.Et(t,20),"string"==typeof r?t.At(r):(t.At(""+(r.seconds||"")),t.dt(r.nanos||0))):"stringValue"in e?(this.Rt(e.stringValue,t),this.Vt(t)):"bytesValue"in e?(this.Et(t,30),t.ft(Is(e.bytesValue)),this.Vt(t)):"referenceValue"in e?this.gt(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.Et(t,45),t.dt(r.latitude||0),t.dt(r.longitude||0)):"mapValue"in e?Ks(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):b()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){var n=e.fields||{};this.Et(t,55);for(const e of Object.keys(n))this.Rt(e,t),this.It(n[e],t)}wt(e,t){var n=e.values||[];this.Et(t,50);for(const e of n)this.It(e,t)}gt(e,t){this.Et(t,37),S.fromName(e).path.forEach(e=>{this.Et(t,60),this.St(e,t)})}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}}function Mu(e){e=64-function(t){let n=0;for(let e=0;e<8;++e){var r=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&t[e]);if(n+=r,8!==r)break}return n}(e);return Math.ceil(e/8)}Ru.bt=new Ru;class Lu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(e){var t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.vt(n.value),n=t.next();this.Ct()}Ft(e){var t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Mt(n.value),n=t.next();this.xt()}Ot(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.vt(e);else if(e<2048)this.vt(960|e>>>6),this.vt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.vt(480|e>>>12),this.vt(128|63&e>>>6),this.vt(128|63&e);else{const e=t.codePointAt(0);this.vt(240|e>>>18),this.vt(128|63&e>>>12),this.vt(128|63&e>>>6),this.vt(128|63&e)}}this.Ct()}Nt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Mt(e);else if(e<2048)this.Mt(960|e>>>6),this.Mt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Mt(480|e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e);else{const e=t.codePointAt(0);this.Mt(240|e>>>18),this.Mt(128|63&e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e)}}this.xt()}Bt(t){var n=this.Lt(t),t=Mu(n);this.kt(1+t),this.buffer[this.position++]=255&t;for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=255&n[e]}qt(t){var n=this.Lt(t),t=Mu(n);this.kt(1+t),this.buffer[this.position++]=~(255&t);for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=~(255&n[e])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(e){this.kt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Wt(){return this.buffer.slice(0,this.position)}Lt(e){e=e,(t=new DataView(new ArrayBuffer(8))).setFloat64(0,e,!1);var t,n=new Uint8Array(t.buffer),r=0!=(128&n[0]);n[0]^=r?255:128;for(let e=1;e<n.length;++e)n[e]^=r?255:0;return n}vt(e){e&=255;0==e?(this.Kt(0),this.Kt(255)):255==e?(this.Kt(255),this.Kt(0)):this.Kt(e)}Mt(e){var t=255&e;0==t?(this.Ut(0),this.Ut(255)):255==t?(this.Ut(255),this.Ut(0)):this.Ut(e)}Ct(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(e){this.kt(1),this.buffer[this.position++]=e}Ut(e){this.kt(1),this.buffer[this.position++]=~e}kt(t){t+=this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);t=new Uint8Array(e);t.set(this.buffer),this.buffer=t}}}class Fu{constructor(e){this.Gt=e}ft(e){this.Gt.Dt(e)}At(e){this.Gt.Ot(e)}dt(e){this.Gt.Bt(e)}Tt(){this.Gt.Qt()}}class Ou{constructor(e){this.Gt=e}ft(e){this.Gt.Ft(e)}At(e){this.Gt.Nt(e)}dt(e){this.Gt.qt(e)}Tt(){this.Gt.$t()}}class Pu{constructor(){this.Gt=new Lu,this.zt=new Fu(this.Gt),this.jt=new Ou(this.Gt)}seed(e){this.Gt.seed(e)}Ht(e){return 0===e?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class Vu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Jt(){var e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Vu(this.indexId,this.documentKey,this.arrayValue,n)}}function Uu(e,t){var n=e.indexId-t.indexId;return 0!=n||0!==(n=Bu(e.arrayValue,t.arrayValue))||0!==(n=Bu(e.directionalValue,t.directionalValue))?n:S.comparator(e.documentKey,t.documentKey)}function Bu(t,n){for(let e=0;e<t.length&&e<n.length;++e){var r=t[e]-n[e];if(0!=r)return r}return t.length-n.length}class qu{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Yt=e.orderBy,this.Zt=[];for(const t of e.filters){const e=t;e.isInequality()?this.Xt=e:this.Zt.push(e)}}en(e){y(e.collectionGroup===this.collectionId);var t=li(e);if(void 0!==t&&!this.tn(t))return!1;var n=ci(e);let r=new Set,i=0,s=0;for(;i<n.length&&this.tn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i!==n.length){if(void 0!==this.Xt){if(!r.has(this.Xt.field.canonicalString())){const e=n[i];if(!this.nn(this.Xt,e)||!this.rn(this.Yt[s++],e))return!1}++i}for(;i<n.length;++i){const e=n[i];if(s>=this.Yt.length||!this.rn(this.Yt[s++],e))return!1}}return!0}tn(e){for(const t of this.Zt)if(this.nn(t,e))return!0;return!1}nn(e,t){return!(void 0===e||!e.field.isEqual(t.fieldPath))&&(e="array-contains"===e.op||"array-contains-any"===e.op,2===t.kind==e)}rn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Gu(e){return e instanceof R}function Ku(e){return e instanceof M&&ea(e)}function ju(e){return Gu(e)||Ku(e)||function(e){if(e instanceof M&&Zs(e)){for(const t of e.getFilters())if(!Gu(t)&&!Ku(t))return!1;return!0}return!1}(e)}function zu(e,t){var n,r;return y(e instanceof R||e instanceof M),y(t instanceof R||t instanceof M),Qu(e instanceof R?t instanceof R?(n=e,r=t,M.create([n,r],"and")):$u(e,t):t instanceof R?$u(t,e):function(e,t){if(y(0<e.filters.length&&0<t.filters.length),Js(e)&&Js(t))return na(e,t.getFilters());const n=Zs(e)?e:t,r=Zs(e)?t:e,i=n.filters.map(e=>zu(e,r));return M.create(i,"or")}(e,t))}function $u(t,e){return Js(e)?na(e,t.getFilters()):(e=e.filters.map(e=>zu(t,e)),M.create(e,"or"))}function Qu(t){if(y(t instanceof R||t instanceof M),t instanceof R)return t;var e=t.getFilters();if(1===e.length)return Qu(e[0]);if(ta(t))return t;const n=e.map(e=>Qu(e)),r=[];return n.forEach(e=>{e instanceof R?r.push(e):e instanceof M&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:M.create(r,t.op)}class Hu{constructor(){this.sn=new Wu}addToCollectionParentIndex(e,t){return this.sn.add(t),D.resolve()}getCollectionParents(e,t){return D.resolve(this.sn.getEntries(t))}addFieldIndex(e,t){return D.resolve()}deleteFieldIndex(e,t){return D.resolve()}getDocumentsMatchingTarget(e,t){return D.resolve(null)}getIndexType(e,t){return D.resolve(0)}getFieldIndexes(e,t){return D.resolve([])}getNextCollectionGroupToUpdate(e){return D.resolve(null)}getMinOffset(e,t){return D.resolve(pi.min())}getMinOffsetFromCollectionGroup(e,t){return D.resolve(pi.min())}updateCollectionGroup(e,t,n){return D.resolve()}updateIndexEntries(e,t){return D.resolve()}}class Wu{constructor(){this.index={}}add(e){var t=e.lastSegment(),e=e.popLast(),n=this.index[t]||new A(T.comparator),r=!n.has(e);return this.index[t]=n.add(e),r}has(e){var t=e.lastSegment(),e=e.popLast(),t=this.index[t];return t&&t.has(e)}getEntries(e){return(this.index[e]||new A(T.comparator)).toArray()}}const Yu=new Uint8Array(0);class Xu{constructor(e,t){this.user=e,this.databaseId=t,this.on=new Wu,this._n=new Pa(e=>ga(e),(e,t)=>ma(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){var n,r;return this.on.has(t)?D.resolve():(n=t.lastSegment(),r=t.popLast(),e.addOnCommittedListener(()=>{this.on.add(t)}),r={collectionId:n,parent:Oi(r)},Ju(e).put(r))}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[ai(n),""],!1,!0);return Ju(e).G(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Vi(t.parent))}return r})}addFieldIndex(e,t){const n=eh(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;var i=n.add(r);if(t.indexState){const n=th(e);return i.next(e=>{n.put(xu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){const n=eh(e),r=th(e),i=Zu(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,h){const l=Zu(e);let c=!0;const n=new Map;return D.forEach(this.an(h),t=>this.un(e,t).next(e=>{c=c&&!!e,n.set(t,e)})).next(()=>{if(c){let u=L();const c=[];return D.forEach(n,(e,t)=>{m("IndexedDbIndexManager",`Using index ${n=e,`id=${n.indexId}|cg=${n.collectionGroup}|f=`+n.fields.map(e=>e.fieldPath+":"+e.kind).join(",")} to execute `+ga(h));var n=function(e,t){var n=li(t);if(void 0!==n)for(const t of ya(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){var n=new Map;for(const r of ci(t))for(const t of ya(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),i=function(e,t){var n=[];let r=!0;for(const i of ci(t)){const t=(0===i.kind?va:wa)(e,i.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Qs(n,r)}(t,e),s=function(e,t){var n=[];let r=!0;for(const i of ci(t)){const t=(0===i.kind?wa:va)(e,i.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Qs(n,r)}(t,e),a=this.cn(e,t,i),o=this.cn(e,t,s),r=this.ln(e,t,r),r=this.hn(e.indexId,n,a,i.inclusive,o,s.inclusive,r);return D.forEach(r,e=>l.H(e,h.limit).next(e=>{e.forEach(e=>{e=S.fromSegments(e.documentKey);u.has(e)||(u=u.add(e),c.push(e))})}))}).next(()=>c)}return D.resolve(null)})}an(t){var e;return this._n.get(t)||(e=0===t.filters.length?[t]:(0===(e=M.create(t.filters,"and")).getFilters().length?[]:(e=function t(e){var n;return y(e instanceof R||e instanceof M),e instanceof R?e:1===e.filters.length?t(e.filters[0]):(n=e.filters.map(e=>t(e)),ju(n=Qu(n=M.create(n,e.op)))?n:(y(n instanceof M),y(Js(n)),y(1<n.filters.length),n.filters.reduce((e,t)=>zu(e,t))))}(function t(n){var e;if(y(n instanceof R||n instanceof M),n instanceof R){if(n instanceof ha){const r=(null==(e=null==(e=n.value.arrayValue)?void 0:e.values)?void 0:e.map(e=>R.create(n.field,"==",e)))||[];return M.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return M.create(r,n.op)}(e)),y(ju(e)),Gu(e)||Ku(e)?[e]:e.getFilters())).map(e=>fa(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this._n.set(t,e),e)}hn(t,n,r,i,s,a,o){const u=(null!=n?n.length:1)*Math.max(r.length,s.length),h=u/(null!=n?n.length:1),l=[];for(let e=0;e<u;++e){const u=n?this.Pn(n[e/h]):Yu,c=this.In(t,u,r[e%h],i),d=this.Tn(t,u,s[e%h],a),f=o.map(e=>this.In(t,u,e,!0));l.push(...this.createRange(c,d,f))}return l}In(e,t,n,r){e=new Vu(e,S.empty(),t,n);return r?e:e.Jt()}Tn(e,t,n,r){e=new Vu(e,S.empty(),t,n);return r?e.Jt():e}un(e,t){const r=new qu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.en(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.an(t);return D.forEach(r,t=>this.un(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new A(f.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&1<r.length&&2===n?1:n)}En(e,t){var n=new Pu;for(const i of ci(e)){const e=t.data.field(i.fieldPath);if(null==e)return null;var r=n.Ht(i.kind);Ru.bt.Pt(e,r)}return n.Wt()}Pn(e){var t=new Pu;return Ru.bt.Pt(e,t.Ht(0)),t.Wt()}dn(e,t){var n=new Pu;return Ru.bt.Pt(Os(this.databaseId,t),n.Ht(0===(t=ci(e)).length?0:t[t.length-1].kind)),n.Wt()}ln(e,t,n){if(null===n)return[];let r=[],i=(r.push(new Pu),0);for(const s of ci(e)){const e=n[i++];for(const n of r)if(this.An(t,s.fieldPath)&&Vs(e))r=this.Rn(r,s,e);else{const t=n.Ht(s.kind);Ru.bt.Pt(e,t)}}return this.Vn(r)}cn(e,t,n){return this.ln(e,t,n.position)}Vn(t){var n=[];for(let e=0;e<t.length;++e)n[e]=t[e].Wt();return n}Rn(e,t,n){const r=[...e],i=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new Pu;r.seed(n.Wt()),Ru.bt.Pt(e,r.Ht(t.kind)),i.push(r)}return i}An(e,t){return!!e.filters.find(e=>e instanceof R&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=eh(e),s=th(e);return(t?n.G("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.G()).next(e=>{const i=[];return D.forEach(e,r=>s.get([r.indexId,this.uid]).next(e=>{var t,n;i.push((t=r,e=e?new fi(e.sequenceNumber,new pi(wu(e.readTime),new S(Vi(e.documentKey)),e.largestBatchId)):fi.empty(),n=t.fields.map(([e,t])=>new di(f.fromServerFormat(e),t)),new hi(t.indexId,t.collectionGroup,n,e)))})).next(()=>i)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:I(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const i=eh(e),s=th(e);return this.mn(e).next(t=>i.G("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>D.forEach(e,e=>s.put(xu(e.indexId,this.user,t,r)))))}updateIndexEntries(i,e){const n=new Map;return D.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?D.resolve(e):this.getFieldIndexes(i,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),D.forEach(e,n=>this.fn(i,t,n).next(e=>{var t=this.gn(r,n);return e.isEqual(t)?D.resolve():this.pn(i,r,n,e,t)}))))})}yn(e,t,n,r){return Zu(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.dn(n,t.key),documentKey:t.key.path.toArray()})}wn(e,t,n,r){return Zu(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.dn(n,t.key),t.key.path.toArray()])}fn(e,n,r){e=Zu(e);let i=new A(Uu);return e.Z({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.dn(r,n)])},(e,t)=>{i=i.add(new Vu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>i)}gn(e,t){let n=new A(Uu);var r=this.En(t,e);if(null!=r){const s=li(t);if(null!=s){var i=e.data.field(s.fieldPath);if(Vs(i))for(const s of i.arrayValue.values||[])n=n.add(new Vu(t.indexId,e.key,this.Pn(s),r))}else n=n.add(new Vu(t.indexId,e.key,Yu,r))}return n}pn(t,i,s,e,a){m("IndexedDbIndexManager","Updating index entries for document '%s'",i.key);const o=[];{var u=Uu,h=e=>{o.push(this.yn(t,i,s,e))},l=e=>{o.push(this.wn(t,i,s,e))},c=e.getIterator(),d=a.getIterator();let n=ps(c),r=ps(d);for(;n||r;){let e=!1,t=!1;if(n&&r){const h=u(n,r);h<0?t=!0:0<h&&(e=!0)}else null!=n?t=!0:e=!0;e?(h(r),r=ps(d)):t?(l(n),n=ps(c)):(n=ps(c),r=ps(d))}}return D.waitFor(o)}mn(e){let r=1;return th(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>Uu(e,t)).filter((e,t,n)=>!t||0!==Uu(e,n[t-1]));var r=[];r.push(e);for(const i of n){const n=Uu(i,e),s=Uu(i,t);if(0===n)r[0]=e.Jt();else if(0<n&&s<0)r.push(i),r.push(i.Jt());else if(0<s)break}r.push(t);const i=[];for(let e=0;e<r.length;e+=2){if(this.Sn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,Yu,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,Yu,[]];i.push(IDBKeyRange.bound(t,n))}return i}Sn(e,t){return 0<Uu(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(nh)}getMinOffset(t,e){return D.mapArray(this.an(e),e=>this.un(t,e).next(e=>e||b())).next(nh)}}function Ju(e){return hs(e,"collectionParents")}function Zu(e){return hs(e,"indexEntries")}function eh(e){return hs(e,"indexConfiguration")}function th(e){return hs(e,"indexState")}function nh(t){y(0!==t.length);let n=t[0].indexState.offset,r=n.largestBatchId;for(let e=1;e<t.length;e++){var i=t[e].indexState.offset;yi(i,n)<0&&(n=i),r<i.largestBatchId&&(r=i.largestBatchId)}return new pi(n.readTime,n.documentKey,r)}const rh={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class ih{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new ih(e,ih.DEFAULT_COLLECTION_PERCENTILE,ih.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function sh(e,t,n){const r=e.store("mutations"),i=e.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId);let o=0;e=r.Z({range:a},(e,t,n)=>(o++,n.delete()));s.push(e.next(()=>{y(1===o)}));const u=[];for(const e of n.mutations){const r=qi(t,e.key.path,n.batchId);s.push(i.delete(r)),u.push(e.key)}return D.waitFor(s).next(()=>u)}function ah(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw b();t=e.noDocument}return JSON.stringify(t).length}ih.DEFAULT_COLLECTION_PERCENTILE=10,ih.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,ih.DEFAULT=new ih(41943040,ih.DEFAULT_COLLECTION_PERCENTILE,ih.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),ih.DISABLED=new ih(-1,0,0);class oh{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.bn={}}static lt(e,t,n,r){y(""!==e.uid);e=e.isAuthenticated()?e.uid:"";return new oh(e,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return hh(e).Z({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(l,c,d,f){const g=lh(l),m=hh(l);return m.add({}).next(e=>{y("number"==typeof e);const t=new _o(e,c,d,f),n=(i=this.serializer,s=this.userId,o=(a=t).baseMutations.map(e=>au(i.ct,e)),u=a.mutations.map(e=>au(i.ct,e)),{userId:s,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var i,s,a,o,u;let h=new A((e,t)=>I(e.canonicalString(),t.canonicalString()));for(const l of f){const c=qi(this.userId,l.key.path,e);h=h.add(l.key.path.popLast()),r.push(m.put(n)),r.push(g.put(c,Gi))}return h.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(l,e))}),l.addOnCommittedListener(()=>{this.bn[e]=t.keys()}),D.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return hh(e).get(t).next(e=>e?(y(e.userId===this.userId),_u(this.serializer,e)):null)}Dn(e,t){return this.bn[t]?D.resolve(this.bn[t]):this.lookupMutationBatch(e,t).next(e=>{return e?(e=e.keys(),this.bn[t]=e):null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let i=null;return hh(e).Z({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(y(t.batchId>=r),i=_u(this.serializer,t)),n.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return hh(e).Z({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return hh(e).G("userMutationsIndex",t).next(e=>e.map(e=>_u(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(s,a){const e=Bi(this.userId,a.path),t=IDBKeyRange.lowerBound(e),o=[];return lh(s).Z({range:t},(e,t,n)=>{var[e,r,i]=e,r=Vi(r);if(e===this.userId&&a.path.isEqual(r))return hh(s).get(i).next(e=>{if(!e)throw b();y(e.userId===this.userId),o.push(_u(this.serializer,e))});n.done()}).next(()=>o)}getAllMutationBatchesAffectingDocumentKeys(t,e){let a=new A(I);const n=[];return e.forEach(s=>{var e=Bi(this.userId,s.path),e=IDBKeyRange.lowerBound(e),e=lh(t).Z({range:e},(e,t,n)=>{var[e,r,i]=e,r=Vi(r);e===this.userId&&s.path.isEqual(r)?a=a.add(i):n.done()});n.push(e)}),D.waitFor(n).next(()=>this.vn(t,a))}getAllMutationBatchesAffectingQuery(e,t){const s=t.path,a=s.length+1,n=Bi(this.userId,s),r=IDBKeyRange.lowerBound(n);let o=new A(I);return lh(e).Z({range:r},(e,t,n)=>{var[e,r,i]=e,r=Vi(r);e===this.userId&&s.isPrefixOf(r)?r.length===a&&(o=o.add(i)):n.done()}).next(()=>this.vn(e,o))}vn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(hh(t).get(e).next(e=>{if(null===e)throw b();y(e.userId===this.userId),n.push(_u(this.serializer,e))}))}),D.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return sh(t.ue,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.Cn(n.batchId)}),D.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}Cn(e){delete this.bn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return D.resolve();const t=IDBKeyRange.lowerBound([this.userId]),r=[];return lh(n).Z({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Vi(e[1]);r.push(t)}else n.done()}).next(()=>{y(0===r.length)})})}containsKey(e,t){return uh(e,this.userId,t)}Fn(e){return ch(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function uh(e,i,t){const n=Bi(i,t.path),s=n[1],r=IDBKeyRange.lowerBound(n);let a=!1;return lh(e).Z({range:r,Y:!0},(e,t,n)=>{var[e,r]=e;e===i&&r===s&&(a=!0),n.done()}).next(()=>a)}function hh(e){return hs(e,"mutations")}function lh(e){return hs(e,"documentMutations")}function ch(e){return hs(e,"mutationQueues")}class dh{constructor(e){this.Mn=e}next(){return this.Mn+=2,this.Mn}static xn(){return new dh(0)}static On(){return new dh(-1)}}class fh{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(n){return this.Nn(n).next(e=>{var t=new dh(e.highestTargetId);return e.highestTargetId=t.next(),this.Bn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Nn(e).next(e=>E.fromTimestamp(new l(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Nn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Nn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Bn(t,e)))}addTargetData(t,n){return this.Ln(t,n).next(()=>this.Nn(t).next(e=>(e.targetCount+=1,this.kn(n,e),this.Bn(t,e))))}updateTargetData(e,t){return this.Ln(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>gh(t).delete(e.targetId)).next(()=>this.Nn(t)).next(e=>(y(0<e.targetCount),--e.targetCount,this.Bn(t,e)))}removeTargets(n,r,i){let s=0;const a=[];return gh(n).Z((e,t)=>{t=bu(t);t.sequenceNumber<=r&&null===i.get(t.targetId)&&(s++,a.push(this.removeTargetData(n,t)))}).next(()=>D.waitFor(a)).next(()=>s)}forEachTarget(e,n){return gh(e).Z((e,t)=>{t=bu(t);n(t)})}Nn(e){return mh(e).get("targetGlobalKey").next(e=>(y(null!==e),e))}Bn(e,t){return mh(e).put("targetGlobalKey",t)}Ln(e,t){return gh(e).put(Iu(this.serializer,t))}kn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Nn(e).next(e=>e.targetCount)}getTargetData(e,r){var t=ga(r),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let i=null;return gh(e).Z({range:t,index:"queryTargetsIndex"},(e,t,n)=>{t=bu(t);ma(r,t.target)&&(i=t,n.done())}).next(()=>i)}addMatchingKeys(n,e,r){const i=[],s=ph(n);return e.forEach(e=>{var t=Oi(e.path);i.push(s.put({targetId:r,path:t})),i.push(this.referenceDelegate.addReference(n,r,e))}),D.waitFor(i)}removeMatchingKeys(n,e,r){const i=ph(n);return D.forEach(e,e=>{var t=Oi(e.path);return D.waitFor([i.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){e=ph(e),t=IDBKeyRange.bound([t],[t+1],!1,!0);return e.delete(t)}getMatchingKeysForTargetId(e,t){t=IDBKeyRange.bound([t],[t+1],!1,!0),e=ph(e);let r=L();return e.Z({range:t,Y:!0},(e,t,n)=>{e=Vi(e[1]),e=new S(e);r=r.add(e)}).next(()=>r)}containsKey(e,t){t=Oi(t.path),t=IDBKeyRange.bound([t],[ai(t)],!1,!0);let r=0;return ph(e).Z({index:"documentTargetsIndex",Y:!0,range:t},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}ut(e,t){return gh(e).get(t).next(e=>e?bu(e):null)}}function gh(e){return hs(e,"targets")}function mh(e){return hs(e,"targetGlobal")}function ph(e){return hs(e,"targetDocuments")}function yh([e,t],[n,r]){e=I(e,n);return 0===e?I(t,r):e}class vh{constructor(e){this.qn=e,this.buffer=new A(yh),this.Qn=0}Kn(){return++this.Qn}$n(e){var t=[e,this.Kn()];if(this.buffer.size<this.qn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();yh(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class wh{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Un=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Wn(6e4)}stop(){this.Un&&(this.Un.cancel(),this.Un=null)}get started(){return null!==this.Un}Wn(e){m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Un=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Un=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Si(e)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await _i(e)}await this.Wn(3e5)})}}class _h{constructor(e,t){this.Gn=e,this.params=t}calculateTargetCount(e,t){return this.Gn.zn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return D.resolve(Ri.ae);const n=new vh(t);return this.Gn.forEachTarget(e,e=>n.$n(e.sequenceNumber)).next(()=>this.Gn.jn(e,e=>n.$n(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Gn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Gn.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),D.resolve(rh)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold `+this.params.cacheSizeCollectionThreshold),rh):this.Hn(t,n))}getCacheSize(e){return this.Gn.getCacheSize(e)}Hn(t,n){let r,i,s,a,o,u,h;const l=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(i=e>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from `+e),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,i))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(s=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(h=Date.now(),$r()<=c.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-l}ms
	Determined least recently used ${i} in `+(o-a)+"ms\n"+`	Removed ${s} targets in `+(u-o)+"ms\n"+`	Removed ${e} documents in `+(h-u)+"ms\n"+`Total Duration: ${h-l}ms`),D.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:e})))}}class bh{constructor(e,t){this.db=e,this.garbageCollector=(e=this,new _h(e,t))}zn(e){const n=this.Jn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Jn(e){let t=0;return this.jn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}jn(e,n){return this.Yn(e,(e,t)=>n(t))}addReference(e,t,n){return Ih(e,n)}removeReference(e,t,n){return Ih(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Ih(e,t)}Zn(t,n){let r=!1;return ch(t).X(e=>uh(t,e,n).next(e=>(e&&(r=!0),D.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const i=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let a=0;return this.Yn(n,(t,e)=>{if(e<=r){const r=this.Zn(n,t).next(e=>{if(!e)return a++,i.getEntry(n,t).next(()=>(i.removeEntry(t,E.min()),ph(n).delete([0,Oi(t.path)])))});s.push(r)}}).next(()=>D.waitFor(s)).next(()=>i.apply(n)).next(()=>a)}removeTarget(e,t){t=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,t)}updateLimboDocument(e,t){return Ih(e,t)}Yn(e,r){e=ph(e);let i,s=Ri.ae;return e.Z({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(s!==Ri.ae&&r(new S(Vi(i)),s),s=n,i=t):s=Ri.ae}).next(()=>{s!==Ri.ae&&r(new S(Vi(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Ih(e,t){return ph(e).put((e=e.currentSequenceNumber,{targetId:0,path:Oi(t.path),sequenceNumber:e}))}class Eh{constructor(){this.changes=new Pa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,k.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?D.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Th{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Ch(e).put(n)}removeEntry(e,t,n){return Ch(e).delete((e=n,[(n=t.path.toArray()).slice(0,n.length-2),n[n.length-2],yu(e),n[n.length-1]]))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.Xn(t,e)))}getEntry(e,n){let r=k.newInvalidDocument(n);return Ch(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Ah(n))},(e,t)=>{r=this.er(n,t)}).next(()=>r)}tr(e,n){let r={size:0,document:k.newInvalidDocument(n)};return Ch(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Ah(n))},(e,t)=>{r={document:this.er(n,t),size:ah(t)}}).next(()=>r)}getEntries(e,t){let n=Va;return this.nr(e,t,(e,t)=>{t=this.er(e,t);n=n.insert(e,t)}).next(()=>n)}rr(e,t){let r=Va,i=new C(S.comparator);return this.nr(e,t,(e,t)=>{var n=this.er(e,t);r=r.insert(e,n),i=i.insert(e,ah(t))}).next(()=>({documents:r,ir:i}))}nr(e,t,i){if(t.isEmpty())return D.resolve();let n=new A(kh);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(Ah(n.first()),Ah(n.last())),s=n.getIterator();let a=s.getNext();return Ch(e).Z({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=S.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&kh(a,r)<0;)i(a,null),a=s.getNext();a&&a.isEqual(r)&&(i(a,t),a=s.hasNext()?s.getNext():null),a?n.W(Ah(a)):n.done()}).next(()=>{for(;a;)i(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,r,t,i){var n=r.path,t=[n.popLast().toArray(),n.lastSegment(),yu(t.readTime),t.documentKey.path.isEmpty()?"":t.documentKey.path.lastSegment()],n=[n.popLast().toArray(),n.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Ch(e).G(IDBKeyRange.bound(t,n,!0)).next(e=>{let t=Va;for(const n of e){const e=this.er(S.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);e.isFoundDocument()&&(La(r,e)||i.has(e.key))&&(t=t.insert(e.key,e))}return t})}getAllFromCollectionGroup(e,t,n,r){let i=Va;n=Nh(t,n),t=Nh(t,pi.max());return Ch(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(n,t,!0)},(e,t,n)=>{t=this.er(S.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(t.key,t)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new xh(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Dh(e).get("remoteDocumentGlobalKey").next(e=>(y(!!e),e))}Xn(e,t){return Dh(e).put("remoteDocumentGlobalKey",t)}er(e,t){if(t){const e=function(e,t){let n;if(t.document)n=su(e.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=S.fromSegments(t.noDocument.path),r=wu(t.noDocument.readTime);n=k.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return b();{const e=S.fromSegments(t.unknownDocument.path),i=wu(t.unknownDocument.version);n=k.newUnknownDocument(e,i)}}return t.readTime&&n.setReadTime((t=t.readTime,e=new l(t[0],t[1]),E.fromTimestamp(e))),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(E.min()))return e}return k.newInvalidDocument(e)}}function Sh(e){return new Th(e)}class xh extends Eh{constructor(e,t){super(),this.sr=e,this.trackRemovals=t,this._r=new Pa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(s){const a=[];let o=0,u=new A((e,t)=>I(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this._r.get(e);if(a.push(this.sr.removeEntry(s,e,n.readTime)),t.isValidDocument()){var r=pu(this.sr.serializer,t),i=(u=u.add(e.path.popLast()),ah(r));o+=i-n.size,a.push(this.sr.addEntry(s,e,r))}else if(o-=n.size,this.trackRemovals){const o=pu(this.sr.serializer,t.convertToNoDocument(E.min()));a.push(this.sr.addEntry(s,e,o))}}),u.forEach(e=>{a.push(this.sr.indexManager.addToCollectionParentIndex(s,e))}),a.push(this.sr.updateMetadata(s,o)),D.waitFor(a)}getFromCache(e,t){return this.sr.tr(e,t).next(e=>(this._r.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.sr.rr(e,t).next(({documents:n,ir:e})=>(e.forEach((e,t)=>{this._r.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Dh(e){return hs(e,"remoteDocumentGlobal")}function Ch(e){return hs(e,"remoteDocumentsV14")}function Ah(e){e=e.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Nh(e,t){var n=t.documentKey.path.toArray();return[e,yu(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function kh(e,t){var n=e.path.toArray(),r=t.path.toArray();let i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=I(n[e],r[e]))return i;return(i=I(n.length,r.length))||(i=I(n[n.length-2],r[r.length-2]))||I(n[n.length-1],r[r.length-1])}class Rh{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Mh{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&lo(r.mutation,e,ys.empty(),l.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,L()).next(()=>e))}getLocalViewOfDocuments(e,t,n=L()){const r=Ga();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=Ba();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=Ga();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,L()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,i){let s=Va;const a=Ga(),n=Ga();return t.forEach((e,t)=>{var n=r.get(t.key);i.has(t.key)&&(void 0===n||n.mutation instanceof go)?s=s.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),lo(n.mutation,t,n.mutation.getFieldMask(),l.now())):a.set(t.key,ys.empty())}),this.recalculateAndSaveOverlays(e,s).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{return n.set(e,new Rh(t,null!=(t=a.get(e))?t:null))}),n))}recalculateAndSaveOverlays(s,a){const o=Ga();let u=new C((e,t)=>e-t),h=L();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(s,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||ys.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||L()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{for(var e=[],t=u.getReverseIterator();t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,i=Ga();r.forEach(e=>{var t;h.has(e)||(null!==(t=ho(a.get(e),o.get(e)))&&i.set(e,t),h=h.add(e))}),e.push(this.documentOverlayCache.saveOverlays(s,n,i))}return D.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n){return r=t,S.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):xa(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n);var r}getNextDocuments(s,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(s,t,a,o).next(n=>{var e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(s,t,a.largestBatchId,o-n.size):D.resolve(Ga());let r=-1,i=n;return e.next(e=>D.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?D.resolve():this.remoteDocumentCache.getEntry(s,t).next(e=>{i=i.insert(t,e)}))).next(()=>this.populateOverlays(s,e,n)).next(()=>this.computeViews(s,i,e,L())).next(e=>({batchId:r,changes:qa(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new S(t)).next(e=>{let t=Ba();return t=e.isFoundDocument()?t.insert(e.key,e):t})}getDocumentsMatchingCollectionGroupQuery(n,r,i){const s=r.collectionGroup;let a=Ba();return this.indexManager.getCollectionParents(n,s).next(e=>D.forEach(e,e=>{t=r,e=e.child(s);var t,e=new _a(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(n,e,i).next(e=>{e.forEach((e,t)=>{a=a.insert(e,t)})})}).next(()=>a))}getDocumentsMatchingCollectionQuery(t,i,n){let s;return this.documentOverlayCache.getOverlaysForCollection(t,i.path,n.largestBatchId).next(e=>(s=e,this.remoteDocumentCache.getDocumentsMatchingQuery(t,i,n,s))).next(n=>{s.forEach((e,t)=>{t=t.getKey();null===n.get(t)&&(n=n.insert(t,k.newInvalidDocument(t)))});let r=Ba();return n.forEach((e,t)=>{var n=s.get(e);void 0!==n&&lo(n.mutation,t,ys.empty(),l.now()),La(i,t)&&(r=r.insert(e,t))}),r})}}class Lh{constructor(e){this.serializer=e,this.ar=new Map,this.ur=new Map}getBundleMetadata(e,t){return D.resolve(this.ar.get(t))}saveBundleMetadata(e,t){return this.ar.set(t.id,{id:t.id,version:t.version,createTime:O(t.createTime)}),D.resolve()}getNamedQuery(e,t){return D.resolve(this.ur.get(t))}saveNamedQuery(e,t){return this.ur.set(t.name,{name:t.name,query:Eu(t.bundledQuery),readTime:O(t.readTime)}),D.resolve()}}class Fh{constructor(){this.overlays=new C(S.comparator),this.cr=new Map}getOverlay(e,t){return D.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Ga();return D.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.ht(n,r,t)}),D.resolve()}removeOverlaysForBatchId(e,t,n){var r=this.cr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.cr.delete(n)),D.resolve()}getOverlaysForCollection(e,t,n){const r=Ga(),i=t.length+1,s=new S(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return D.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let i=new C((e,t)=>e-t);for(var s=this.overlays.getIterator();s.hasNext();){const t=s.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=i.get(t.largestBatchId);null===e&&(e=Ga(),i=i.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=Ga(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return D.resolve(a)}ht(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.cr.get(r.largestBatchId).delete(n.key);this.cr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Io(t,n));let i=this.cr.get(t);void 0===i&&(i=L(),this.cr.set(t,i)),this.cr.set(t,i.add(n.key))}}class Oh{constructor(){this.lr=new A(Ph.hr),this.Pr=new A(Ph.Ir)}isEmpty(){return this.lr.isEmpty()}addReference(e,t){e=new Ph(e,t);this.lr=this.lr.add(e),this.Pr=this.Pr.add(e)}Tr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Er(new Ph(e,t))}dr(e,t){e.forEach(e=>this.removeReference(e,t))}Ar(e){const t=new S(new T([])),n=new Ph(t,e),r=new Ph(t,e+1),i=[];return this.Pr.forEachInRange([n,r],e=>{this.Er(e),i.push(e.key)}),i}Rr(){this.lr.forEach(e=>this.Er(e))}Er(e){this.lr=this.lr.delete(e),this.Pr=this.Pr.delete(e)}Vr(e){var t=new S(new T([])),n=new Ph(t,e),t=new Ph(t,e+1);let r=L();return this.Pr.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Ph(e,0);return null!==(t=this.lr.firstAfterOrEqual(t))&&e.isEqual(t.key)}}class Ph{constructor(e,t){this.key=e,this.mr=t}static hr(e,t){return S.comparator(e.key,t.key)||I(e.mr,t.mr)}static Ir(e,t){return I(e.mr,t.mr)||S.comparator(e.key,t.key)}}class Vh{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.gr=1,this.pr=new A(Ph.hr)}checkEmpty(e){return D.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var i=this.gr,t=(this.gr++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1],new _o(i,t,n,r));this.mutationQueue.push(t);for(const t of r)this.pr=this.pr.add(new Ph(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return D.resolve(t)}lookupMutationBatch(e,t){return D.resolve(this.yr(t))}getNextMutationBatchAfterBatchId(e,t){t=(t=this.wr(t+1))<0?0:t;return D.resolve(this.mutationQueue.length>t?this.mutationQueue[t]:null)}getHighestUnacknowledgedBatchId(){return D.resolve(0===this.mutationQueue.length?-1:this.gr-1)}getAllMutationBatches(e){return D.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Ph(t,0),r=new Ph(t,Number.POSITIVE_INFINITY),i=[];return this.pr.forEachInRange([n,r],e=>{e=this.yr(e.mr);i.push(e)}),D.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new A(I);return t.forEach(e=>{var t=new Ph(e,0),e=new Ph(e,Number.POSITIVE_INFINITY);this.pr.forEachInRange([t,e],e=>{n=n.add(e.mr)})}),D.resolve(this.Sr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;S.isDocumentKey(i)||(i=i.child(""));t=new Ph(new S(i),0);let s=new A(I);return this.pr.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(s=s.add(e.mr)),!0)},t),D.resolve(this.Sr(s))}Sr(e){const t=[];return e.forEach(e=>{e=this.yr(e);null!==e&&t.push(e)}),t}removeMutationBatch(n,r){y(0===this.br(r.batchId,"removed")),this.mutationQueue.shift();let i=this.pr;return D.forEach(r.mutations,e=>{var t=new Ph(e.key,r.batchId);return i=i.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.pr=i})}Cn(e){}containsKey(e,t){var n=new Ph(t,0),n=this.pr.firstAfterOrEqual(n);return D.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,D.resolve()}br(e,t){return this.wr(e)}wr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}yr(e){e=this.wr(e);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class Uh{constructor(e){this.Dr=e,this.docs=new C(S.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){var n=t.key,r=this.docs.get(n),r=r?r.size:0,i=this.Dr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){var n=this.docs.get(t);return D.resolve(n?n.document.mutableCopy():k.newInvalidDocument(t))}getEntries(e,t){let n=Va;return t.forEach(e=>{var t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():k.newInvalidDocument(e))}),D.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Va;const s=t.path,a=new S(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||yi(mi(a),n)<=0||(r.has(a.key)||La(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return D.resolve(i)}getAllFromCollectionGroup(e,t,n,r){b()}vr(e,t){return D.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Bh(this)}getSize(e){return D.resolve(this.size)}}class Bh extends Eh{constructor(e){super(),this.sr=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.sr.addEntry(n,t)):this.sr.removeEntry(e)}),D.waitFor(r)}getFromCache(e,t){return this.sr.getEntry(e,t)}getAllFromCache(e,t){return this.sr.getEntries(e,t)}}class qh{constructor(e){this.persistence=e,this.Cr=new Pa(e=>ga(e),ma),this.lastRemoteSnapshotVersion=E.min(),this.highestTargetId=0,this.Fr=0,this.Mr=new Oh,this.targetCount=0,this.Or=dh.xn()}forEachTarget(e,n){return this.Cr.forEach((e,t)=>n(t)),D.resolve()}getLastRemoteSnapshotVersion(e){return D.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return D.resolve(this.Fr)}allocateTargetId(e){return this.highestTargetId=this.Or.next(),D.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Fr&&(this.Fr=t),D.resolve()}Ln(e){this.Cr.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Or=new dh(t),this.highestTargetId=t),e.sequenceNumber>this.Fr&&(this.Fr=e.sequenceNumber)}addTargetData(e,t){return this.Ln(t),this.targetCount+=1,D.resolve()}updateTargetData(e,t){return this.Ln(t),D.resolve()}removeTargetData(e,t){return this.Cr.delete(t.target),this.Mr.Ar(t.targetId),--this.targetCount,D.resolve()}removeTargets(n,r,i){let s=0;const a=[];return this.Cr.forEach((e,t)=>{t.sequenceNumber<=r&&null===i.get(t.targetId)&&(this.Cr.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),s++)}),D.waitFor(a).next(()=>s)}getTargetCount(e){return D.resolve(this.targetCount)}getTargetData(e,t){t=this.Cr.get(t)||null;return D.resolve(t)}addMatchingKeys(e,t,n){return this.Mr.Tr(t,n),D.resolve()}removeMatchingKeys(t,e,n){this.Mr.dr(e,n);const r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(e=>{i.push(r.markPotentiallyOrphaned(t,e))}),D.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Mr.Ar(t),D.resolve()}getMatchingKeysForTargetId(e,t){t=this.Mr.Vr(t);return D.resolve(t)}containsKey(e,t){return D.resolve(this.Mr.containsKey(t))}}class Gh{constructor(e,t){this.Nr={},this.overlays={},this.Br=new Ri(0),this.Lr=!1,this.Lr=!0,this.referenceDelegate=e(this),this.kr=new qh(this),this.indexManager=new Hu,this.remoteDocumentCache=(e=e=>this.referenceDelegate.qr(e),new Uh(e)),this.serializer=new mu(t),this.Qr=new Lh(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Lr=!1,Promise.resolve()}get started(){return this.Lr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Fh,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Nr[e.toKey()];return n||(n=new Vh(t,this.referenceDelegate),this.Nr[e.toKey()]=n),n}getTargetCache(){return this.kr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Qr}runTransaction(e,t,n){m("MemoryPersistence","Starting transaction:",e);const r=new Kh(this.Br.next());return this.referenceDelegate.Kr(),n(r).next(e=>this.referenceDelegate.$r(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ur(t,n){return D.or(Object.values(this.Nr).map(e=>()=>e.containsKey(t,n)))}}class Kh extends wi{constructor(e){super(),this.currentSequenceNumber=e}}class jh{constructor(e){this.persistence=e,this.Wr=new Oh,this.Gr=null}static zr(e){return new jh(e)}get jr(){if(this.Gr)return this.Gr;throw b()}addReference(e,t,n){return this.Wr.addReference(n,t),this.jr.delete(n.toString()),D.resolve()}removeReference(e,t,n){return this.Wr.removeReference(n,t),this.jr.add(n.toString()),D.resolve()}markPotentiallyOrphaned(e,t){return this.jr.add(t.toString()),D.resolve()}removeTarget(e,t){this.Wr.Ar(t.targetId).forEach(e=>this.jr.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.jr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Kr(){this.Gr=new Set}$r(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return D.forEach(this.jr,e=>{const t=S.fromPath(e);return this.Hr(n,t).next(e=>{e||r.removeEntry(t,E.min())})}).next(()=>(this.Gr=null,r.apply(n)))}updateLimboDocument(e,t){return this.Hr(e,t).next(e=>{e?this.jr.delete(t.toString()):this.jr.add(t.toString())})}qr(e){return 0}Hr(e,t){return D.or([()=>D.resolve(this.Wr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ur(e,t)])}}class zh{constructor(e){this.serializer=e}B(t,e,n,r){const s=new bi("createOrUpgrade",e);var i;n<1&&1<=r&&(t.createObjectStore("owner"),(i=t).createObjectStore("mutationQueues",{keyPath:"userId"}),i.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ui,{unique:!0}),i.createObjectStore("documentMutations"),$h(t),t.createObjectStore("remoteDocuments"));let a=D.resolve();return n<3&&3<=r&&(0!==n&&((i=t).deleteObjectStore("targetDocuments"),i.deleteObjectStore("targets"),i.deleteObjectStore("targetGlobal"),$h(t)),a=a.next(()=>{return e=s.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:E.min().toTimestamp(),targetCount:0},e.put("targetGlobalKey",t);var e,t})),n<4&&4<=r&&(a=(a=0!==n?a.next(()=>{return r=t,(i=s).store("mutations").G().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ui,{unique:!0});const t=i.store("mutations"),n=e.map(e=>t.put(e));return D.waitFor(n)});var r,i}):a).next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.Yr(s))),n<6&&6<=r&&(a=a.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.Zr(s)))),n<7&&7<=r&&(a=a.next(()=>this.Xr(s))),n<8&&8<=r&&(a=a.next(()=>this.ei(t,s))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.ti(s))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{var e;(e=t.createObjectStore("documentOverlays",{keyPath:es})).createIndex("collectionPathOverlayIndex",ts,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",ns,{unique:!1})})),n<13&&13<=r&&(a=a.next(()=>{var e;(e=t.createObjectStore("remoteDocumentsV14",{keyPath:Ki})).createIndex("documentKeyIndex",ji),e.createIndex("collectionGroupIndex",zi)}).next(()=>this.ni(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.ri(t,s))),a=n<15&&15<=r?a.next(()=>{var e;(e=t).createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Yi}).createIndex("sequenceNumberIndex",Xi,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Ji}).createIndex("documentKeyIndex",Zi,{unique:!1})}):a}Zr(t){let n=0;return t.store("remoteDocuments").Z((e,t)=>{n+=ah(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}Yr(n){const e=n.store("mutationQueues"),r=n.store("mutations");return e.G().next(e=>D.forEach(e,t=>{var e=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return r.G("userMutationsIndex",e).next(e=>D.forEach(e,e=>{y(e.userId===t.userId);e=_u(this.serializer,e);return sh(n,t.userId,e).next(()=>{})}))}))}Xr(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{const s=[];return t.Z((e,t)=>{const n=new T(e),r=[0,Oi(n)];s.push(a.get(r).next(e=>{return e?D.resolve():(e=n,a.put({targetId:0,path:Oi(e),sequenceNumber:i.highestListenSequenceNumber}))}))}).next(()=>D.waitFor(s))})}ei(e,t){e.createObjectStore("collectionParents",{keyPath:Wi});const n=t.store("collectionParents"),r=new Wu,i=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Oi(r)})}};return t.store("remoteDocuments").Z({Y:!0},(e,t)=>{e=new T(e);return i(e.popLast())}).next(()=>t.store("documentMutations").Z({Y:!0},([,e],t)=>{e=Vi(e);return i(e.popLast())}))}ti(e){const n=e.store("targets");return n.Z((e,t)=>{t=bu(t),t=Iu(this.serializer,t);return n.put(t)})}ni(e,i){const t=i.store("remoteDocuments"),s=[];return t.Z((e,t)=>{var n=i.store("remoteDocumentsV14"),r=((r=t).document?new S(T.fromString(r.document.name).popFirst(5)):r.noDocument?S.fromSegments(r.noDocument.path):r.unknownDocument?S.fromSegments(r.unknownDocument.path):b()).path.toArray(),r={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};s.push(n.put(r))}).next(()=>D.waitFor(s))}ri(e,i){const t=i.store("mutations"),s=Sh(this.serializer),a=new Gh(jh.zr,this.serializer.ct);return t.G().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!=(t=r.get(e.userId))?t:L();_u(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),D.forEach(r,(e,t)=>{var t=new o(t),n=Nu.lt(this.serializer,t),r=a.getIndexManager(t),t=oh.lt(t,this.serializer,r,a.referenceDelegate);return new Mh(s,t,n,r).recalculateAndSaveOverlaysForDocumentKeys(new us(i,Ri.ae),e).next()})})}}function $h(e){e.createObjectStore("targetDocuments",{keyPath:Qi}).createIndex("documentTargetsIndex",Hi,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",$i,{unique:!0}),e.createObjectStore("targetGlobal")}const Qh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Hh{constructor(e,t,n,r,i,s,a,o,u,h,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ii=i,this.window=s,this.document=a,this.si=u,this.oi=h,this._i=l,this.Br=null,this.Lr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ai=null,this.inForeground=!1,this.ui=null,this.ci=null,this.li=Number.NEGATIVE_INFINITY,this.hi=e=>Promise.resolve(),!Hh.v())throw new _(w.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new bh(this,r),this.Pi=t+"main",this.serializer=new mu(o),this.Ii=new Ii(this.Pi,this._i,new zh(this.serializer)),this.kr=new fh(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Sh(this.serializer),this.Qr=new Du,this.window&&this.window.localStorage?this.Ti=this.window.localStorage:(this.Ti=null,!1===h&&d("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ei().then(()=>{if(this.isPrimary||this.allowTabSynchronization)return this.di(),this.Ai(),this.Ri(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.kr.getHighestSequenceNumber(e));throw new _(w.FAILED_PRECONDITION,Qh)}).then(e=>{this.Br=new Ri(e,this.si)}).then(()=>{this.Lr=!0}).catch(e=>(this.Ii&&this.Ii.close(),Promise.reject(e)))}Vi(t){return this.hi=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ii.k(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ii.enqueueAndForget(async()=>{this.started&&await this.Ei()}))}Ei(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>Yh(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.mi(t).next(e=>{e||(this.isPrimary=!1,this.ii.enqueueRetryable(()=>this.hi(!1)))})}).next(()=>this.fi(t)).next(e=>this.isPrimary&&!e?this.gi(t).next(()=>!1):!!e&&this.pi(t).next(()=>!0))).catch(e=>{if(Si(e))return m("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(this.allowTabSynchronization)return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1;throw e}).then(e=>{this.isPrimary!==e&&this.ii.enqueueRetryable(()=>this.hi(e)),this.isPrimary=e})}mi(e){return Wh(e).get("owner").next(e=>D.resolve(this.yi(e)))}wi(e){return Yh(e).delete(this.clientId)}async Si(){if(this.isPrimary&&!this.bi(this.li,18e5)){this.li=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=hs(e,"clientMetadata");return r.G().next(e=>{const t=this.Di(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return D.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ti)for(const t of e)this.Ti.removeItem(this.vi(t.clientId))}}Ri(){this.ci=this.ii.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Ei().then(()=>this.Si()).then(()=>this.Ri()))}yi(e){return!!e&&e.ownerId===this.clientId}fi(t){return this.oi?D.resolve(!0):Wh(t).get("owner").next(e=>{if(null!==e&&this.bi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)){if(this.yi(e)&&this.networkEnabled)return!0;if(!this.yi(e)){if(e.allowTabSynchronization)return!1;throw new _(w.FAILED_PRECONDITION,Qh)}}return!(!this.networkEnabled||!this.inForeground)||Yh(t).G().next(e=>void 0===this.Di(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,e=this.networkEnabled===e.networkEnabled;if(t||n&&e)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&m("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Lr=!1,this.Fi(),this.ci&&(this.ci.cancel(),this.ci=null),this.Mi(),this.xi(),await this.Ii.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new us(e,Ri.ae);return this.gi(t).next(()=>this.wi(t))}),this.Ii.close(),this.Oi()}Di(e,t){return e.filter(e=>this.bi(e.updateTimeMs,t)&&!this.Ci(e.clientId))}Ni(){return this.runTransaction("getActiveClients","readonly",e=>Yh(e).G().next(e=>this.Di(e,18e5).map(e=>e.clientId)))}get started(){return this.Lr}getMutationQueue(e,t){return oh.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.kr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Xu(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Nu.lt(this.serializer,e)}getBundleCache(){return this.Qr}runTransaction(t,n,r){m("IndexedDbPersistence","Starting transaction:",t);var e="readonly"===n?"readonly":"readwrite",i=15===(i=this._i)?os:14===i?as:13===i?ss:12===i?is:11===i?rs:void b();let s;return this.Ii.runTransaction(t,e,i,e=>(s=new us(e,this.Br?this.Br.next():Ri.ae),"readwrite-primary"===n?this.mi(s).next(e=>!!e||this.fi(s)).next(e=>{if(e)return r(s);throw d(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.ii.enqueueRetryable(()=>this.hi(!1)),new _(w.FAILED_PRECONDITION,vi)}).next(e=>this.pi(s).next(()=>e)):this.Bi(s).next(()=>r(s)))).then(e=>(s.raiseOnCommittedEvent(),e))}Bi(e){return Wh(e).get("owner").next(e=>{if(null!==e&&this.bi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)&&!this.yi(e)&&!(this.oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new _(w.FAILED_PRECONDITION,Qh)})}pi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Wh(e).put("owner",t)}static v(){return Ii.v()}gi(e){const t=Wh(e);return t.get("owner").next(e=>this.yi(e)?(m("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):D.resolve())}bi(e,t){var n=Date.now();return!(e<n-t||n<e&&(d(`Detected an update time that is in the future: ${e} > `+n),1))}di(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ui=()=>{this.ii.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Ei()))},this.document.addEventListener("visibilitychange",this.ui),this.inForeground="visible"===this.document.visibilityState)}Mi(){this.ui&&(this.document.removeEventListener("visibilitychange",this.ui),this.ui=null)}Ai(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.ai=()=>{this.Fi();var e=/(?:Version|Mobile)\/1[456]/;j()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ii.enterRestrictedMode(!0),this.ii.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ai))}xi(){this.ai&&(this.window.removeEventListener("pagehide",this.ai),this.ai=null)}Ci(e){var t;try{var n=null!==(null==(t=this.Ti)?void 0:t.getItem(this.vi(e)));return m("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return d("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Fi(){if(this.Ti)try{this.Ti.setItem(this.vi(this.clientId),String(Date.now()))}catch(e){d("Failed to set zombie client id.",e)}}Oi(){if(this.Ti)try{this.Ti.removeItem(this.vi(this.clientId))}catch(e){}}vi(e){return`firestore_zombie_${this.persistenceKey}_`+e}}function Wh(e){return hs(e,"owner")}function Yh(e){return hs(e,"clientMetadata")}function Xh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Jh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Li=n,this.ki=r}static qi(e,t){let n=L(),r=L();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Jh(e,t.fromCache,n,r)}}class Zh{constructor(){this.Qi=!1}initialize(e,t){this.Ki=e,this.indexManager=t,this.Qi=!0}getDocumentsMatchingQuery(t,n,r,i){return this.$i(t,n).next(e=>e||this.Ui(t,n,i,r)).next(e=>e||this.Wi(t,n))}$i(i,s){if(Ea(s))return D.resolve(null);let t=Ca(s);return this.indexManager.getIndexType(i,t).next(e=>0===e?null:(null!==s.limit&&1===e&&(s=Na(s,null,"F"),t=Ca(s)),this.indexManager.getDocumentsMatchingTarget(i,t).next(e=>{const r=L(...e);return this.Ki.getDocuments(i,r).next(n=>this.indexManager.getMinOffset(i,t).next(e=>{var t=this.Gi(s,n);return this.zi(s,t,r,e.readTime)?this.$i(i,Na(s,null,"F")):this.ji(i,t,s,e)}))})))}Ui(t,n,r,i){return Ea(n)||i.isEqual(E.min())?this.Wi(t,n):this.Ki.getDocuments(t,r).next(e=>{e=this.Gi(n,e);return this.zi(n,e,r,i)?this.Wi(t,n):($r()<=c.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Ma(n)),this.ji(t,e,n,gi(i,-1)))})}Gi(n,e){let r=new A(Oa(n));return e.forEach((e,t)=>{La(n,t)&&(r=r.add(t))}),r}zi(e,t,n,r){return null!==e.limit&&(n.size!==t.size||!!(n="F"===e.limitType?t.last():t.first())&&(n.hasPendingWrites||0<n.version.compareTo(r)))}Wi(e,t){return $r()<=c.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",Ma(t)),this.Ki.getDocumentsMatchingQuery(e,t,pi.min())}ji(e,n,t,r){return this.Ki.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class el{constructor(e,t,n,r){this.persistence=e,this.Hi=t,this.serializer=r,this.Ji=new C(I),this.Yi=new Pa(e=>ga(e),ma),this.Zi=new Map,this.Xi=e.getRemoteDocumentCache(),this.kr=e.getTargetCache(),this.Qr=e.getBundleCache(),this.es(n)}es(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Mh(this.Xi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Xi.setIndexManager(this.indexManager),this.Hi.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Ji))}}function tl(e,t,n,r){return new el(e,t,n,r)}async function nl(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",i=>{let s;return a.mutationQueue.getAllMutationBatches(i).next(e=>(s=e,a.es(t),a.mutationQueue.getAllMutationBatches(i))).next(e=>{const t=[],n=[];let r=L();for(const i of s){t.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}for(const i of e){n.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(i,r).next(e=>({ts:e,removedBatchIds:t,addedBatchIds:n}))})})}function rl(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.kr.getLastRemoteSnapshotVersion(e))}function il(e,s,t){let n=L(),a=L();return t.forEach(e=>n=n.add(e)),s.getEntries(e,n).next(r=>{let i=Va;return t.forEach((e,t)=>{var n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(E.min())?(s.removeEntry(e,t.readTime),i=i.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(s.addEntry(t),i=i.insert(e,t)):m("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{ns:i,rs:a}})}function sl(e,r){const i=e;return i.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return i.kr.getTargetData(t,r).next(e=>e?(n=e,D.resolve(n)):i.kr.allocateTargetId(t).next(e=>(n=new gu(r,e,"TargetPurposeListen",t.currentSequenceNumber),i.kr.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=i.Ji.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(i.Ji=i.Ji.insert(e.targetId,e),i.Yi.set(r,e.targetId)),e})}async function al(e,t,n){const r=e,i=r.Ji.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,e=>r.persistence.referenceDelegate.removeTarget(e,i))}catch(e){if(!Si(e))throw e;m("LocalStore",`Failed to update sequence numbers for target ${t}: `+e)}r.Ji=r.Ji.remove(t),r.Yi.delete(i.target)}function ol(e,s,a){const o=e;let u=E.min(),h=L();return o.persistence.runTransaction("Execute query","readonly",t=>{return e=o,n=t,r=Ca(s),(void 0!==(i=e.Yi.get(r))?D.resolve(e.Ji.get(i)):e.kr.getTargetData(n,r)).next(e=>{if(e)return u=e.lastLimboFreeSnapshotVersion,o.kr.getMatchingKeysForTargetId(t,e.targetId).next(e=>{h=e})}).next(()=>o.Hi.getDocumentsMatchingQuery(t,s,a?u:E.min(),a?h:L())).next(e=>(ll(o,Fa(s),e),{documents:e,ss:h}));var e,n,r,i})}function ul(e,t){const n=e,r=n.kr,i=n.Ji.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",e=>r.ut(e,t).next(e=>e?e.target:null))}function hl(e,t){const n=e,r=n.Zi.get(t)||E.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Xi.getAllFromCollectionGroup(e,t,gi(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(ll(n,t,e),e))}function ll(e,t,n){let r=e.Zi.get(t)||E.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.Zi.set(t,r)}function cl(e,t){return`firestore_clients_${e}_`+t}function dl(e,t,n){let r=`firestore_mutations_${e}_`+n;return t.isAuthenticated()&&(r+="_"+t.uid),r}function fl(e,t){return`firestore_targets_${e}_`+t}class gl{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static cs(e,t,n){var r=JSON.parse(n);let i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new _(r.error.code,r.error.message)),s?new gl(e,t,r.state,i):(d("SharedClientState",`Failed to parse mutation state for ID '${t}': `+n),null)}ls(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ml{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static cs(e,t){var n=JSON.parse(t);let r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new _(n.error.code,n.error.message)),i?new ml(e,n.state,r):(d("SharedClientState",`Failed to parse target state for ID '${e}': `+t),null)}ls(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class pl{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static cs(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,i=za;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=Fi(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new pl(e,i):(d("SharedClientState",`Failed to parse client data for instance '${e}': `+t),null)}}class yl{constructor(e,t){this.clientId=e,this.onlineState=t}static cs(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new yl(t.clientId,t.onlineState):(d("SharedClientState","Failed to parse online state: "+e),null)}}class vl{constructor(){this.activeTargetIds=za}hs(e){this.activeTargetIds=this.activeTargetIds.add(e)}Ps(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ls(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class wl{constructor(e,t,n,r,i){this.window=e,this.ii=t,this.persistenceKey=n,this.Is=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Ts=this.Es.bind(this),this.ds=new C(I),this.started=!1,this.As=[];e=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Rs=cl(this.persistenceKey,this.Is),this.Vs="firestore_sequence_number_"+this.persistenceKey,this.ds=this.ds.insert(this.Is,new vl),this.fs=new RegExp(`^firestore_clients_${e}_([^_]*)$`),this.gs=new RegExp(`^firestore_mutations_${e}_(\\d+)(?:_(.*))?$`),this.ps=new RegExp(`^firestore_targets_${e}_(\\d+)$`),this.ys="firestore_online_state_"+this.persistenceKey,this.ws="firestore_bundle_loaded_v2_"+this.persistenceKey,this.window.addEventListener("storage",this.Ts)}static v(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Ni();for(const n of e)if(n!==this.Is){const e=this.getItem(cl(this.persistenceKey,n));var t;e&&(t=pl.cs(n,e))&&(this.ds=this.ds.insert(t.clientId,t))}this.Ss();const n=this.storage.getItem(this.ys);if(n){const e=this.bs(n);e&&this.Ds(e)}for(const e of this.As)this.Es(e);this.As=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.vs(this.ds)}isActiveQueryTarget(n){let r=!1;return this.ds.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Cs(e,"pending")}updateMutationState(e,t,n){this.Cs(e,t,n),this.Fs(e)}addLocalQueryTarget(e){let t="not-current";var n;return!this.isActiveQueryTarget(e)||(n=this.storage.getItem(fl(this.persistenceKey,e)))&&(n=ml.cs(e,n))&&(t=n.state),this.Ms.hs(e),this.Ss(),t}removeLocalQueryTarget(e){this.Ms.Ps(e),this.Ss()}isLocalQueryTarget(e){return this.Ms.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(fl(this.persistenceKey,e))}updateQueryState(e,t,n){this.xs(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Fs(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Os(e)}notifyBundleLoaded(e){this.Ns(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Ts),this.removeItem(this.Rs),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return m("SharedClientState","READ",e,t),t}setItem(e,t){m("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){m("SharedClientState","REMOVE",e),this.storage.removeItem(e)}Es(e){const r=e;r.storageArea===this.storage&&(m("SharedClientState","EVENT",r.key,r.newValue),r.key!==this.Rs?this.ii.enqueueRetryable(async()=>{if(this.started){if(null!==r.key){var e;if(this.fs.test(r.key))return null==r.newValue?(e=this.Bs(r.key),this.Ls(e,null)):(e=this.ks(r.key,r.newValue))?this.Ls(e.clientId,e):void 0;if(this.gs.test(r.key)){if(null!==r.newValue){var t=this.qs(r.key,r.newValue);if(t)return this.Qs(t)}}else if(this.ps.test(r.key)){if(null!==r.newValue&&(t=this.Ks(r.key,r.newValue)))return this.$s(t)}else if(r.key===this.ys){if(null!==r.newValue){var n=this.bs(r.newValue);if(n)return this.Ds(n)}}else r.key===this.Vs?(n=function(e){let t=Ri.ae;if(null!=e)try{var n=JSON.parse(e);y("number"==typeof n),t=n}catch(e){d("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(r.newValue))!==Ri.ae&&this.sequenceNumberHandler(n):r.key===this.ws&&(e=this.Us(r.newValue),await Promise.all(e.map(e=>this.syncEngine.Ws(e))))}}else this.As.push(r)}):d("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Ms(){return this.ds.get(this.Is)}Ss(){this.setItem(this.Rs,this.Ms.ls())}Cs(e,t,n){t=new gl(this.currentUser,e,t,n),n=dl(this.persistenceKey,this.currentUser,e);this.setItem(n,t.ls())}Fs(e){e=dl(this.persistenceKey,this.currentUser,e);this.removeItem(e)}Os(e){e={clientId:this.Is,onlineState:e};this.storage.setItem(this.ys,JSON.stringify(e))}xs(e,t,n){var r=fl(this.persistenceKey,e),e=new ml(e,t,n);this.setItem(r,e.ls())}Ns(e){e=JSON.stringify(Array.from(e));this.setItem(this.ws,e)}Bs(e){e=this.fs.exec(e);return e?e[1]:null}ks(e,t){e=this.Bs(e);return pl.cs(e,t)}qs(e,t){var e=this.gs.exec(e),n=Number(e[1]),e=void 0!==e[2]?e[2]:null;return gl.cs(new o(e),n,t)}Ks(e,t){e=this.ps.exec(e),e=Number(e[1]);return ml.cs(e,t)}bs(e){return yl.cs(e)}Us(e){return JSON.parse(e)}async Qs(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Gs(e.batchId,e.state,e.error);m("SharedClientState","Ignoring mutation for non-active user "+e.user.uid)}$s(e){return this.syncEngine.zs(e.targetId,e.state,e.error)}Ls(e,t){const n=t?this.ds.insert(e,t):this.ds.remove(e),r=this.vs(this.ds),i=this.vs(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.js(s,a).then(()=>{this.ds=n})}Ds(e){this.ds.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}vs(e){let n=za;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class _l{constructor(){this.Hs=new vl,this.Js={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Hs.hs(e),this.Js[e]||"not-current"}updateQueryState(e,t,n){this.Js[e]=t}removeLocalQueryTarget(e){this.Hs.Ps(e)}isLocalQueryTarget(e){return this.Hs.activeTargetIds.has(e)}clearQueryState(e){delete this.Js[e]}getAllActiveQueryTargets(){return this.Hs.activeTargetIds}isActiveQueryTarget(e){return this.Hs.activeTargetIds.has(e)}start(){return this.Hs=new vl,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class bl{Ys(e){}shutdown(){}}class Il{constructor(){this.Zs=()=>this.Xs(),this.eo=()=>this.no(),this.ro=[],this.io()}Ys(e){this.ro.push(e)}shutdown(){window.removeEventListener("online",this.Zs),window.removeEventListener("offline",this.eo)}io(){window.addEventListener("online",this.Zs),window.addEventListener("offline",this.eo)}Xs(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ro)e(0)}no(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ro)e(1)}static v(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let El=null;function Tl(){return null===El?El=268435456+Math.round(2147483648*Math.random()):El++,"0x"+El.toString(16)}const Sl={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class xl{constructor(e){this.so=e.so,this.oo=e.oo}_o(e){this.ao=e}uo(e){this.co=e}onMessage(e){this.lo=e}close(){this.oo()}send(e){this.so(e)}ho(){this.ao()}Po(e){this.co(e)}Io(e){this.lo(e)}}const Dl="WebChannelConnection";class Cl extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.To=t+"://"+e.host,this.Eo=`projects/${n}/databases/`+r,this.Ao="(default)"===this.databaseId.database?"project_id="+n:`project_id=${n}&database_id=`+r}get Ro(){return!1}Vo(t,e,n,r,i){const s=Tl(),a=this.mo(t,e);m("RestConnection",`Sending RPC '${t}' ${s}:`,a,n);e={"google-cloud-resource-prefix":this.Eo,"x-goog-request-params":this.Ao};return this.fo(e,r,i),this.po(t,a,e,n).then(e=>(m("RestConnection",`Received RPC '${t}' ${s}: `,e),e),e=>{throw Qr("RestConnection",`RPC '${t}' ${s} failed with error: `,e,"url: ",a,"request:",n),e})}yo(e,t,n,r,i,s){return this.Vo(e,t,n,r,i)}fo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+jr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}mo(e,t){e=Sl[e];return this.To+`/v1/${t}:`+e}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}po(o,t,n,r){const u=Tl();return new Promise((i,s)=>{const a=new qr;a.setWithCredentials(!0),a.listenOnce(Pr.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case Or.NO_ERROR:var e=a.getResponseJson();m(Dl,`XHR for RPC '${o}' ${u} received:`,JSON.stringify(e)),i(e);break;case Or.TIMEOUT:m(Dl,`RPC '${o}' ${u} timed out`),s(new _(w.DEADLINE_EXCEEDED,"Request time out"));break;case Or.HTTP_ERROR:var t=a.getStatus();if(m(Dl,`RPC '${o}' ${u} failed with status:`,t,"response text:",a.getResponseText()),0<t){let e=a.getResponseJson();var n=null==(e=Array.isArray(e)?e[0]:e)?void 0:e.error;if(n&&n.status&&n.message){r=n.status.toLowerCase().replace(/_/g,"-");const o=0<=Object.values(w).indexOf(r)?r:w.UNKNOWN;s(new _(o,n.message))}else s(new _(w.UNKNOWN,"Server responded with status "+a.getStatus()))}else s(new _(w.UNAVAILABLE,"Connection failed."));break;default:b()}}finally{m(Dl,`RPC '${o}' ${u} completed.`)}var r});var e=JSON.stringify(r);m(Dl,`RPC '${o}' ${u} sending request:`,r),a.send(t,"POST",e,n,15)})}wo(i,e,t){const s=Tl(),n=[this.To,"/","google.firestore.v1.Firestore","/",i,"/channel"],r=new cr,a=Fr(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/`+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(o.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(o.xmlHttpFactory=new Ur({})),this.fo(o.initMessageHeaders,e,t),o.encodeInitMessageHeaders=!0;e=n.join("");m(Dl,`Creating RPC '${i}' stream ${s}: `+e,o);const h=r.createWebChannel(e,o);let l=!1,c=!1;const d=new xl({so:e=>{c?m(Dl,`Not sending because RPC '${i}' stream ${s} is closed:`,e):(l||(m(Dl,`Opening RPC '${i}' stream ${s} transport.`),h.open(),l=!0),m(Dl,`RPC '${i}' stream ${s} sending:`,e),h.send(e))},oo:()=>h.close()}),f=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return f(h,Br.EventType.OPEN,()=>{c||m(Dl,`RPC '${i}' stream ${s} transport opened.`)}),f(h,Br.EventType.CLOSE,()=>{c||(c=!0,m(Dl,`RPC '${i}' stream ${s} transport closed`),d.Po())}),f(h,Br.EventType.ERROR,e=>{c||(c=!0,Qr(Dl,`RPC '${i}' stream ${s} transport errored:`,e),d.Po(new _(w.UNAVAILABLE,"The operation could not be completed")))}),f(h,Br.EventType.MESSAGE,n=>{if(!c){var n=n.data[0],r=(y(!!n),n.error||(null==(r=n[0])?void 0:r.error));if(r){m(Dl,`RPC '${i}' stream ${s} received error:`,r);const n=r.status;let e=function(e){e=g[e];if(void 0!==e)return So(e)}(n),t=r.message;void 0===e&&(e=w.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),c=!0,d.Po(new _(e,t)),h.close()}else m(Dl,`RPC '${i}' stream ${s} received:`,n),d.Io(n)}}),f(a,Vr.STAT_EVENT,e=>{10===e.stat?m(Dl,`RPC '${i}' stream ${s} detected buffering proxy`):11===e.stat&&m(Dl,`RPC '${i}' stream ${s} detected no buffering proxy`)}),setTimeout(()=>{d.ho()},0),d}}function Al(){return"undefined"!=typeof window?window:null}function Nl(){return"undefined"!=typeof document?document:null}function kl(e){return new $o(e,!0)}class Rl{constructor(e,t,n=1e3,r=1.5,i=6e4){this.ii=e,this.timerId=t,this.So=n,this.bo=r,this.Do=i,this.vo=0,this.Co=null,this.Fo=Date.now(),this.reset()}reset(){this.vo=0}Mo(){this.vo=this.Do}xo(e){this.cancel();var t=Math.floor(this.vo+this.Oo()),n=Math.max(0,Date.now()-this.Fo),r=Math.max(0,t-n);0<r&&m("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.vo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Co=this.ii.enqueueAfterDelay(this.timerId,r,()=>(this.Fo=Date.now(),e())),this.vo*=this.bo,this.vo<this.So&&(this.vo=this.So),this.vo>this.Do&&(this.vo=this.Do)}No(){null!==this.Co&&(this.Co.skipDelay(),this.Co=null)}cancel(){null!==this.Co&&(this.Co.cancel(),this.Co=null)}Oo(){return(Math.random()-.5)*this.vo}}class Ml{constructor(e,t,n,r,i,s,a,o){this.ii=e,this.Bo=n,this.Lo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.ko=0,this.qo=null,this.Qo=null,this.stream=null,this.Ko=new Rl(e,t)}$o(){return 1===this.state||5===this.state||this.Uo()}Uo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Wo()}async stop(){this.$o()&&await this.close(0)}Go(){this.state=0,this.Ko.reset()}zo(){this.Uo()&&null===this.qo&&(this.qo=this.ii.enqueueAfterDelay(this.Bo,6e4,()=>this.jo()))}Ho(e){this.Jo(),this.stream.send(e)}async jo(){if(this.Uo())return this.close(0)}Jo(){this.qo&&(this.qo.cancel(),this.qo=null)}Yo(){this.Qo&&(this.Qo.cancel(),this.Qo=null)}async close(e,t){this.Jo(),this.Yo(),this.Ko.cancel(),this.ko++,4!==e?this.Ko.reset():t&&t.code===w.RESOURCE_EXHAUSTED?(d(t.toString()),d("Using maximum backoff delay to prevent overloading the backend."),this.Ko.Mo()):t&&t.code===w.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Zo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.uo(t)}Zo(){}auth(){this.state=1;const e=this.Xo(this.ko),n=this.ko;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.ko===n&&this.e_(e,t)},t=>{e(()=>{var e=new _(w.UNKNOWN,"Fetching auth token failed: "+t.message);return this.t_(e)})})}e_(e,t){const n=this.Xo(this.ko);this.stream=this.n_(e,t),this.stream._o(()=>{n(()=>(this.state=2,this.Qo=this.ii.enqueueAfterDelay(this.Lo,1e4,()=>(this.Uo()&&(this.state=3),Promise.resolve())),this.listener._o()))}),this.stream.uo(e=>{n(()=>this.t_(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Wo(){this.state=5,this.Ko.xo(async()=>{this.state=0,this.start()})}t_(e){return m("PersistentStream","close with error: "+e),this.stream=null,this.close(4,e)}Xo(t){return e=>{this.ii.enqueueAndForget(()=>this.ko===t?e():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Ll extends Ml{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}n_(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.Ko.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:b(),i=t.targetChange.targetIds||[],s=(f=t.targetChange.resumeToken,e.useProto3Json?(y(void 0===f||"string"==typeof f),ws.fromBase64String(f||"")):(y(void 0===f||f instanceof Uint8Array),ws.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?w.UNKNOWN:So(f.code),new _(o,f.message||""));n=new Vo(r,i,s,o||null)}else if("documentChange"in t){t.documentChange;(l=t.documentChange).document,l.document.name,l.document.updateTime;var s=Zo(e,l.document.name),o=O(l.document.updateTime),u=l.document.createTime?O(l.document.createTime):E.min(),h=new $s({mapValue:{fields:l.document.fields}}),u=k.newFoundDocument(s,o,u,h),h=l.targetIds||[],l=l.removedTargetIds||[];n=new Oo(h,l,u.key,u)}else if("documentDelete"in t)t.documentDelete,(h=t.documentDelete).document,l=Zo(e,h.document),u=h.readTime?O(h.readTime):E.min(),u=k.newNoDocument(l,u),h=h.removedTargetIds||[],n=new Oo([],h,u.key,u);else if("documentRemove"in t){t.documentRemove;(d=t.documentRemove).document;var c=Zo(e,d.document),d=d.removedTargetIds||[];n=new Oo([],d,c,null)}else{if(!("filter"in t))return b();{t.filter;const e=t.filter;e.targetId;var{count:d=0,unchangedNames:c}=e,d=new Eo(d,c),c=e.targetId;n=new Po(c,d)}}var f;return n}(this.serializer,e),e=!("targetChange"in(e=e))||(e=e.targetChange).targetIds&&e.targetIds.length||!e.readTime?E.min():O(e.readTime);return this.listener.r_(t,e)}i_(e){var t={};t.database=nu(this.serializer),t.addTarget=function(e,t){var n;const r=t.target;if((n=pa(r)?{documents:uu(e,r)}:{query:hu(e,r)}).targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=Wo(e,t.resumeToken);const r=Qo(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(E.min())){n.readTime=Ho(e,t.snapshotVersion.toTimestamp());const r=Qo(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);this.serializer;var n=null==(n=function(){switch(e.purpose){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return b()}}())?null:{"goog-listen-tags":n};n&&(t.labels=n),this.Ho(t)}s_(e){var t={};t.database=nu(this.serializer),t.removeTarget=e,this.Ho(t)}}class Fl extends Ml{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.o_=!1}get __(){return this.o_}start(){this.o_=!1,this.lastStreamToken=void 0,super.start()}Zo(){this.o_&&this.a_([])}n_(e,t){return this.connection.wo("Write",e,t)}onMessage(e){var t,n,r;return y(!!e.streamToken),this.lastStreamToken=e.streamToken,this.o_?(this.Ko.reset(),n=e.writeResults,r=e.commitTime,n=n&&0<n.length?(y(void 0!==r),n.map(t=>{{var n=r;let e=t.updateTime?O(t.updateTime):O(n);return e.isEqual(E.min())&&(e=O(n)),new ao(e,t.transformResults||[])}})):[],t=O(e.commitTime),this.listener.u_(t,n)):(y(!e.writeResults||0===e.writeResults.length),this.o_=!0,this.listener.c_())}l_(){var e={};e.database=nu(this.serializer),this.Ho(e)}a_(e){e={streamToken:this.lastStreamToken,writes:e.map(e=>au(this.serializer,e))};this.Ho(e)}}class Ol extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.h_=!1}P_(){if(this.h_)throw new _(w.FAILED_PRECONDITION,"The client has already been terminated.")}Vo(n,r,i){return this.P_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.Vo(n,r,i,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===w.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(w.UNKNOWN,e.toString())})}yo(n,r,i,s){return this.P_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.yo(n,r,i,e,t,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===w.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(w.UNKNOWN,e.toString())})}terminate(){this.h_=!0}}class Pl{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.T_=0,this.E_=null,this.d_=!0}A_(){0===this.T_&&(this.R_("Unknown"),this.E_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.E_=null,this.V_("Backend didn't respond within 10 seconds."),this.R_("Offline"),Promise.resolve())))}m_(e){"Online"===this.state?this.R_("Unknown"):(this.T_++,1<=this.T_&&(this.f_(),this.V_("Connection failed 1 times. Most recent error: "+e.toString()),this.R_("Offline")))}set(e){this.f_(),this.T_=0,"Online"===e&&(this.d_=!1),this.R_(e)}R_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}V_(e){e=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.d_?(d(e),this.d_=!1):m("OnlineStateTracker",e)}f_(){null!==this.E_&&(this.E_.cancel(),this.E_=null)}}class Vl{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.g_=[],this.p_=new Map,this.y_=new Set,this.w_=[],this.S_=i,this.S_.Ys(e=>{n.enqueueAndForget(async()=>{var e;Ql(this)&&(m("RemoteStore","Restarting streams for network reachability change."),(e=this).y_.add(4),await Bl(e),e.b_.set("Unknown"),e.y_.delete(4),await Ul(e))})}),this.b_=new Pl(n,r)}}async function Ul(e){if(Ql(e))for(const t of e.w_)await t(!0)}async function Bl(e){for(const t of e.w_)await t(!1)}function ql(e,t){e.p_.has(t.targetId)||(e.p_.set(t.targetId,t),$l(e)?zl(e):nc(e).Uo()&&Kl(e,t))}function Gl(e,t){var n=nc(e);e.p_.delete(t),n.Uo()&&jl(e,t),0===e.p_.size&&(n.Uo()?n.zo():Ql(e)&&e.b_.set("Unknown"))}function Kl(e,t){var n;e.D_.Be(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(E.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),nc(e).i_(t)}function jl(e,t){e.D_.Be(t),nc(e).s_(t)}function zl(t){t.D_=new Bo({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),ut:e=>t.p_.get(e)||null,rt:()=>t.datastore.serializer.databaseId}),nc(t).start(),t.b_.A_()}function $l(e){return Ql(e)&&!nc(e).$o()&&0<e.p_.size}function Ql(e){return 0===e.y_.size}function Hl(e){e.D_=void 0}async function Wl(e,t,n){if(!Si(t))throw t;e.y_.add(1),await Bl(e),e.b_.set("Offline"),n=n||(()=>rl(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),e.y_.delete(1),await Ul(e)})}function Yl(t,n){return n().catch(e=>Wl(t,e,n))}async function Xl(e){var t,n=e,r=rc(n);let i=0<n.g_.length?n.g_[n.g_.length-1].batchId:-1;for(;Ql(t=n)&&t.g_.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(n.localStore,i);if(null===e){0===n.g_.length&&r.zo();break}i=e.batchId;var s=n,a=e;s.g_.push(a),(s=rc(s)).Uo()&&s.__&&s.a_(a.mutations)}catch(e){await Wl(n,e)}Jl(n)&&Zl(n)}function Jl(e){return Ql(e)&&!rc(e).$o()&&0<e.g_.length}function Zl(e){rc(e).start()}async function ec(e,t){e.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");var n=Ql(e);e.y_.add(3),await Bl(e),n&&e.b_.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.y_.delete(3),await Ul(e)}async function tc(e,t){t?(e.y_.delete(2),await Ul(e)):(e.y_.add(2),await Bl(e),e.b_.set("Unknown"))}function nc(t){return t.v_||(t.v_=(e=t.datastore,n=t.asyncQueue,r={_o:async function(n){n.p_.forEach((e,t)=>{Kl(n,e)})}.bind(null,t),uo:async function(e,t){Hl(e),$l(e)?(e.b_.m_(t),zl(e)):e.b_.set("Unknown")}.bind(null,t),r_:async function(e,r,t){if(e.b_.set("Online"),r instanceof Vo&&2===r.state&&r.cause)try{(async function(e){var t=r.cause;for(const n of r.targetIds)e.p_.has(n)&&(await e.remoteSyncer.rejectListen(n,t),e.p_.delete(n),e.D_.removeTarget(n))})(e)}catch(t){m("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),t),await Wl(e,t)}else if(r instanceof Oo?e.D_.We(r):r instanceof Po?e.D_.Ze(r):e.D_.je(r),!t.isEqual(E.min()))try{const r=await rl(e.localStore);0<=t.compareTo(r)&&(s=t,(n=(i=e).D_.st(s)).targetChanges.forEach((e,t)=>{var n;0<e.resumeToken.approximateByteSize()&&(n=i.p_.get(t))&&i.p_.set(t,n.withResumeToken(e.resumeToken,s))}),n.targetMismatches.forEach((e,t)=>{var n=i.p_.get(e);n&&(i.p_.set(e,n.withResumeToken(ws.EMPTY_BYTE_STRING,n.snapshotVersion)),jl(i,e),e=new gu(n.target,e,t,n.sequenceNumber),Kl(i,e))}),await i.remoteSyncer.applyRemoteEvent(n))}catch(r){m("RemoteStore","Failed to raise snapshot:",r),await Wl(e,r)}var i,s,n}.bind(null,t)},e.P_(),new Ll(n,e.connection,e.authCredentials,e.appCheckCredentials,e.serializer,r)),t.w_.push(async e=>{e?(t.v_.Go(),$l(t)?zl(t):t.b_.set("Unknown")):(await t.v_.stop(),Hl(t))})),t.v_;var e,n,r}function rc(t){return t.C_||(t.C_=(e=t.datastore,n=t.asyncQueue,r={_o:async function(e){rc(e).l_()}.bind(null,t),uo:async function(e,t){if(t&&rc(e).__){var n=e,r=t;if(To(t=r.code)&&t!==w.ABORTED){const i=n.g_.shift();rc(n).Go(),await Yl(n,()=>n.remoteSyncer.rejectFailedWrite(i.batchId,r)),await Xl(n)}await 0}Jl(e)&&Zl(e)}.bind(null,t),c_:async function(e){var t=rc(e);for(const n of e.g_)t.a_(n.mutations)}.bind(null,t),u_:async function(e,t,n){const r=e.g_.shift(),i=bo.from(r,t,n);await Yl(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await Xl(e)}.bind(null,t)},e.P_(),new Fl(n,e.connection,e.authCredentials,e.appCheckCredentials,e.serializer,r)),t.w_.push(async e=>{e?(t.C_.Go(),await Xl(t)):(await t.C_.stop(),0<t.g_.length&&(m("RemoteStore",`Stopping write stream with ${t.g_.length} pending writes`),t.g_=[]))})),t.C_;var e,n,r}class ic{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Wr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,i){var s=Date.now()+n,e=new ic(e,t,s,r,i);return e.start(n),e}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new _(w.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function sc(e,t){if(d("AsyncQueue",t+": "+e),Si(e))return new _(w.UNAVAILABLE,t+": "+e);throw e}class ac{constructor(n){this.comparator=n?(e,t)=>n(e,t)||S.comparator(e.key,t.key):(e,t)=>S.comparator(e.key,t.key),this.keyedMap=Ba(),this.sortedSet=new C(this.comparator)}static emptySet(e){return new ac(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){e=this.keyedMap.get(e);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){var t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof ac))return!1;if(this.size!==e.size)return!1;for(var t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){var n=new ac;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class oc{constructor(){this.F_=new C(S.comparator)}track(e){var t=e.doc.key,n=this.F_.get(t);!n||0!==e.type&&3===n.type?this.F_=this.F_.insert(t,e):3===e.type&&1!==n.type?this.F_=this.F_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.F_=this.F_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.F_=this.F_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.F_=this.F_.remove(t):1===e.type&&2===n.type?this.F_=this.F_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.F_=this.F_.insert(t,{type:2,doc:e.doc}):b()}M_(){const n=[];return this.F_.inorderTraversal((e,t)=>{n.push(t)}),n}}class uc{constructor(e,t,n,r,i,s,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new uc(e,t,ac.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&ka(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;var t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class hc{constructor(){this.x_=void 0,this.listeners=[]}}class lc{constructor(){this.queries=new Pa(e=>Ra(e),ka),this.onlineState="Unknown",this.O_=new Set}}async function cc(e,t){const n=e,r=t.query;let i=!1,s=n.queries.get(r);if(s||(i=!0,s=new hc),i)try{s.x_=await n.onListen(r)}catch(e){const n=sc(e,`Initialization of query '${Ma(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,s),s.listeners.push(t),t.N_(n.onlineState),s.x_&&t.B_(s.x_)&&fc(n)}async function dc(e,t){var n=t.query;let r=!1;var i=e.queries.get(n);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),r=0===i.listeners.length)}if(r)return e.queries.delete(n),e.onUnlisten(n)}function fc(e){e.O_.forEach(e=>{e.next()})}class gc{constructor(e,t,n){this.query=e,this.L_=t,this.k_=!1,this.q_=null,this.onlineState="Unknown",this.options=n||{}}B_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new uc(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.k_?this.Q_(e)&&(this.L_.next(e),t=!0):this.K_(e,this.onlineState)&&(this.U_(e),t=!0),this.q_=e,t}onError(e){this.L_.error(e)}N_(e){this.onlineState=e;let t=!1;return this.q_&&!this.k_&&this.K_(this.q_,e)&&(this.U_(this.q_),t=!0),t}K_(e,t){return!e.fromCache||(!this.options.W_||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Q_(e){var t;return 0<e.docChanges.length||(t=this.q_&&this.q_.hasPendingWrites!==e.hasPendingWrites,!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges)}U_(e){e=uc.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.k_=!0,this.L_.next(e)}}class mc{constructor(e,t){this.G_=e,this.byteLength=t}z_(){return"metadata"in this.G_}}class pc{constructor(e){this.serializer=e}os(e){return Zo(this.serializer,e)}_s(e){return e.metadata.exists?su(this.serializer,e.document,!1):k.newNoDocument(this.os(e.metadata.name),this.us(e.metadata.readTime))}us(e){return O(e)}}class yc{constructor(e,t,n){this.j_=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=vc(e)}H_(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;var n;return e.G_.namedQuery?this.queries.push(e.G_.namedQuery):e.G_.documentMetadata?(this.documents.push({metadata:e.G_.documentMetadata}),e.G_.documentMetadata.exists||++t,n=T.fromString(e.G_.documentMetadata.name),this.collectionGroups.add(n.get(n.length-2))):e.G_.document&&(this.documents[this.documents.length-1].document=e.G_.document,++t),t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}J_(e){const t=new Map,n=new pc(this.serializer);for(const i of e)if(i.metadata.queries){const e=n.os(i.metadata.name);for(const n of i.metadata.queries){var r=(t.get(n)||L()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const i=e;let s=L(),a=Va;for(const e of n){const n=t.os(e.metadata.name);e.document&&(s=s.add(n));var o=t._s(e);o.setReadTime(t.us(e.metadata.readTime)),a=a.insert(n,o)}const u=i.Xi.newChangeBuffer({trackRemovals:!0}),h=await sl(i,Ca(Ia(T.fromString("__bundle__/docs/"+r))));return i.persistence.runTransaction("Apply bundle documents","readwrite",t=>il(t,u,a).next(e=>(u.apply(t),e)).next(e=>i.kr.removeMatchingKeysForTargetId(t,h.targetId).next(()=>i.kr.addMatchingKeys(t,s,h.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(t,e.ns,e.rs)).next(()=>e.ns)))}(this.localStore,new pc(this.serializer),this.documents,this.j_.id),t=this.J_(this.documents);for(const e of this.queries)await async function(e,n,r=L()){const i=await sl(e,Ca(Eu(n.bundledQuery))),s=e;return s.persistence.runTransaction("Save named query","readwrite",e=>{var t=O(n.readTime);return 0<=i.snapshotVersion.compareTo(t)?s.Qr.saveNamedQuery(e,n):(t=i.withResumeToken(ws.EMPTY_BYTE_STRING,t),s.Ji=s.Ji.insert(t.targetId,t),s.kr.updateTargetData(e,t).next(()=>s.kr.removeMatchingKeysForTargetId(e,i.targetId)).next(()=>s.kr.addMatchingKeys(e,r,i.targetId)).next(()=>s.Qr.saveNamedQuery(e,n)))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Y_:this.collectionGroups,Z_:e}}}function vc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class wc{constructor(e){this.key=e}}class _c{constructor(e){this.key=e}}class bc{constructor(e,t){this.query=e,this.X_=t,this.ea=null,this.hasCachedResults=!1,this.current=!1,this.ta=L(),this.mutatedKeys=L(),this.na=Oa(e),this.ra=new ac(this.na)}get ia(){return this.X_}sa(e,t){const a=t?t.oa:new oc,o=(t||this).ra;let u=(t||this).mutatedKeys,h=o,l=!1;const c="F"===this.query.limitType&&o.size===this.query.limit?o.last():null,d="L"===this.query.limitType&&o.size===this.query.limit?o.first():null;if(e.inorderTraversal((e,t)=>{var n=o.get(e),t=La(this.query,t)?t:null,r=!!n&&this.mutatedKeys.has(n.key),i=!!t&&(t.hasLocalMutations||this.mutatedKeys.has(t.key)&&t.hasCommittedMutations);let s=!1;n&&t?n.data.isEqual(t.data)?r!==i&&(a.track({type:3,doc:t}),s=!0):!this._a(n,t)&&(a.track({type:2,doc:t}),s=!0,c&&0<this.na(t,c)||d&&this.na(t,d)<0)&&(l=!0):!n&&t?(a.track({type:0,doc:t}),s=!0):n&&!t&&(a.track({type:1,doc:n}),s=!0,c||d)&&(l=!0),s&&(u=t?(h=h.add(t),i?u.add(e):u.delete(e)):(h=h.delete(e),u.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),u=u.delete(e.key),a.track({type:1,doc:e})}return{ra:h,oa:a,zi:l,mutatedKeys:u}}_a(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.ra,i=(this.ra=e.ra,this.mutatedKeys=e.mutatedKeys,e.oa.M_()),t=(i.sort((e,t)=>{return n=e.type,r=t.type,(i=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return b()}})(n)-i(r)||this.na(e.doc,t.doc);var n,r,i}),this.aa(n),t?this.ua():[]),s=0===this.ta.size&&this.current?1:0,a=s!==this.ea;return this.ea=s,0!==i.length||a?{snapshot:new uc(this.query,e.ra,r,i,e.mutatedKeys,0==s,a,!1,!!n&&0<n.resumeToken.approximateByteSize()),ca:t}:{ca:t}}N_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ra:this.ra,oa:new oc,mutatedKeys:this.mutatedKeys,zi:!1},!1)):{ca:[]}}la(e){return!this.X_.has(e)&&!!this.ra.has(e)&&!this.ra.get(e).hasLocalMutations}aa(e){e&&(e.addedDocuments.forEach(e=>this.X_=this.X_.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.X_=this.X_.delete(e)),this.current=e.current)}ua(){if(!this.current)return[];const t=this.ta,n=(this.ta=L(),this.ra.forEach(e=>{this.la(e.key)&&(this.ta=this.ta.add(e.key))}),[]);return t.forEach(e=>{this.ta.has(e)||n.push(new _c(e))}),this.ta.forEach(e=>{t.has(e)||n.push(new wc(e))}),n}ha(e){this.X_=e.ss,this.ta=L();e=this.sa(e.documents);return this.applyChanges(e,!0)}Pa(){return uc.fromInitialDocuments(this.query,this.ra,this.mutatedKeys,0===this.ea,this.hasCachedResults)}}class Ic{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Ec{constructor(e){this.key=e,this.Ia=!1}}class Tc{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Ta={},this.Ea=new Pa(e=>Ra(e),ka),this.da=new Map,this.Aa=new Set,this.Ra=new C(S.comparator),this.Va=new Map,this.ma=new Oh,this.fa={},this.ga=new Map,this.pa=dh.On(),this.onlineState="Unknown",this.ya=void 0}get isPrimaryClient(){return!0===this.ya}}async function Sc(n,e,t,r,i){n.wa=(e,i,t)=>async function(e,t,n){let r=t.view.sa(i);r.zi&&(r=await ol(e.localStore,t.query,!1).then(({documents:e})=>t.view.sa(e,r)));n=n&&n.targetChanges.get(t.targetId),n=t.view.applyChanges(r,e.isPrimaryClient,n);return Rc(e,t.targetId,n.ca),n.snapshot}(n,e,t);var s=await ol(n.localStore,e,!0),a=new bc(e,s.ss),s=a.sa(s.documents),r=Fo.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState,i),i=a.applyChanges(s,n.isPrimaryClient,r),s=(Rc(n,t,i.ca),new Ic(e,t,a));return n.Ea.set(e,s),n.da.has(t)?n.da.get(t).push(e):n.da.set(t,[e]),i.snapshot}async function xc(e,t){const n=e;try{const e=await function(e,u){const h=e,l=u.snapshotVersion;let c=h.Ji;return h.persistence.runTransaction("Apply remote event","readwrite-primary",a=>{const e=h.Xi.newChangeBuffer({trackRemovals:!0}),o=(c=h.Ji,[]);u.targetChanges.forEach((t,n)=>{var r,i,s=c.get(n);if(s){o.push(h.kr.removeMatchingKeys(a,t.removedDocuments,n).next(()=>h.kr.addMatchingKeys(a,t.addedDocuments,n)));let e=s.withSequenceNumber(a.currentSequenceNumber);null!==u.targetMismatches.get(n)?e=e.withResumeToken(ws.EMPTY_BYTE_STRING,E.min()).withLastLimboFreeSnapshotVersion(E.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),c=c.insert(n,e),s=s,r=e,i=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=r.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size)||o.push(h.kr.updateTargetData(a,e))}});let t=Va,n=L();if(u.documentUpdates.forEach(e=>{u.resolvedLimboDocuments.has(e)&&o.push(h.persistence.referenceDelegate.updateLimboDocument(a,e))}),o.push(il(a,e,u.documentUpdates).next(e=>{t=e.ns,n=e.rs})),!l.isEqual(E.min())){const u=h.kr.getLastRemoteSnapshotVersion(a).next(e=>h.kr.setTargetsMetadata(a,a.currentSequenceNumber,l));o.push(u)}return D.waitFor(o).next(()=>e.apply(a)).next(()=>h.localDocuments.getLocalViewOfDocuments(a,t,n)).next(()=>t)}).then(e=>(h.Ji=c,e))}(n.localStore,t);t.targetChanges.forEach((e,t)=>{t=n.Va.get(t);t&&(y(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?t.Ia=!0:0<e.modifiedDocuments.size?y(t.Ia):0<e.removedDocuments.size&&(y(t.Ia),t.Ia=!1))}),await Lc(n,e,t)}catch(e){await _i(e)}}function Dc(n,r,e){var t=n;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const n=[];t.Ea.forEach((e,t)=>{t=t.view.N_(r);t.snapshot&&n.push(t.snapshot)});{e=t.eventManager;var i=r;e.onlineState=i;let n=!1;e.queries.forEach((e,t)=>{for(const e of t.listeners)e.N_(i)&&(n=!0)}),n&&fc(e)}n.length&&t.Ta.r_(n),t.onlineState=r,t.isPrimaryClient&&t.sharedClientState.setOnlineState(r)}}function Cc(e,t){(e.ga.get(t)||[]).forEach(e=>{e.resolve()}),e.ga.delete(t)}function Ac(e,t,n){var r=e;let i=r.fa[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.fa[r.currentUser.toKey()]=i}}function Nc(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.da.get(e))t.Ea.delete(r),n&&t.Ta.Sa(r,n);t.da.delete(e),t.isPrimaryClient&&t.ma.Ar(e).forEach(e=>{t.ma.containsKey(e)||kc(t,e)})}function kc(e,t){e.Aa.delete(t.path.canonicalString());var n=e.Ra.get(t);null!==n&&(Gl(e.remoteStore,n),e.Ra=e.Ra.remove(t),e.Va.delete(n),Mc(e))}function Rc(e,t,n){for(const a of n)a instanceof wc?(e.ma.addReference(a.key,t),r=e,i=void 0,s=void 0,i=a.key,s=i.path.canonicalString(),r.Ra.get(i)||r.Aa.has(s)||(m("SyncEngine","New document in limbo: "+i),r.Aa.add(s),Mc(r))):a instanceof _c?(m("SyncEngine","Document no longer in limbo: "+a.key),e.ma.removeReference(a.key,t),e.ma.containsKey(a.key)||kc(e,a.key)):b();var r,i,s}function Mc(e){for(;0<e.Aa.size&&e.Ra.size<e.maxConcurrentLimboResolutions;){var t=e.Aa.values().next().value,n=(e.Aa.delete(t),new S(T.fromString(t))),t=e.pa.next();e.Va.set(t,new Ec(n)),e.Ra=e.Ra.insert(n,t),ql(e.remoteStore,new gu(Ca(Ia(n.path)),t,"TargetPurposeLimboResolution",Ri.ae))}}async function Lc(e,n,r){const i=e,s=[],a=[],o=[];if(!i.Ea.isEmpty()){i.Ea.forEach((e,t)=>{o.push(i.wa(t,n,r).then(e=>{(e||r)&&i.isPrimaryClient&&i.sharedClientState.updateQueryState(t.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(s.push(e),e=Jh.qi(t.targetId,e),a.push(e))}))}),await Promise.all(o),i.Ta.r_(s);{var t=i.localStore,u=a;const h=t;try{await h.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>D.forEach(u,t=>D.forEach(t.Li,e=>h.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>D.forEach(t.ki,e=>h.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(t){if(!Si(t))throw t;m("LocalStore","Failed to update sequence numbers: "+t)}for(const t of u){const u=t.targetId;if(!t.fromCache){const t=h.Ji.get(u),l=t.snapshotVersion,c=t.withLastLimboFreeSnapshotVersion(l);h.Ji=h.Ji.insert(u,c)}}}}}async function Fc(t,n){var r,i,s,a=t,o=[],u=[];for(const t of n){let e;var h=a.da.get(t);if(h&&0!==h.length){e=await sl(a.localStore,Ca(h[0]));for(const t of h){const n=a.Ea.get(t),l=(r=n,0,s=await ol((i=a).localStore,r.query,!0),s=r.view.ha(s),i.isPrimaryClient&&Rc(i,r.targetId,s.ca),await s);l.snapshot&&u.push(l.snapshot)}}else{h=await ul(a.localStore,t);e=await sl(a.localStore,h),await Sc(a,Oc(h),t,!1,e.resumeToken)}o.push(e)}return a.Ta.r_(u),o}function Oc(e){return ba(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Pc(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=xc.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=function(e,t){const n=e,r=n.Va.get(t);if(r&&r.Ia)return L().add(r.key);{let e=L();const r=n.da.get(t);if(r)for(const t of r){const r=n.Ea.get(t);e=e.unionWith(r.view.ia)}return e}}.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=async function(e,t,n){const r=e,i=(r.sharedClientState.updateQueryState(t,"rejected",n),r.Va.get(t)),s=i&&i.key;if(s){let e=new C(S.comparator);e=e.insert(s,k.newNoDocument(s,E.min()));const n=L().add(s),i=new Lo(E.min(),new Map,new C(I),e,n);await xc(r,i),r.Ra=r.Ra.remove(s),r.Va.delete(t),Mc(r)}else await al(r.localStore,t,!1).then(()=>Nc(r,t,n)).catch(_i)}.bind(null,e),e.Ta.r_=function(e,t){var n=e;let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.listeners)t.B_(e)&&(r=!0);i.x_=e}}r&&fc(n)}.bind(null,e.eventManager),e.Ta.Sa=function(e,t,n){var r=e.queries.get(t);if(r)for(const e of r.listeners)e.onError(n);e.queries.delete(t)}.bind(null,e.eventManager),e}function Vc(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=async function(e,t){var n=e,r=t.batch.batchId;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=i.Xi.newChangeBuffer({trackRemovals:!0});return function(e,t,r,i){const s=r.batch,n=s.keys();let a=D.resolve();return n.forEach(n=>{a=a.next(()=>i.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);y(null!==t),e.version.compareTo(t)<0&&(s.applyToRemoteDocument(e,r),e.isValidDocument())&&(e.setReadTime(r.commitVersion),i.addEntry(e))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,s))}(i,e,r,n).next(()=>n.apply(e)).next(()=>i.mutationQueue.performConsistencyCheck(e)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(t){let n=L();for(let e=0;e<t.mutationResults.length;++e)0<t.mutationResults[e].transformResults.length&&(n=n.add(t.batch.mutations[e].key));return n}(r))).next(()=>i.localDocuments.getDocuments(e,t))})}(n.localStore,t);Ac(n,r,null),Cc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Lc(n,e)}catch(e){await _i(e)}}.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=async function(e,t,n){var r=e;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return i.mutationQueue.lookupMutationBatch(t,r).next(e=>(y(null!==e),n=e.keys(),i.mutationQueue.removeMutationBatch(t,e))).next(()=>i.mutationQueue.performConsistencyCheck(t)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>i.localDocuments.getDocuments(t,n))})}(r.localStore,t);Ac(r,t,n),Cc(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Lc(r,e)}catch(n){await _i(n)}}.bind(null,e),e}class Uc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=kl(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return tl(this.persistence,new Zh,e.initialUser,this.serializer)}createPersistence(e){return new Gh(jh.zr,this.serializer)}createSharedClientState(e){return new _l}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Bc extends Uc{constructor(e,t,n){super(),this.Da=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Da.initialize(this,e),await Vc(this.Da.syncEngine),await Xl(this.Da.remoteStore),await this.persistence.Vi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return tl(this.persistence,new Zh,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new wh(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){t=new ki(t,this.persistence);return new Ni(e.asyncQueue,t)}createPersistence(e){var t=Xh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?ih.withCacheSize(this.cacheSizeBytes):ih.DEFAULT;return new Hh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Al(),Nl(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new _l}}class qc extends Bc{constructor(e,t){super(e,t,!1),this.Da=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);e=this.Da.syncEngine;this.sharedClientState instanceof wl&&(this.sharedClientState.syncEngine={Gs:async function(e,t,n,r){var i=await function(e,n){const r=e,i=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>i.Dn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):D.resolve(null)))}(e.localStore,t);null!==i?("pending"===n?await Xl(e.remoteStore):"acknowledged"===n||"rejected"===n?(Ac(e,t,r||null),Cc(e,t),e.localStore.mutationQueue.Cn(t)):b(),await Lc(e,i)):m("SyncEngine","Cannot apply mutation batch with id: "+t)}.bind(null,e),zs:async function(e,t,n,r){var i=e;if(i.ya)m("SyncEngine","Ignoring unexpected query state notification.");else{var s=i.da.get(t);if(s&&0<s.length)switch(n){case"current":case"not-current":{const e=await hl(i.localStore,Fa(s[0])),r=Lo.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,ws.EMPTY_BYTE_STRING);await Lc(i,e,r);break}case"rejected":await al(i.localStore,t,!0),Nc(i,t,r);break;default:b()}}}.bind(null,e),js:async function(e,t,n){const r=Pc(e);if(r.ya){for(const e of t)if(r.da.has(e))m("SyncEngine","Adding an already active target "+e);else{const t=await ul(r.localStore,e),n=await sl(r.localStore,t);await Sc(r,Oc(t),n.targetId,!1,n.resumeToken),ql(r.remoteStore,n)}for(const e of n)r.da.has(e)&&await al(r.localStore,e,!1).then(()=>{Gl(r.remoteStore,e),Nc(r,e)}).catch(_i)}}.bind(null,e),Ni:function(e){return e.localStore.persistence.Ni()}.bind(null,e),Ws:async function(e,t){const n=e;return hl(n.localStore,t).then(e=>Lc(n,e))}.bind(null,e)},await this.sharedClientState.start()),await this.persistence.Vi(async e=>{{var r=this.Da.syncEngine,t=e;const i=r;if(Pc(i),Vc(i),!0===t&&!0!==i.ya){const r=i.sharedClientState.getAllActiveQueryTargets(),t=await Fc(i,r.toArray());i.ya=!0,await tc(i.remoteStore,!0);for(const r of t)ql(i.remoteStore,r)}else if(!1===t&&!1!==i.ya){const r=[];let n=Promise.resolve();i.da.forEach((e,t)=>{i.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Nc(i,t),al(i.localStore,t,!0))),Gl(i.remoteStore,t)}),await n,await Fc(i,r);{const s=i;s.Va.forEach((e,t)=>{Gl(s.remoteStore,t)}),s.ma.Rr(),s.Va=new Map,s.Ra=new C(S.comparator)}i.ya=!1,await tc(i.remoteStore,!1)}}await 0,this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t,n=Al();if(wl.v(n))return t=Xh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),new wl(n,e.asyncQueue,t,e.clientId,e.initialUser);throw new _(w.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.")}}class Gc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Dc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=async function(e,t){var n,r=e;r.currentUser.isEqual(t)||(m("SyncEngine","User change. New user:",t.toKey()),n=await nl(r.localStore,t),r.currentUser=t,(e=r).ga.forEach(e=>{e.forEach(e=>{e.reject(new _(w.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.ga.clear(),r.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),await Lc(r,n.ts))}.bind(null,this.syncEngine),await tc(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new lc}createDatastore(e){var t=kl(e.databaseInfo.databaseId),n=(s=e.databaseInfo,new Cl(s)),r=e.authCredentials,i=e.appCheckCredentials,s=n;return e=t,new Ol(r,i,s,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>Dc(this.syncEngine,e,0),e=new(Il.v()?Il:bl),new Vl(t,n,r,i,e);var t,n,r,i}createSyncEngine(e,t){var n=this.localStore,r=this.remoteStore,i=this.eventManager,s=this.sharedClientState,a=e.initialUser,e=e.maxConcurrentLimboResolutions;return n=new Tc(n,r,i,s,a,e),t&&(n.ya=!0),n}terminate(){return async function(e){m("RemoteStore","RemoteStore shutting down."),e.y_.add(5),await Bl(e),e.S_.shutdown(),e.b_.set("Unknown")}(this.remoteStore)}}function Kc(t,n=10240){let r=0;return{async read(){var e;return r<t.byteLength?(e={value:t.slice(r,r+n),done:!1},r+=n,e):{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class jc{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.va(this.observer.next,e)}error(e){this.observer.error?this.va(this.observer.error,e):d("Uncaught Error in snapshot listener:",e.toString())}Ca(){this.muted=!0}va(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class zc{constructor(e,t){this.Fa=e,this.serializer=t,this.metadata=new Wr,this.buffer=new Uint8Array,this.Ma=new TextDecoder("utf-8"),this.xa().then(e=>{e&&e.z_()?this.metadata.resolve(e.G_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             `+JSON.stringify(null==e?void 0:e.G_)))},e=>this.metadata.reject(e))}close(){return this.Fa.cancel()}async getMetadata(){return this.metadata.promise}async ba(){return await this.getMetadata(),this.xa()}async xa(){var e,t,n=await this.Oa();return null===n?null:(e=this.Ma.decode(n),t=Number(e),isNaN(t)&&this.Na(`length string (${e}) is not valid number`),e=await this.Ba(t),new mc(JSON.parse(e),n.length+t))}La(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Oa(){for(;this.La()<0&&!await this.ka(););var e,t;return 0===this.buffer.length?null:((e=this.La())<0&&this.Na("Reached the end of bundle when a length string is expected."),t=this.buffer.slice(0,e),this.buffer=this.buffer.slice(e),t)}async Ba(e){for(;this.buffer.length<e;)await this.ka()&&this.Na("Reached the end of bundle when more is expected.");var t=this.Ma.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Na(e){throw this.Fa.cancel(),new Error("Invalid bundle format: "+e)}async ka(){var e,t=await this.Fa.read();return t.done||((e=new Uint8Array(this.buffer.length+t.value.length)).set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e),t.done}}class $c{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new _(w.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");e=await async function(e,t){const a=e,n=nu(a.serializer)+"/documents",r={documents:t.map(e=>Jo(a.serializer,e))},i=await a.yo("BatchGetDocuments",n,r,t.length),o=new Map,s=(i.forEach(e=>{i=a.serializer;var t,n,r,i,s="found"in e?(s=i,y(!!(t=e).found),t.found.name,t.found.updateTime,s=Zo(s,t.found.name),n=O(t.found.updateTime),r=t.found.createTime?O(t.found.createTime):E.min(),t=new $s({mapValue:{fields:t.found.fields}}),k.newFoundDocument(s,n,r,t)):"missing"in e?function(e,t){y(!!t.missing),y(!!t.readTime);e=Zo(e,t.missing),t=O(t.readTime);return k.newNoDocument(e,t)}(i,e):b();o.set(s.key.toString(),s)}),[]);return t.forEach(e=>{e=o.get(e.toString());y(!!e),s.push(e)}),s}(this.datastore,e);return e.forEach(e=>this.recordVersion(e)),e}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new vo(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{t=S.fromPath(t);this.mutations.push(new wo(t,this.precondition(t)))});{var e=this.datastore,n=this.mutations;const r=e,i=nu(r.serializer)+"/documents",s={writes:n.map(e=>au(r.serializer,e))};await r.Vo("Commit",i,s)}await 0,this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw b();t=E.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new _(w.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){var t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(E.min())?F.exists(!1):F.updateTime(t):F.none()}preconditionForUpdate(e){var t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return F.exists(!0);if(t.isEqual(E.min()))throw new _(w.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return F.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Qc{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.qa=n.maxAttempts,this.Ko=new Rl(this.asyncQueue,"transaction_retry")}run(){--this.qa,this.Qa()}Qa(){this.Ko.xo(async()=>{const t=new $c(this.datastore),e=this.Ka(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.$a(e)}))}).catch(e=>{this.$a(e)})})}Ka(e){try{var t=this.updateFunction(e);return!Mi(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}$a(e){0<this.qa&&this.Ua(e)?(--this.qa,this.asyncQueue.enqueueAndForget(()=>(this.Qa(),Promise.resolve()))):this.deferred.reject(e)}Ua(e){return"FirebaseError"===e.name&&("aborted"===(e=e.code)||"failed-precondition"===e||"already-exists"===e||!To(e))}}class Hc{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=o.UNAUTHENTICATED,this.clientId=ii.V(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{m("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(m("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new _(w.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Wr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=sc(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function Wc(e,t){e.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await nl(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function Yc(e,n){e.asyncQueue.verifyOperationInProgress();var t=await Jc(e),r=(m("FirestoreClient","Initializing OnlineComponentProvider"),await e.getConfiguration());await n.initialize(t,r),e.setCredentialChangeListener(e=>ec(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>ec(n.remoteStore,t)),e._onlineComponents=n}function Xc(e){return"FirebaseError"===e.name?e.code===w.FAILED_PRECONDITION||e.code===w.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Jc(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){m("FirestoreClient","Using user provided OfflineComponentProvider");try{await Wc(t,t._uninitializedComponentsProvider._offline)}catch(e){var n=e;if(!Xc(n))throw n;Qr("Error using user provided cache. Falling back to memory cache: "+n),await Wc(t,new Uc)}}else m("FirestoreClient","Using default OfflineComponentProvider"),await Wc(t,new Uc);return t._offlineComponents}async function Zc(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(m("FirestoreClient","Using user provided OnlineComponentProvider"),await Yc(e,e._uninitializedComponentsProvider._online)):(m("FirestoreClient","Using default OnlineComponentProvider"),await Yc(e,new Gc))),e._onlineComponents}function ed(e){return Jc(e).then(e=>e.persistence)}function td(e){return Jc(e).then(e=>e.localStore)}function nd(e){return Zc(e).then(e=>e.remoteStore)}function rd(e){return Zc(e).then(e=>e.syncEngine)}async function id(e){var e=await Zc(e),t=e.eventManager;return t.onListen=async function(e,t){var n=Pc(e);let r,i;const s=n.Ea.get(t);if(s)r=s.targetId,n.sharedClientState.addLocalQueryTarget(r),i=s.view.Pa();else{const e=await sl(n.localStore,Ca(t)),s=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,i=await Sc(n,t,r,"current"===s,e.resumeToken),n.isPrimaryClient&&ql(n.remoteStore,e)}return i}.bind(null,e.syncEngine),t.onUnlisten=async function(e,t){const n=e,r=n.Ea.get(t),i=n.da.get(r.targetId);1<i.length?(n.da.set(r.targetId,i.filter(e=>!ka(e,t))),n.Ea.delete(t)):n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await al(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Gl(n.remoteStore,r.targetId),Nc(n,r.targetId)}).catch(_i)):(Nc(n,r.targetId),await al(n.localStore,r.targetId,!0))}.bind(null,e.syncEngine),t}function sd(t,u,h={}){const l=new Wr;return t.asyncQueue.enqueueAndForget(async()=>{{var n=await id(t),r=t.asyncQueue,i=u,s=h,a=l;const e=new jc({next:e=>{r.enqueueAndForget(()=>dc(n,o));var t=e.docs.has(i);!t&&e.fromCache?a.reject(new _(w.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&s&&"server"===s.source?a.reject(new _(w.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new gc(Ia(i.path),e,{includeMetadataChanges:!0,W_:!0});return cc(n,o)}}),l.promise}function ad(o,u,h={}){const l=new Wr;return o.asyncQueue.enqueueAndForget(async()=>{{var t=await id(o),n=o.asyncQueue,e=u,r=h,i=l;const s=new jc({next:e=>{n.enqueueAndForget(()=>dc(t,a)),e.fromCache&&"server"===r.source?i.reject(new _(w.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(e)},error:e=>i.reject(e)}),a=new gc(e,s,{includeMetadataChanges:!0,W_:!0});return cc(t,a)}}),l.promise}function od(r,e,t,i){e=kl(e),t=function(e){if(e instanceof Uint8Array)return Kc(e,void 0);if(e instanceof ArrayBuffer)return Kc(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof t?Co().encode(t):t);const s=new zc(t,e);r.asyncQueue.enqueueAndForget(async()=>{{var e=await rd(r),t=s;const n=e;!async function(t,n,r){try{var i=await n.getMetadata();if(await function(e,t){const n=e,r=O(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Qr.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,i))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);r._updateProgress(vc(i));var s=new yc(i,t.localStore,n.serializer);let e=await n.ba();for(;e;){const t=await s.H_(e);t&&r._updateProgress(t),e=await n.ba()}var a=await s.complete();return await Lc(t,a.Z_,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Qr.saveBundleMetadata(e,t))}(t.localStore,i),r._completeWith(a.progress),Promise.resolve(a.Y_)}catch(t){return Qr("SyncEngine","Loading bundle failed with "+t),r._failWith(t),Promise.resolve(new Set)}}(n,t,i).then(e=>{n.sharedClientState.notifyBundleLoaded(e)})}})}function ud(e){var t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const hd=new Map;function ld(e,t,n){if(!n)throw new _(w.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function cd(e,t,n,r){if(!0===t&&!0===r)throw new _(w.INVALID_ARGUMENT,e+` and ${n} cannot be used together.`)}function dd(e){if(!S.isDocumentKey(e))throw new _(w.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function fd(e){if(S.isDocumentKey(e))throw new _(w.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function gd(e){return void 0===e?"undefined":null===e?"null":"string"==typeof e?(20<e.length&&(e=e.substring(0,20)+"..."),JSON.stringify(e)):"number"==typeof e||"boolean"==typeof e?""+e:"object"!=typeof e?"function"==typeof e?"a function":b():e instanceof Array?"an array":(e=e.constructor?e.constructor.name:null)?`a custom ${e} object`:"an object"}function P(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new _(w.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");e=gd(e);throw new _(w.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: `+e)}function md(e,t){if(t<=0)throw new _(w.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class pd{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new _(w.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new _(w.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}cd("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=ud(null!=(t=e.experimentalLongPollingOptions)?t:{});var t=this.experimentalLongPollingOptions;if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(30<t.timeoutSeconds)throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class yd{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new pd({}),this._settingsFrozen=!1}get app(){if(this._app)return this._app;throw new _(w.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available")}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new _(w.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new pd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Xr;switch(e.type){case"firstParty":return new ti(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new _(w.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return e=this,(t=hd.get(e))&&(m("ComponentProvider","Removing Datastore"),hd.delete(e),t.terminate()),Promise.resolve();var e,t}}class vd{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new vd(this.firestore,e,this._query)}}class V{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new wd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new V(this.firestore,e,this._key)}}class wd extends vd{constructor(e,t,n){super(e,t,Ia(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){var e=this._path.popLast();return e.isEmpty()?null:new V(this.firestore,null,new S(e))}withConverter(e){return new wd(this.firestore,e,this._path)}}function _d(e,t,...n){var r;if(e=v(e),ld("collection","path",t),e instanceof yd)return fd(r=T.fromString(t,...n)),new wd(e,null,r);if(e instanceof V||e instanceof wd)return fd(r=e._path.child(T.fromString(t,...n))),new wd(e.firestore,null,r);throw new _(w.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function bd(e,t,...n){var r;if(e=v(e),ld("doc","path",t=1===arguments.length?ii.V():t),e instanceof yd)return dd(r=T.fromString(t,...n)),new V(e,null,new S(r));if(e instanceof V||e instanceof wd)return dd(r=e._path.child(T.fromString(t,...n))),new V(e.firestore,e instanceof wd?e.converter:null,new S(r));throw new _(w.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function Id(e,t){return e=v(e),t=v(t),(e instanceof V||e instanceof wd)&&(t instanceof V||t instanceof wd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Ed(e,t){return e=v(e),t=v(t),e instanceof vd&&t instanceof vd&&e.firestore===t.firestore&&ka(e._query,t._query)&&e.converter===t.converter}class Td{constructor(){this.Wa=Promise.resolve(),this.Ga=[],this.za=!1,this.ja=[],this.Ha=null,this.Ja=!1,this.Ya=!1,this.Za=[],this.Ko=new Rl(this,"async_queue_retry"),this.Xa=()=>{var e=Nl();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Ko.No()};var e=Nl();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Xa)}get isShuttingDown(){return this.za}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.eu(),this.tu(e)}enterRestrictedMode(e){this.za||(this.za=!0,this.Ya=e||!1,(e=Nl())&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Xa))}enqueue(e){if(this.eu(),this.za)return new Promise(()=>{});const t=new Wr;return this.tu(()=>this.za&&this.Ya?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Ga.push(e),this.nu()))}async nu(){if(0!==this.Ga.length){try{await this.Ga[0](),this.Ga.shift(),this.Ko.reset()}catch(e){if(!Si(e))throw e;m("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Ga.length&&this.Ko.xo(()=>this.nu())}}tu(e){var t=this.Wa.then(()=>(this.Ja=!0,e().catch(e=>{throw this.Ha=e,this.Ja=!1,d("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return t=e.stack?e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack:t}(e)),e}).then(e=>(this.Ja=!1,e))));return this.Wa=t}enqueueAfterDelay(e,t,n){this.eu(),-1<this.Za.indexOf(e)&&(t=0);e=ic.createAndSchedule(this,e,t,n,e=>this.ru(e));return this.ja.push(e),e}eu(){this.Ha&&b()}verifyOperationInProgress(){}async iu(){for(var e;await(e=this.Wa),e!==this.Wa;);}su(e){for(const t of this.ja)if(t.timerId===e)return!0;return!1}ou(t){return this.iu().then(()=>{this.ja.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.ja)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.iu()})}_u(e){this.Za.push(e)}ru(e){e=this.ja.indexOf(e);this.ja.splice(e,1)}}function Sd(e){var t=e;if("object"==typeof t&&null!==t){var n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return 1}}class xd{constructor(){this._progressObserver={},this._taskCompletionResolver=new Wr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class U extends yd{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Td,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Cd(this),this._firestoreClient.terminate()}}function Dd(e){return e._firestoreClient||Cd(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Cd(e){var t,n,r,i,s=e._freezeSettings(),a=(t=e._databaseId,n=(null==(a=e._app)?void 0:a.options.appId)||"",r=e._persistenceKey,i=s,new xs(t,n,r,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,ud(i.experimentalLongPollingOptions),i.useFetchStreams));e._firestoreClient=new Hc(e._authCredentials,e._appCheckCredentials,e._queue,a),null!=(a=s.localCache)&&a._offlineComponentProvider&&null!=(t=s.localCache)&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.localCache.kind,_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider})}function Ad(e,t,n){const r=new Wr;return e.asyncQueue.enqueue(async()=>{try{await Wc(e,n),await Yc(e,t),r.resolve()}catch(e){const t=e;if(!Xc(t))throw t;Qr("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function Nd(t,e){return r=Dd(t=P(t,U)),i=e,r.asyncQueue.enqueue(async()=>{{var e=await td(r),t=i;const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Qr.getNamedQuery(e,t))}}).then(e=>e?new vd(t,null,e.query):null);var r,i}function kd(e){if(e._initialized||e._terminated)throw new _(w.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Rd{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Rd(ws.fromBase64String(e))}catch(e){throw new _(w.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Rd(ws.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Md{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new _(w.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new f(t)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Ld{constructor(e){this._methodName=e}}class Fd{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new _(w.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new _(w.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return I(this._lat,e._lat)||I(this._long,e._long)}}const Od=/^__.*__$/;class Pd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new go(e,this.data,this.fieldMask,t,this.fieldTransforms):new fo(e,this.data,t,this.fieldTransforms)}}class Vd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new go(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Ud(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw b()}}class Bd{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.au(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get uu(){return this.settings.uu}cu(e){return new Bd(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}lu(e){var t=null==(t=this.path)?void 0:t.child(e),t=this.cu({path:t,hu:!1});return t.Pu(e),t}Iu(e){var t=null==(t=this.path)?void 0:t.child(e),e=this.cu({path:t,hu:!1});return e.au(),e}Tu(e){return this.cu({path:void 0,hu:!0})}Eu(e){return of(e,this.settings.methodName,this.settings.du||!1,this.path,this.settings.Au)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}au(){if(this.path)for(let e=0;e<this.path.length;e++)this.Pu(this.path.get(e))}Pu(e){if(0===e.length)throw this.Eu("Document fields must not be empty");if(Ud(this.uu)&&Od.test(e))throw this.Eu('Document fields cannot begin and end with "__"')}}class qd{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||kl(e)}Ru(e,t,n,r=!1){return new Bd({uu:e,methodName:t,Au:n,path:f.emptyPath(),hu:!1,du:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Gd(e){var t=e._freezeSettings(),n=kl(e._databaseId);return new qd(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Kd(e,t,n,r,i,s={}){var a=e.Ru(s.merge||s.mergeFields?2:0,t,n,i),e=(nf("Data must be an object, but it was:",a,r),ef(r,a));let o,u;if(s.merge)o=new ys(a.fieldMask),u=a.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=rf(t,r,n);if(!a.contains(i))throw new _(w.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);uf(e,i)||e.push(i)}o=new ys(e),u=a.fieldTransforms.filter(e=>o.covers(e.field))}else o=null,u=a.fieldTransforms;return new Pd(new $s(e),o,u)}class jd extends Ld{_toFieldTransform(e){if(2!==e.uu)throw 1===e.uu?e.Eu(this._methodName+"() can only appear at the top level of your update data"):e.Eu(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof jd}}function zd(e,t,n){return new Bd({uu:3,Au:t.settings.Au,methodName:e._methodName,hu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class $d extends Ld{_toFieldTransform(e){return new so(e.path,new Xa)}isEqual(e){return e instanceof $d}}class Qd extends Ld{constructor(e,t){super(e),this.Vu=t}_toFieldTransform(e){const t=zd(this,e,!0),n=this.Vu.map(e=>Zd(e,t)),r=new Ja(n);return new so(e.path,r)}isEqual(e){return this===e}}class Hd extends Ld{constructor(e,t){super(e),this.Vu=t}_toFieldTransform(e){const t=zd(this,e,!0),n=this.Vu.map(e=>Zd(e,t)),r=new eo(n);return new so(e.path,r)}isEqual(e){return this===e}}class Wd extends Ld{constructor(e,t){super(e),this.mu=t}_toFieldTransform(e){var t=new no(e.serializer,Ha(e.serializer,this.mu));return new so(e.path,t)}isEqual(e){return this===e}}function Yd(e,i,s,t){const a=e.Ru(1,i,s),o=(nf("Data must be an object, but it was:",a,t),[]),u=$s.empty();cs(t,(e,t)=>{var n=af(i,e,s),r=(t=v(t),a.Iu(n));if(t instanceof jd)o.push(n);else{const e=Zd(t,r);null!=e&&(o.push(n),u.set(n,e))}});e=new ys(o);return new Vd(u,e,a.fieldTransforms)}function Xd(t,n,e,r,i,s){var a=t.Ru(1,n,e),o=[rf(n,r,e)],u=[i];if(s.length%2!=0)throw new _(w.INVALID_ARGUMENT,`Function ${n}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(rf(n,s[e])),u.push(s[e+1]);var h=[],l=$s.empty();for(let e=o.length-1;0<=e;--e)if(!uf(h,o[e])){const n=o[e];var c=v(u[e]);const r=a.Iu(n);if(c instanceof jd)h.push(n);else{const t=Zd(c,r);null!=t&&(h.push(n),l.set(n,t))}}t=new ys(h);return new Vd(l,t,a.fieldTransforms)}function Jd(e,t,n,r=!1){return Zd(n,e.Ru(r?4:3,t))}function Zd(e,n){if(tf(e=v(e)))return nf("Unsupported field value:",n,e),ef(e,n);if(e instanceof Ld){{var t=e;var r=n;if(!Ud(r.uu))throw r.Eu(t._methodName+"() can only be used with update() and set()");if(!r.path)throw r.Eu(t._methodName+"() is not currently supported inside arrays");t=t._toFieldTransform(r);t&&r.fieldTransforms.push(t)}return null}if(void 0===e&&n.ignoreUndefinedProperties)return null;if(n.path&&n.fieldMask.push(n.path),e instanceof Array){if(n.settings.hu&&4!==n.uu)throw n.Eu("Nested arrays are not supported");{var i=n,s=[];let t=0;for(const o of e){let e=Zd(o,i.Tu(t));null==e&&(e={nullValue:"NULL_VALUE"}),s.push(e),t++}return{arrayValue:{values:s}}}}r=0,t=n;if(null===(r=v(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof r)return Ha(t.serializer,r);if("boolean"==typeof r)return{booleanValue:r};if("string"==typeof r)return{stringValue:r};if(r instanceof Date)return a=l.fromDate(r),{timestampValue:Ho(t.serializer,a)};if(r instanceof l)return a=new l(r.seconds,1e3*Math.floor(r.nanoseconds/1e3)),{timestampValue:Ho(t.serializer,a)};if(r instanceof Fd)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof Rd)return{bytesValue:Wo(t.serializer,r._byteString)};if(r instanceof V){var a=t.databaseId,n=r.firestore._databaseId;if(n.isEqual(a))return{referenceValue:Yo(r.firestore._databaseId||t.databaseId,r._key.path)};throw t.Eu(`Document reference is for database ${n.projectId}/${n.database} but should be for database ${a.projectId}/`+a.database)}throw t.Eu("Unsupported field value: "+gd(r))}function ef(e,n){const r={};return ds(e)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):cs(e,(e,t)=>{t=Zd(t,n.lu(e));null!=t&&(r[e]=t)}),{mapValue:{fields:r}}}function tf(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof l||e instanceof Fd||e instanceof Rd||e instanceof V||e instanceof Ld)}function nf(e,t,n){var r;if(!tf(n)||"object"!=typeof(r=n)||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r))throw"an object"===(r=gd(n))?t.Eu(e+" a custom object"):t.Eu(e+" "+r)}function rf(e,t,n){if((t=v(t))instanceof Md)return t._internalPath;if("string"==typeof t)return af(e,t);throw of("Field path arguments must be of type string or ",e,!1,void 0,n)}const sf=new RegExp("[~\\*/\\[\\]]");function af(t,n,r){if(0<=n.search(sf))throw of(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new Md(...n.split("."))._internalPath}catch(e){throw of(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function of(e,t,n,r,i){var s=r&&!r.isEmpty(),a=void 0!==i;let o=`Function ${t}() called with invalid data`,u=(n&&(o+=" (via `toFirestore()`)"),o+=". ","");return(s||a)&&(u+=" (found",s&&(u+=" in field "+r),a&&(u+=" in document "+i),u+=")"),new _(w.INVALID_ARGUMENT,o+e+u)}function uf(e,t){return e.some(e=>e.isEqual(t))}class hf{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new V(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){var e;if(this._document)return this._converter?(e=new lf(this._firestore,this._userDataWriter,this._key,this._document,null),this._converter.fromFirestore(e)):this._userDataWriter.convertValue(this._document.data.value)}get(e){if(this._document){e=this._document.data.field(cf("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e)}}}class lf extends hf{data(){return super.data()}}function cf(e,t){return"string"==typeof t?af(e,t):(t instanceof Md?t:t._delegate)._internalPath}function df(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new _(w.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class ff{}class gf extends ff{}function mf(e,t,...n){let r=[];t instanceof ff&&r.push(t),r=r.concat(n);n=(t=r).filter(e=>!1).length,t=t.filter(e=>e instanceof pf).length;if(1<n||0<n&&0<t)throw new _(w.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.");for(const t of r)e=t._apply(e);return e}class pf extends gf{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new pf(e,t,n)}_apply(e){var t=this._parse(e);return Tf(e._query,t),new vd(e.firestore,e.converter,Aa(e._query,t))}_parse(t){var n=Gd(t.firestore);{var r=t._query,i="where",s=n,a=t.firestore._databaseId,o=(n=this._field,t=this._op,this._value);let e;if(n.isKeyField()){if("array-contains"===t||"array-contains-any"===t)throw new _(w.INVALID_ARGUMENT,`Invalid Query. You can't perform '${t}' queries on documentId().`);if("in"===t||"not-in"===t){Ef(o,t);const i=[];for(const s of o)i.push(If(a,r,s));e={arrayValue:{values:i}}}else e=If(a,r,o)}else"in"!==t&&"not-in"!==t&&"array-contains-any"!==t||Ef(o,t),e=Jd(s,i,o,"in"===t||"not-in"===t);return R.create(n,t,e)}}}(class extends ff{});class yf extends gf{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new yf(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new _(w.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new _(w.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");t=new Ys(t,n);return n=t,null===Ta(e)&&null!==(e=Sa(e))&&Sf(0,e,n.field),t}(e._query,this._field,this._direction);return new vd(e.firestore,e.converter,(t=(e=e._query).explicitOrderBy.concat([t]),new _a(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class vf extends gf{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new vf(e,t,n)}_apply(e){return new vd(e.firestore,e.converter,Na(e._query,this._limit,this._limitType))}}class wf extends gf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new wf(e,t,n)}_apply(e){var t,n=bf(e,this.type,this._docOrFields,this._inclusive);return new vd(e.firestore,e.converter,(t=e._query,e=n,new _a(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class _f extends gf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new _f(e,t,n)}_apply(e){var t,n=bf(e,this.type,this._docOrFields,this._inclusive);return new vd(e.firestore,e.converter,(t=e._query,e=n,new _a(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function bf(e,t,n,r){if(n[0]=v(n[0]),n[0]instanceof hf){var i=e._query,s=e.firestore._databaseId,a=t,o=n[0]._document,u=r;if(!o)throw new _(w.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);var h=[];for(const a of Da(i))if(a.field.isKeyField())h.push(Os(s,o.key));else{const i=o.data.field(a.field);if(Es(i))throw new _(w.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===i){const i=a.field.canonicalString();throw new _(w.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${i}' (used as the orderBy) does not exist.`)}h.push(i)}return new Qs(h,u)}var a=Gd(e.firestore),l=e._query,c=e.firestore._databaseId,d=a,f=t,g=n,i=r,m=l.explicitOrderBy;if(g.length>m.length)throw new _(w.INVALID_ARGUMENT,`Too many arguments provided to ${f}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);var p=[];for(let e=0;e<g.length;e++){var y=g[e];if(m[e].field.isKeyField()){if("string"!=typeof y)throw new _(w.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${f}(), but got a `+typeof y);if(!xa(l)&&-1!==y.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${f}() must be a plain document ID, but '${y}' contains a slash.`);const d=l.path.child(T.fromString(y));if(!S.isDocumentKey(d))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${f}() must result in a valid document path, but '${d}' is not because it contains an odd number of segments.`);const g=new S(d);p.push(Os(c,g))}else{const l=Jd(d,f,y);p.push(l)}}return new Qs(p,i)}function If(e,t,n){if("string"==typeof(n=v(n))){if(""===n)throw new _(w.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!xa(t)&&-1!==n.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);t=t.path.child(T.fromString(n));if(S.isDocumentKey(t))return Os(e,new S(t));throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${t}' is not because it has an odd number of segments (${t.length}).`)}if(n instanceof V)return Os(e,n._key);throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${gd(n)}.`)}function Ef(e,t){if(!Array.isArray(e)||0===e.length)throw new _(w.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Tf(e,t){if(t.isInequality()){const r=Sa(e),i=t.field;if(null!==r&&!r.isEqual(i))throw new _(w.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${i.toString()}'`);var n=Ta(e);null!==n&&Sf(0,i,n)}const r=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new _(w.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new _(w.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}function Sf(e,t,n){if(!n.isEqual(t))throw new _(w.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class xf{convertValue(e,t="none"){switch(Ns(e)){case 0:return null;case 1:return e.booleanValue;case 2:return N(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Is(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw b()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,n="none"){const r={};return cs(e,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new Fd(N(e.latitude),N(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=Ts(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Ss(e));default:return null}}convertTimestamp(e){e=bs(e);return new l(e.seconds,e.nanos)}convertDocumentKey(e,t){var e=T.fromString(e),n=(y(fu(e)),new Ds(e.get(1),e.get(3))),e=new S(e.popFirst(5));return n.isEqual(t)||d(`Document ${e} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),e}}function Df(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class Cf extends xf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Rd(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new V(this.firestore,null,e)}}class Af{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Nf extends hf{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){var t;if(this._document)return this._converter?(t=new kf(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null),this._converter.fromFirestore(t,e)):this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}get(e,t={}){if(this._document){e=this._document.data.field(cf("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e,t.serverTimestamps)}}}class kf extends Nf{data(e={}){return super.data(e)}}class Rf{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Af(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new kf(this._firestore,this._userDataWriter,e.key,e,new Af(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){e=!!e.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new _(w.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(s,t){if(s._snapshot.oldDocs.isEmpty()){let n=0;return s._snapshot.docChanges.map(e=>{var t=new kf(s._firestore,s._userDataWriter,e.doc.key,e.doc,new Af(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let i=s._snapshot.oldDocs;return s._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new kf(s._firestore,s._userDataWriter,e.doc.key,e.doc,new Af(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=i.indexOf(e.doc.key),i=i.delete(e.doc.key)),1!==e.type&&(i=i.add(e.doc),r=i.indexOf(e.doc.key)),{type:function(){switch(e.type){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return b()}}(),doc:t,oldIndex:n,newIndex:r}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Mf(e,t){return e instanceof Nf&&t instanceof Nf?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Rf&&t instanceof Rf&&e._firestore===t._firestore&&Ed(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class Lf extends xf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Rd(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new V(this.firestore,null,e)}}function Ff(e,t,n){e=P(e,V);var r=P(e.firestore,U),t=Df(e.converter,t,n);return Uf(r,[Kd(Gd(r),"setDoc",e._key,t,null!==e.converter,n).toMutation(e._key,F.none())])}function Of(e,t,n,...r){e=P(e,V);var i=P(e.firestore,U),s=Gd(i);return Uf(i,[("string"==typeof(t=v(t))||t instanceof Md?Xd(s,"updateDoc",e._key,t,n,r):Yd(s,"updateDoc",e._key,t)).toMutation(e._key,F.exists(!0))])}function Pf(t,...n){t=v(t);let e={includeMetadataChanges:!1},r=0;"object"!=typeof n[r]||Sd(n[r])||(e=n[r],r++);var i={includeMetadataChanges:e.includeMetadataChanges};if(Sd(n[r])){const t=n[r];n[r]=null==(h=t.next)?void 0:h.bind(t),n[r+1]=null==(h=t.error)?void 0:h.bind(t),n[r+2]=null==(h=t.complete)?void 0:h.bind(t)}let s,a,o;if(t instanceof V)a=P(t.firestore,U),o=Ia(t._key.path),s={next:e=>{n[r]&&n[r](Bf(a,t,e))},error:n[r+1],complete:n[r+2]};else{const c=P(t,vd),d=(a=P(c.firestore,U),o=c._query,new Lf(a));s={next:e=>{n[r]&&n[r](new Rf(a,d,c,e))},error:n[r+1],complete:n[r+2]},df(t._query)}{var u=Dd(a),h=o,l=s;const f=new jc(l),g=new gc(h,f,i);return u.asyncQueue.enqueueAndForget(async()=>cc(await id(u),g)),()=>{f.Ca(),u.asyncQueue.enqueueAndForget(async()=>dc(await id(u),g))}}}function Vf(e,t){{var n=Dd(e=P(e,U));e=Sd(t)?t:{next:t};const r=new jc(e);return n.asyncQueue.enqueueAndForget(async()=>{return e=await id(n),t=r,e.O_.add(t),void t.next();var e,t}),()=>{r.Ca(),n.asyncQueue.enqueueAndForget(async()=>{var e,t;e=await id(n),t=r,e.O_.delete(t)})}}}function Uf(e,t){{var n=Dd(e),r=t;const i=new Wr;return n.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){var r=Vc(t);try{const t=await function(e,i){const s=e,a=l.now(),o=i.reduce((e,t)=>e.add(t.key),L());let u,h;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Va,r=L();return s.Xi.getEntries(n,o).next(e=>{(t=e).forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>s.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;var t=[];for(const n of i){const i=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=Ya(r.transform,e||null);null!=i&&(n=null===n?$s.empty():n).set(r.field,i)}return n||null}(n,u.get(n.key).overlayedDocument);null!=i&&t.push(new go(n.key,i,function r(e){const i=[];return cs(e.fields,(e,t)=>{var n=new f([e]);if(qs(t)){const e=r(t.mapValue).fields;if(0===e.length)i.push(n);else for(const t of e)i.push(n.child(t))}else i.push(n)}),new ys(i)}(i.value.mapValue),F.exists(!0)))}return s.mutationQueue.addMutationBatch(n,a,t,i)}).next(e=>{var t=(h=e).applyToLocalDocumentSet(u,r);return s.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:h.batchId,changes:qa(u)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId);{var i=r;var s=t.batchId;var a=n;let e=i.fa[i.currentUser.toKey()];e=(e=e||new C(I)).insert(s,a),i.fa[i.currentUser.toKey()]=e}await Lc(r,t.changes),await Xl(r.remoteStore)}catch(t){const e=sc(t,"Failed to persist write");n.reject(e)}}(await rd(n),r,i)),i.promise}}function Bf(e,t,n){var r=n.docs.get(t._key),i=new Lf(e);return new Nf(e,i,t._key,r,new Af(n.hasPendingWrites,n.fromCache),t.converter)}const qf={maxAttempts:5};class Gf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Gd(e)}set(e,t,n){this._verifyNotCommitted();e=Kf(e,this._firestore),t=Df(e.converter,t,n),t=Kd(this._dataReader,"WriteBatch.set",e._key,t,null!==e.converter,n);return this._mutations.push(t.toMutation(e._key,F.none())),this}update(e,t,n,...r){this._verifyNotCommitted();e=Kf(e,this._firestore),n="string"==typeof(t=v(t))||t instanceof Md?Xd(this._dataReader,"WriteBatch.update",e._key,t,n,r):Yd(this._dataReader,"WriteBatch.update",e._key,t);return this._mutations.push(n.toMutation(e._key,F.exists(!0))),this}delete(e){this._verifyNotCommitted();e=Kf(e,this._firestore);return this._mutations=this._mutations.concat(new vo(e._key,F.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new _(w.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Kf(e,t){if((e=v(e)).firestore!==t)throw new _(w.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class jf extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Gd(e)}get(e){const t=Kf(e,this._firestore),n=new Cf(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return b();e=e[0];if(e.isFoundDocument())return new hf(this._firestore,n,e.key,e,t.converter);if(e.isNoDocument())return new hf(this._firestore,n,t._key,null,t.converter);throw b()})}set(e,t,n){e=Kf(e,this._firestore),t=Df(e.converter,t,n),t=Kd(this._dataReader,"Transaction.set",e._key,t,null!==e.converter,n);return this._transaction.set(e._key,t),this}update(e,t,n,...r){e=Kf(e,this._firestore),n="string"==typeof(t=v(t))||t instanceof Md?Xd(this._dataReader,"Transaction.update",e._key,t,n,r):Yd(this._dataReader,"Transaction.update",e._key,t);return this._transaction.update(e._key,n),this}delete(e){e=Kf(e,this._firestore);return this._transaction.delete(e._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Kf(e,this._firestore),n=new Lf(this._firestore);return super.get(e).then(e=>new Nf(this._firestore,n,t._key,e._document,new Af(!1,!1),t.converter))}}function zf(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new _("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function $f(){if("undefined"==typeof Uint8Array)throw new _("unimplemented","Uint8Arrays are not available in this environment.")}function Qf(){if("undefined"==typeof atob)throw new _("unimplemented","Blobs are unavailable in Firestore in this environment.")}Lr=vg.SDK_VERSION,jr=Lr,vg._registerComponent(new H("firestore",(e,{instanceIdentifier:t,options:n})=>{var r=e.getProvider("app").getImmediate(),e=new U(new Zr(e.getProvider("auth-internal")),new ri(e.getProvider("app-check-internal")),function(e,t){if(Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))return new Ds(e.options.projectId,t);throw new _(w.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.')}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),e._setSettings(n),e},"PUBLIC").setMultipleInstances(!0)),vg.registerVersion(Ee,"4.1.0",void 0),vg.registerVersion(Ee,"4.1.0","esm2017");class Hf{constructor(e){this._delegate=e}static fromBase64String(e){return Qf(),new Hf(Rd.fromBase64String(e))}static fromUint8Array(e){return $f(),new Hf(Rd.fromUint8Array(e))}toBase64(){return Qf(),this._delegate.toBase64()}toUint8Array(){return $f(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Wf(e){if("object"==typeof e&&null!==e){var t=e;for(const n of["next","error","complete"])if(n in t&&"function"==typeof t[n])return 1}}class Yf{enableIndexedDbPersistence(e,t){var e=e._delegate,t={forceOwnership:t},n=(kd(e=P(e,U)),Dd(e));if(n._uninitializedComponentsProvider)throw new _(w.FAILED_PRECONDITION,"SDK cache is already specified.");Qr("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var e=e._freezeSettings(),r=new Gc;return Ad(n,r,new Bc(r,e.cacheSizeBytes,null==t?void 0:t.forceOwnership))}enableMultiTabIndexedDbPersistence(e){kd(e=P(e=e._delegate,U));var t=Dd(e);if(t._uninitializedComponentsProvider)throw new _(w.FAILED_PRECONDITION,"SDK cache is already specified.");Qr("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var e=e._freezeSettings(),n=new Gc;return Ad(t,n,new qc(n,e.cacheSizeBytes))}clearIndexedDbPersistence(e){{var t=e._delegate;if(t._initialized&&!t._terminated)throw new _(w.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const n=new Wr;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{e=Xh(t._databaseId,t._persistenceKey),await(Ii.v()?(e=e+"main",void await Ii.delete(e)):Promise.resolve()),n.resolve()}catch(e){n.reject(e)}var e}),n.promise}}}class Xf{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof Ds||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Qr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(n,r,e={}){{var[n,r,e,i={}]=[this._delegate,n,r,e];const s=(n=P(n,yd))._getSettings(),t=r+":"+e;if("firestore.googleapis.com"!==s.host&&s.host!==t&&Qr("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:t,ssl:!1})),i.mockUserToken){let e,t;if("string"==typeof i.mockUserToken)e=i.mockUserToken,t=o.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var t=t||"demo-project",n=e.iat||0,r=e.sub||e.user_id;if(r)return r=Object.assign({iss:"https://securetoken.google.com/"+t,aud:t,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},e),[B(JSON.stringify({alg:"none",type:"JWT"})),B(JSON.stringify(r)),""].join(".");throw new Error("mockUserToken must contain 'sub' or 'user_id' field!")}(i.mockUserToken,null==(r=n._app)?void 0:r.options.projectId);const s=i.mockUserToken.sub||i.mockUserToken.user_id;if(!s)throw new _(w.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new o(s)}n._authCredentials=new Jr(new Yr(e,t))}}}enableNetwork(){return e=this._delegate,(n=Dd(e=P(e,U))).asyncQueue.enqueue(async()=>{var e=await ed(n),t=await nd(n);return e.setNetworkEnabled(!0),(e=t).y_.delete(0),Ul(e)});var e,n}disableNetwork(){return e=this._delegate,(n=Dd(e=P(e,U))).asyncQueue.enqueue(async()=>{var e=await ed(n),t=await nd(n);return e.setNetworkEnabled(!1),async function(){var e=t;e.y_.add(0),await Bl(e),e.b_.set("Offline")}()});var e,n}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,cd("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){var e=this._delegate;{var t=Dd(e=P(e,U));const n=new Wr;return t.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;Ql(n.remoteStore)||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();var r;-1===e?t.resolve():((r=n.ga.get(e)||[]).push(t),n.ga.set(e,r))}catch(e){const n=sc(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await rd(t),n)),n.promise}}onSnapshotsInSync(e){return Vf(this._delegate,e)}get app(){if(this._appCompat)return this._appCompat;throw new _("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available")}collection(e){try{return new cg(this,_d(this._delegate,e))}catch(e){throw rg(e,"collection()","Firestore.collection()")}}doc(e){try{return new ng(this,bd(this._delegate,e))}catch(e){throw rg(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new ug(this,function(e,t){if(e=P(e,yd),ld("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new vd(e,null,new _a(T.emptyPath(),t))}(this._delegate,e))}catch(e){throw rg(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){var n=this._delegate,r=e=>t(new Zf(this,e)),e=void 0;if(n=P(n,U),(e=Object.assign(Object.assign({},qf),e)).maxAttempts<1)throw new _(w.INVALID_ARGUMENT,"Max attempts must be at least 1");{var i=Dd(n),s=e=>r(new jf(n,e)),a=e;const o=new Wr;return i.asyncQueue.enqueueAndForget(async()=>{var e=await Zc(i).then(e=>e.datastore);new Qc(i.asyncQueue,e,a,s,o).run()}),o.promise}}batch(){return Dd(this._delegate),new eg(new Gf(this._delegate,e=>Uf(this._delegate,e)))}loadBundle(e){return n=Dd(t=P(this._delegate,U)),r=new xd,od(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return Nd(this._delegate,e).then(e=>e?new ug(this,e):null)}}class Jf extends xf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Hf(new Rd(e))}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return ng.forKey(e,this.firestore,null)}}class Zf{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Jf(e)}get(e){const t=dg(e);return this._delegate.get(t).then(e=>new ag(this._firestore,new Nf(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){e=dg(e);return n?(zf("Transaction.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=dg(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=dg(e);return this._delegate.delete(e),this}}class eg{constructor(e){this._delegate=e}set(e,t,n){e=dg(e);return n?(zf("WriteBatch.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=dg(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=dg(e);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}}class tg{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){e=new kf(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new og(this._firestore,e),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){var n=tg.INSTANCES;let r=n.get(e),i=(r||(r=new WeakMap,n.set(e,r)),r.get(t));return i||(i=new tg(e,new Jf(e),t),r.set(t,i)),i}}tg.INSTANCES=new WeakMap;class ng{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Jf(e)}static forPath(e,t,n){if(e.length%2!=0)throw new _("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new ng(t,new V(t._delegate,n,new S(e)))}static forKey(e,t,n){return new ng(t,new V(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new cg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new cg(this.firestore,_d(this._delegate,e))}catch(e){throw rg(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=v(e))instanceof V&&Id(this._delegate,e)}set(e,t){t=zf("DocumentReference.set",t);try{return t?Ff(this._delegate,e,t):Ff(this._delegate,e)}catch(e){throw rg(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Of(this._delegate,e):Of(this._delegate,e,t,...n)}catch(e){throw rg(e,"updateDoc()","DocumentReference.update()")}}delete(){return Uf(P((e=this._delegate).firestore,U),[new vo(e._key,F.none())]);var e}onSnapshot(...e){var t=ig(e),e=sg(e,e=>new ag(this.firestore,new Nf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Pf(this._delegate,t,e)}get(e){return("cache"===(null==e?void 0:e.source)?function(t){t=P(t,V);const n=P(t.firestore,U),e=Dd(n),r=new Lf(n);return function(e,t){const n=new Wr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{var r=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new _(w.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){r=sc(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await td(e),t,n)),n.promise}(e,t._key).then(e=>new Nf(n,r,t._key,e,new Af(null!==e&&e.hasLocalMutations,!0),t.converter))}:"server"===(null==e?void 0:e.source)?function(t){t=P(t,V);const n=P(t.firestore,U);return sd(Dd(n),t._key,{source:"server"}).then(e=>Bf(n,t,e))}:function(t){t=P(t,V);const n=P(t.firestore,U);return sd(Dd(n),t._key).then(e=>Bf(n,t,e))})(this._delegate).then(e=>new ag(this.firestore,new Nf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new ng(this.firestore,e?this._delegate.withConverter(tg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function rg(e,t,n){return e.message=e.message.replace(t,n),e}function ig(e){for(const t of e)if("object"==typeof t&&!Wf(t))return t;return{}}function sg(e,t){let n;return{next:e=>{n.next&&n.next(t(e))},error:null==(e=(n=Wf(e[0])?e[0]:Wf(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]}).error)?void 0:e.bind(n),complete:null==(e=n.complete)?void 0:e.bind(n)}}class ag{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new ng(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Mf(this._delegate,e._delegate)}}class og extends ag{data(e){e=this._delegate.data(e);return void 0===e&&b(),e}}class ug{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Jf(e)}where(e,t,n){try{return new ug(this.firestore,mf(this._delegate,(r=n,i=t,s=cf("where",e),pf._create(s,i,r))))}catch(e){throw rg(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,i,s}orderBy(e,t){try{return new ug(this.firestore,mf(this._delegate,([n,r="asc"]=[e,t],i=r,s=cf("orderBy",n),yf._create(s,i))))}catch(e){throw rg(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,i,s}limit(e){try{return new ug(this.firestore,mf(this._delegate,(md("limit",t=e),vf._create("limit",t,"F"))))}catch(e){throw rg(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new ug(this.firestore,mf(this._delegate,(md("limitToLast",t=e),vf._create("limitToLast",t,"L"))))}catch(e){throw rg(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new ug(this.firestore,mf(this._delegate,([...t]=[...e],wf._create("startAt",t,!0))))}catch(e){throw rg(e,"startAt()","Query.startAt()")}var t}startAfter(...e){try{return new ug(this.firestore,mf(this._delegate,([...t]=[...e],wf._create("startAfter",t,!1))))}catch(e){throw rg(e,"startAfter()","Query.startAfter()")}var t}endBefore(...e){try{return new ug(this.firestore,mf(this._delegate,([...t]=[...e],_f._create("endBefore",t,!1))))}catch(e){throw rg(e,"endBefore()","Query.endBefore()")}var t}endAt(...e){try{return new ug(this.firestore,mf(this._delegate,([...t]=[...e],_f._create("endAt",t,!0))))}catch(e){throw rg(e,"endAt()","Query.endAt()")}var t}isEqual(e){return Ed(this._delegate,e._delegate)}get(e){return("cache"===(null==e?void 0:e.source)?function(t){t=P(t,vd);const n=P(t.firestore,U),e=Dd(n),r=new Lf(n);return function(e,t){const n=new Wr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{var r=await ol(e,t,!0),i=new bc(t,r.ss),s=i.sa(r.documents),a=i.applyChanges(s,!1);n.resolve(a.snapshot)}catch(e){r=sc(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await td(e),t,n)),n.promise}(e,t._query).then(e=>new Rf(n,r,t,e))}:"server"===(null==e?void 0:e.source)?function(t){t=P(t,vd);const n=P(t.firestore,U),e=Dd(n),r=new Lf(n);return ad(e,t._query,{source:"server"}).then(e=>new Rf(n,r,t,e))}:function(t){t=P(t,vd);const n=P(t.firestore,U),e=Dd(n),r=new Lf(n);return df(t._query),ad(e,t._query).then(e=>new Rf(n,r,t,e))})(this._delegate).then(e=>new lg(this.firestore,new Rf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=ig(e),e=sg(e,e=>new lg(this.firestore,new Rf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Pf(this._delegate,t,e)}withConverter(e){return new ug(this.firestore,e?this._delegate.withConverter(tg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class hg{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new og(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class lg{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new ug(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new og(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new hg(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new og(this._firestore,e))})}isEqual(e){return Mf(this._delegate,e._delegate)}}class cg extends ug{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new ng(this.firestore,e):null}doc(e){try{return void 0===e?new ng(this.firestore,bd(this._delegate)):new ng(this.firestore,bd(this._delegate,e))}catch(e){throw rg(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=P(e.firestore,U),r=bd(e),i=Df(e.converter,t);return Uf(n,[Kd(Gd(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,F.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new ng(this.firestore,e))}isEqual(e){return Id(this._delegate,e._delegate)}withConverter(e){return new cg(this.firestore,e?this._delegate.withConverter(tg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function dg(e){return P(e,V)}var Ie={Firestore:Xf,GeoPoint:Fd,Timestamp:l,Blob:Hf,Transaction:Zf,WriteBatch:eg,DocumentReference:ng,DocumentSnapshot:ag,Query:ug,QueryDocumentSnapshot:og,QuerySnapshot:lg,CollectionReference:cg,FieldPath:class mg{constructor(...e){this._delegate=new Md(...e)}static documentId(){return new mg(f.keyField().canonicalString())}isEqual(e){return(e=v(e))instanceof Md&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class pg{constructor(e){this._delegate=e}static serverTimestamp(){var e=new $d("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new pg(e)}static delete(){var e=new jd("deleteField");return e._methodName="FieldValue.delete",new pg(e)}static arrayUnion(...e){[...e]=[...e];e=new Qd("arrayUnion",e);return e._methodName="FieldValue.arrayUnion",new pg(e)}static arrayRemove(...e){[...e]=[...e];e=new Hd("arrayRemove",e);return e._methodName="FieldValue.arrayRemove",new pg(e)}static increment(e){e=new Wd("increment",e);return e._methodName="FieldValue.increment",new pg(e)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){zr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1},fg=n.default,gg=(e,t)=>new Xf(e,t,new Yf);fg.INTERNAL.registerComponent(new H("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),e=e.getProvider("firestore").getImmediate();return gg(t,e)},"PUBLIC").setServiceProps(Object.assign({},Ie))),fg.registerVersion("@firebase/firestore-compat","0.3.14")}.apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});